<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WireShop — Archive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px; }
    .bar { display: flex; gap: 12px; align-items: center; margin: 12px 0 20px; flex-wrap: wrap; }
    input, button, select { padding: 8px 10px; font-size: 14px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
    th { background: #f3f3f3; text-align: left; }
    tbody tr:nth-child(even) { background: #fafafa; }
    .right { text-align: right; }
    .muted { color: #777; }
    .ok { color: #0a0; }
    .err { color: #b00; }
    .spacer { flex: 1; }
  </style>
</head>
<body>
  <h1>Archive</h1>

  <div class="bar">
    <strong>Status:</strong>
    <span id="status" class="muted">checking…</span>
    <button id="refreshBtn">Refresh</button>
    <span class="spacer"></span>
    <button id="exportBtn">Export JSON</button>
    <label>
      <input type="file" id="importFile" accept="application/json" style="display:none;" />
      <button id="importBtn" type="button">Import JSON</button>
    </label>
  </div>

  <form id="addForm" class="bar">
    <input id="part" placeholder="Part number" required />
    <input id="tech" placeholder="Technician" />
    <input id="loc" placeholder="Location" />
    <input id="mins" placeholder="Expected minutes" type="number" min="0" />
    <button>Add test entry</button>
    <span class="muted">Writes to POST /api/archive</span>
  </form>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Part</th>
        <th>Tech</th>
        <th>Location</th>
        <th>Status</th>
        <th class="right">Exp (min)</th>
        <th class="right">Total (sec)</th>
        <th>Started</th>
        <th>Finished</th>
        <th>Notes</th>
        <th>Created</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="rows"><tr><td colspan="12" class="muted">Loading…</td></tr></tbody>
  </table>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const fmt = (v) => v ?? "";
    const fmtTime = (v) => v ? new Date(v).toLocaleString() : "";

    async function ping() {
      try {
        const r = await fetch("/healthz");
        const j = await r.json();
        $("#status").textContent = j.archiveReady ? "archiveReady = true" : "archiveReady = false";
        $("#status").className = j.archiveReady ? "ok" : "err";
      } catch {
        $("#status").textContent = "healthz failed";
        $("#status").className = "err";
      }
    }

    async function load() {
      try {
        const res = await fetch("/api/archive?limit=5000");
        if (!res.ok) throw new Error("GET /api/archive failed");
        const data = await res.json();
        const tbody = $("#rows");
        if (!Array.isArray(data) || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="12" class="muted">No archived jobs yet.</td></tr>';
          return;
        }
        tbody.innerHTML = "";
        for (const r of data) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${fmt(r.id)}</td>
            <td>${fmt(r.part_number)}</td>
            <td>${fmt(r.technician)}</td>
            <td>${fmt(r.location)}</td>
            <td>${fmt(r.status)}</td>
            <td class="right">${fmt(r.expected_minutes)}</td>
            <td class="right">${fmt(r.total_active_sec)}</td>
            <td>${fmtTime(r.started_at)}</td>
            <td>${fmtTime(r.finished_at)}</td>
            <td>${fmt(r.notes)}</td>
            <td>${fmtTime(r.created_at)}</td>
            <td><button data-id="${r.id}" class="del">Delete</button></td>
          `;
          tbody.appendChild(tr);
        }
        tbody.querySelectorAll("button.del").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            const id = e.currentTarget.getAttribute("data-id");
            if (!confirm("Delete archive #" + id + "?")) return;
            const res = await fetch("/api/archive/" + id, { method: "DELETE" });
            if (res.ok) load();
          });
        });
      } catch (e) {
        $("#rows").innerHTML = `<tr><td colspan="12" class="err">${e.message}</td></tr>`;
      }
    }

    $("#addForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const job = {
        part_number: $("#part").value.trim(),
        technician: $("#tech").value.trim() || null,
        location: $("#loc").value.trim() || null,
        expected_minutes: $("#mins").value ? Number($("#mins").value) : null,
        status: "archived",
        notes: "test entry from archive.html"
      };
      if (!job.part_number) return;
      const res = await fetch("/api/archive", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(job)
      });
      if (res.ok) {
        $("#part").value = "";
        $("#tech").value = "";
        $("#loc").value = "";
        $("#mins").value = "";
        load();
      } else {
        alert("POST /api/archive failed");
      }
    });

    $("#refreshBtn").addEventListener("click", load);

    // Export all rows as JSON
    $("#exportBtn").addEventListener("click", async () => {
      try {
        const res = await fetch("/api/archive?limit=500000");
        if (!res.ok) throw new Error("GET /api/archive failed");
        const data = await res.json();
        const blob = new Blob([JSON.stringify({ exported_at: new Date().toISOString(), jobs: data }, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `wireshop-archive-${new Date().toISOString().replace(/[:.]/g,"-")}.json`;
        a.click();
        URL.revokeObjectURL(url);
      } catch (e) {
        alert("Export failed: " + e.message);
      }
    });

    // Import a JSON file produced by Export
    $("#importBtn").addEventListener("click", () => $("#importFile").click());
    $("#importFile").addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      try {
        const text = await file.text();
        const parsed = JSON.parse(text);
        const jobs = Array.isArray(parsed?.jobs) ? parsed.jobs : (Array.isArray(parsed) ? parsed : []);
        if (jobs.length === 0) return alert("No jobs found in file.");
        const res = await fetch("/api/archive/bulk", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ jobs })
        });
        if (!res.ok) throw new Error("Bulk import failed");
        load();
      } catch (err) {
        alert("Import failed: " + err.message);
      } finally {
        e.target.value = "";
      }
    });

    // boot
    ping();
    load();
  </script>
</body>
</html>
