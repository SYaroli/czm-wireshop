<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CZM • Archive Backup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="brand-bar">
    <div class="brand-inner">
      <a class="brand-logo" href="dashboard.html">
        <img src="czm-logo.png" alt="CZM" />
        <h1 class="brand-title">Archive Backup</h1>
      </a>
      <div class="brand-actions">
        <a class="secondary" href="admin.html">← Admin</a>
      </div>
    </div>
  </div>

  <main class="container">
    <div class="card">
      <div style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap">
        <strong>Status:</strong>
        <span id="status" class="muted">checking…</span>
        <button id="refresh" class="secondary">Refresh</button>
        <div class="spacer"></div>
        <button id="exportBtn" class="secondary">Export JSON</button>
        <label>
          <input type="file" id="importFile" accept="application/json" style="display:none;" />
          <button id="importBtn" class="secondary" type="button">Import JSON</button>
        </label>
      </div>

      <div class="toolbar" style="display:flex;gap:.75rem;flex-wrap:wrap;align-items:end;margin:12px 0">
        <div><label>Part number<br/><input id="fltPart" type="text" placeholder="Part number"/></label></div>
        <div><label>Technician<br/><input id="fltTech" type="text" placeholder="Technician"/></label></div>
        <div><label>Location<br/><input id="fltLoc" type="text" placeholder="Location"/></label></div>
        <div><label>Expected minutes<br/><input id="fltMins" type="number" min="0" placeholder="e.g. 8 or 480"/></label></div>
        <button id="apply" class="primary">Apply</button>
        <button id="reset" class="secondary">Reset</button>
        <div class="spacer"></div>
        <div class="muted"><span id="rowCount">0</span> records</div>
      </div>

      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Finished</th>
              <th>Technician</th>
              <th>Part Number</th>
              <th>Print Name</th>
              <th>Expected</th>
              <th>Notes</th>
              <th>Total Active</th>
              <th>Adjust</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </main>

  <dialog id="adjDialog" style="max-width:720px;width:clamp(320px,90vw,720px);border:none;border-radius:12px;padding:16px;">
    <form method="dialog" id="adjForm">
      <h3 style="margin:0 0 8px 0;">Adjust Completed Job</h3>
      <div id="adjMeta" style="font-size:.9rem;opacity:.7;margin-bottom:8px;"></div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <label>Technician <input id="adjUser" type="text"/></label>
        <label>Part Number <input id="adjPart" type="text"/></label>
        <label style="grid-column:1 / -1">Notes <textarea id="adjNote" rows="2"></textarea></label>
        <label>Start Time <input id="adjStart" type="datetime-local"/></label>
        <label>End Time <input id="adjEnd" type="datetime-local"/></label>
        <label>Pause Total (minutes) <input id="adjPause" type="number" min="0" step="1" placeholder="leave blank to keep"/></label>
        <label style="grid-column:1 / -1">Reason (required) <input id="adjReason" type="text" required placeholder="e.g. missed punch"/></label>
      </div>

      <div id="adjHistory" style="margin-top:8px;padding:8px;background:#f6f6f6;border-radius:8px;display:none;"></div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
        <button type="button" id="adjCancel" class="secondary">Cancel</button>
        <button type="submit" id="adjSave" class="primary">Save Adjustment</button>
      </div>
    </form>
  </dialog>

  <script src="catalog.js"></script>
  <script>
    const API_BASE = "https://wireshop-backend.onrender.com";

    const $ = (s) => document.querySelector(s);
    const rowsEl = $("#rows");
    const statusEl = $("#status");
    const countEl = $("#rowCount");

    const filters = {
      part: $("#fltPart"),
      tech: $("#fltTech"),
      loc: $("#fltLoc"),
      mins: $("#fltMins"),
    };

    const state = { all: [], view: [], current: null };

    const catByPart = new Map((window.catalog || []).map(p => [String(p.partNumber), p]));

    const zpad = (n, w=2) => String(n).padStart(w, "0");
    const fmtHM = (mins) => {
      if (mins == null || mins === "") return "";
      const m = Number(mins);
      const h = Math.floor(m / 60);
      const mm = m % 60;
      return `${h}:${zpad(mm)}`;
    };
    const fmtHMS = (sec) => {
      if (sec == null) return "00:00:00";
      let s = Math.max(0, Number(sec));
      const h = Math.floor(s / 3600); s -= h*3600;
      const m = Math.floor(s / 60);  s -= m*60;
      return `${zpad(h)}:${zpad(m)}:${zpad(s)}`;
    };
    const toLocal = (t) => t ? new Date(t).toLocaleString() : "";

    async function ping() {
      try {
        const r = await fetch(`${API_BASE}/healthz`);
        const j = await r.json();
        statusEl.textContent = j.archiveReady ? "archiveReady = true" : "archiveReady = false";
        statusEl.className = j.archiveReady ? "ok" : "err";
      } catch {
        statusEl.textContent = "healthz failed";
        statusEl.className = "err";
      }
    }

    // NOTE: use the stable archive API, not the legacy /api/jobs alias.
    async function load() {
      const r = await fetch(`${API_BASE}/api/archive?limit=5000`);
      if (!r.ok) { rowsEl.innerHTML = `<tr><td colspan="9" class="muted">GET /api/archive failed</td></tr>`; return; }
      const data = await r.json();

      state.all = (Array.isArray(data) ? data : data.jobs || []).map(x => ({
        id: x.id,
        finishedAt: x.finished ?? x.finished_at ?? x.endTime ?? null,
        username:  x.technician ?? x.username ?? "",
        partNumber: x.part_number ?? x.partNumber ?? "",
        expectedMin: (() => {
          const cat = catByPart.get(String(x.part_number || x.partNumber || ""));
          if (cat && typeof cat.expectedHours === "number") return Math.round(cat.expectedHours*60);
          if (x.expected_minutes != null) return Number(x.expected_minutes);
          if (x.expected != null) return Number(x.expected);
          return null;
        })(),
        printName: (() => {
          const cat = catByPart.get(String(x.part_number || x.partNumber || ""));
          return cat?.printName ?? x.printName ?? "";
        })(),
        note: x.notes ?? x.note ?? "",
        totalActiveSec: (() => {
          if (x.total_active_sec != null) return Number(x.total_active_sec);
          if (x.totalActive != null) return Number(x.totalActive);
          if (x.startTime && x.endTime) {
            const pause = Number(x.pauseTotal || 0);
            return Math.max(0, Math.round((x.endTime - x.startTime - pause)/1000));
          }
          return null;
        })(),
        startTime: x.started_at ?? x.startTime ?? null,
        endTime: x.finished_at ?? x.endTime ?? null
      }));

      apply();
    }

    function apply() {
      const p = (filters.part.value || "").toLowerCase();
      const t = (filters.tech.value || "").toLowerCase();
      const l = (filters.loc.value || "").toLowerCase();
      const m = filters.mins.value ? Number(filters.mins.value) : null;

      state.view = state.all.filter(r => {
        if (p && !String(r.partNumber).toLowerCase().includes(p)) return false;
        if (t && !String(r.username).toLowerCase().includes(t)) return false;
        if (l && !(r.location ? String(r.location).toLowerCase().includes(l) : false)) return false;
        if (m != null && r.expectedMin != null && r.expectedMin !== m && Math.abs(r.expectedMin - m) > 0.5) return false;
        return true;
      });

      render();
    }

    function render() {
      rowsEl.innerHTML = "";
      if (countEl) countEl.textContent = state.view.length;

      if (state.view.length === 0) {
        rowsEl.innerHTML = `<tr><td colspan="9" class="muted">No archived jobs yet.</td></tr>`;
        return;
      }

      for (const r of state.view) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${toLocal(r.finishedAt)}</td>
          <td>${r.username}</td>
          <td>${r.partNumber}</td>
          <td>${r.printName || ""}</td>
          <td>${fmtHM(r.expectedMin)}</td>
          <td>${r.note || ""}</td>
          <td>${fmtHMS(r.totalActiveSec)}</td>
          <td><button class="secondary small" data-adj="${r.id}">Adjust</button></td>
          <td><button class="danger small" data-del="${r.id}">Delete</button></td>
        `;
        rowsEl.appendChild(tr);
      }

      rowsEl.querySelectorAll("button[data-adj]").forEach(b => b.addEventListener("click", () => openAdjust(Number(b.dataset.adj))));
      rowsEl.querySelectorAll("button[data-del]").forEach(b => b.addEventListener("click", () => doDelete(Number(b.dataset.del))));
    }

    // Adjust dialog helpers
    const dlg = $("#adjDialog");
    const adj = {
      meta: $("#adjMeta"), form: $("#adjForm"),
      user: $("#adjUser"), part: $("#adjPart"), note: $("#adjNote"),
      start: $("#adjStart"), end: $("#adjEnd"), pause: $("#adjPause"),
      reason: $("#adjReason"), cancel: $("#adjCancel")
    };

    const toLocalDT = (ms)=>{ if(!ms)return""; const d=new Date(ms),pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; };

    function openAdjust(id) {
      const r = state.view.find(x => x.id === id); if (!r) return;
      state.current = r;
      adj.meta.textContent = `Archive #${r.id} • Finished ${toLocal(r.finishedAt)}`;
      adj.user.value = r.username || "";
      adj.part.value = r.partNumber || "";
      adj.note.value = r.note || "";
      adj.start.value = toLocalDT(r.startTime);
      adj.end.value = toLocalDT(r.endTime);
      adj.pause.value = "";
      adj.reason.value = "";
      dlg.showModal();
    }

    adj.cancel.addEventListener("click", () => dlg.close());
    adj.form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const r = state.current; if (!r) return;

      const toMs = v => v ? new Date(v).getTime() : null;
      const payload = {};
      if (adj.user.value !== r.username) payload.username = adj.user.value;
      if (adj.part.value !== r.partNumber) payload.partNumber = adj.part.value;
      if (adj.note.value !== (r.note || "")) payload.note = adj.note.value;
      const sMs = toMs(adj.start.value), eMs = toMs(adj.end.value);
      if (sMs && sMs !== r.startTime) payload.startTime = sMs;
      if (eMs && eMs !== r.endTime)   payload.endTime   = eMs;
      if (adj.pause.value !== "") payload.pauseTotal = Number(adj.pause.value) * 60000;
      payload.reason = adj.reason.value.trim();
      if (!payload.reason) { adj.reason.focus(); return; }

      const res = await fetch(`${API_BASE}/api/archive/${r.id}/adjust`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) { alert("Adjustment failed"); return; }
      dlg.close();
      await load();
    });

    async function doDelete(id) {
      const reason = prompt("Delete reason (required):");
      if (!reason) return;
      const res = await fetch(`${API_BASE}/api/archive/${id}/delete`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ reason })
      });
      if (!res.ok) { alert("Delete failed"); return; }
      await load();
    }

    // Export / Import
    $("#exportBtn").addEventListener("click", async () => {
      const res = await fetch(`${API_BASE}/api/archive?limit=500000`);
      if (!res.ok) return alert("Export failed");
      const data = await res.json();
      const blob = new Blob([JSON.stringify({ exported_at: new Date().toISOString(), jobs: data }, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `wireshop-archive-${new Date().toISOString().replace(/[:.]/g,"-")}.json`;
      a.click(); URL.revokeObjectURL(url);
    });

    $("#importBtn").addEventListener("click", () => $("#importFile").click());
    $("#importFile").addEventListener("change", async (e) => {
      const file = e.target.files?.[0]; if (!file) return;
      try {
        const text = await file.text();
        const parsed = JSON.parse(text);
        const jobs = Array.isArray(parsed?.jobs) ? parsed.jobs : (Array.isArray(parsed) ? parsed : []);
        if (jobs.length === 0) return alert("No jobs found in file.");
        const res = await fetch(`${API_BASE}/api/archive/bulk`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ jobs })
        });
        if (!res.ok) throw new Error("Bulk import failed");
        await load();
      } catch (err) {
        alert("Import failed: " + err.message);
      } finally {
        e.target.value = "";
      }
    });

    // Filters
    $("#apply").addEventListener("click", apply);
    $("#reset").addEventListener("click", () => {
      filters.part.value = ""; filters.tech.value = ""; filters.loc.value = ""; filters.mins.value = "";
      apply();
    });
    $("#refresh").addEventListener("click", load);

    // boot
    ping();
    load();
  </script>
</body>
</html>
