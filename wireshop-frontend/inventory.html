<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CZM • Inventory</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    .brand-bar{background:#0f1114;border-bottom:4px solid #c30000}
    .brand-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:8px 12px}
    .brand-logo{display:flex;align-items:center;gap:10px;color:#fff;text-decoration:none}
    .brand-logo img{height:22px;opacity:.95}
    .brand-title{font-size:16px;margin:0;color:#fff}
    .brand-actions .navbtn{display:inline-block;background:#1a1c20;color:#bbb;padding:6px 12px;border-radius:10px;text-decoration:none;border:1px solid #3a3f44;font-weight:600;font-size:.9rem;margin-left:8px}
    .brand-actions .navbtn.active{background:#b30000;color:#fff;border-color:#ff4d4d}
    .brand-actions .navbtn:hover{background:#24272b;color:#fff}

    body{background:#eef0f3;margin:0}

    .inventory-shell{max-width:1200px;margin:24px auto;background:#fff;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,.08);padding:0 0 12px}
    .inventory-header{padding:14px 16px 6px}
    .inventory-header h2{margin:0 0 6px;font-size:16px;font-weight:600}

    .filter-row{display:flex;flex-wrap:wrap;align-items:center;gap:10px}
    .filter-row input[type="text"]{flex:1;min-width:260px;height:32px;border:1px solid #cfd4da;border-radius:6px;padding:0 10px}
    .cb{display:flex;align-items:center;gap:8px;height:32px;padding:0 10px;border:1px solid #cfd4da;border-radius:6px;background:#f7f8fa;user-select:none}
    .cb input{margin:0;width:16px;height:16px}
    .toolbar-btn{background:#eee;border:1px solid #cfd4da;border-radius:6px;height:32px;padding:0 12px;font-size:13px;cursor:pointer}
    .toolbar-btn.red{background:#c30000;color:#fff;border-color:#a00000}
    #countLabel{font-size:12px;margin-left:auto;white-space:nowrap}

    /* Added Min Qty column */
    .table-head{background:#0a0b0d;color:#fff;display:grid;grid-template-columns:150px 220px 100px 60px 70px 280px 1fr;gap:0;padding:8px 16px;font-size:12px;font-weight:600;margin-top:12px}
    .list-body .row{display:grid;grid-template-columns:150px 220px 100px 60px 70px 280px 1fr;gap:0;padding:10px 16px;border-bottom:1px solid #eef2f6;background:#fff;align-items:center}
    .list-body .row:nth-child(odd){background:#fafbfc}
    .notes-cell{font-size:12px;color:#333;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .adjust-controls{display:flex;align-items:center;gap:10px;flex-wrap:nowrap}
    .qty-input{width:76px;border:1px solid #d0d3d8;border-radius:20px;height:30px;padding:0 8px;text-align:center}
    .apply-btn{background:#b70000;color:#fff;border:none;border-radius:6px;height:32px;min-width:64px;padding:0 10px;cursor:pointer}
    .edit-btn{background:#3a3a3a;color:#fff;border:none;border-radius:6px;height:32px;min-width:64px;padding:0 10px;cursor:pointer}
    .muted{color:#9aa3ad;font-size:12px}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:#122032;color:#fff;padding:16px;width:420px;border-radius:8px;box-shadow:0 8px 20px rgba(0,0,0,.4)}
    .modal h3{margin:0 0 10px;font-size:18px}
    .modal label{display:block;font-size:12px;margin-top:8px;margin-bottom:4px}
    .modal input,.modal textarea{width:100%;border:none;border-radius:6px;height:34px;padding:6px 8px;outline:none;font-size:14px;color:#000}
    .modal textarea{height:90px;resize:vertical}
    .modal-actions{margin-top:14px;display:flex;gap:10px;justify-content:flex-end}
    .btn-small{border:none;border-radius:6px;padding:6px 14px;cursor:pointer}
    .btn-red{background:#c30000;color:#fff}
    .btn-gray{background:#c5c5c5;color:#000}

    @media (max-width:900px){
      .inventory-shell{max-width:100%;margin:0;border-radius:0;box-shadow:none}
      .table-head,.list-body .row{grid-template-columns:140px 1fr 90px 55px 55px 240px}
      .notes-cell{grid-column:1 / -1;margin-top:4px}
    }
  </style>
</head>
<body>
  <div class="brand-bar">
    <div class="brand-inner">
      <a class="brand-logo" href="/dashboard.html">
        <img src="/czm-logo.png" alt="CZM">
        <h1 class="brand-title">CZM • Inventory</h1>
      </a>
      <div class="brand-actions">
        <a class="navbtn" href="/dashboard.html">Dashboard</a>
        <a class="navbtn" href="/assignments.html">Build Next</a>
        <a class="navbtn active" href="/inventory">Inventory</a>
        <a class="navbtn" href="/archive.html">Archive</a>
        <a id="adminNavBtn" class="navbtn" href="/admin.html">Admin</a>
        <button id="logoutBtn" class="navbtn">Logout</button>
      </div>
    </div>
  </div>

  <div class="inventory-shell">
    <div class="inventory-header">
      <h2>Inventory — Snapshot</h2>
      <div class="filter-row">
        <input id="filterBox" type="text" placeholder="part number, print name, or location" />
        <label class="cb"><input id="cbNonZero" type="checkbox"><span>only non-zero</span></label>
        <label class="cb"><input id="cbOnlyZero" type="checkbox"><span>only 0-qty</span></label>
        <button id="exportBtn" class="toolbar-btn">Export</button>
        <button id="addBtn" class="toolbar-btn red">Add part</button>
        <span id="countLabel">0 items</span>
      </div>
    </div>

    <div class="table-head">
      <div>Part Number</div><div>Print Name</div><div>Location</div><div>Qty</div><div>Min</div><div>Adjust</div><div>Notes</div>
    </div>
    <div id="listBody" class="list-body"></div>
  </div>

  <div id="editModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <h3 id="modalTitle">Edit Part</h3>
      <label for="mPart">Part Number</label><input id="mPart" readonly />
      <label for="mDesc">Description</label><input id="mDesc" />
      <label for="mLoc">Location</label><input id="mLoc" />
      <label for="mQty">Qty</label><input id="mQty" type="number" />
      <label for="mMinQty">Min Qty</label><input id="mMinQty" type="number" />
      <label for="mNotes">Notes</label><textarea id="mNotes"></textarea>
      <div class="modal-actions">
        <button id="saveBtn" class="btn-small btn-red">Save</button>
        <button id="cancelBtn" class="btn-small btn-gray">Cancel</button>
        <button id="deleteBtn" class="btn-small btn-gray" style="margin-left:auto;">Delete</button>
      </div>
    </div>
  </div>

  <script src="/catalog.js"></script>
  <script>
    const API_BASE = (localStorage.getItem("API_BASE") || "https://wireshop-backend.onrender.com").replace(/\/+$/, "") + "/api";

    function getUser(){
      try { return JSON.parse(localStorage.getItem('user') || 'null'); }
      catch { return null; }
    }
    function getUsername(u){
      return String(u?.username || u?.name || u?.user || '').trim();
    }
    function isAdminUser(u){
      return String(u?.role || '').toLowerCase() === 'admin';
    }

    const currentUser = getUser();
    if (!currentUser || !getUsername(currentUser)) window.location.href = '/index.html';

    const adminNavBtn = document.getElementById('adminNavBtn');
    const addBtn = document.getElementById('addBtn');
    const isAdmin = isAdminUser(currentUser);

    if (!isAdmin && adminNavBtn) adminNavBtn.style.display = 'none';
    if (addBtn) addBtn.style.display = isAdmin ? 'inline-block' : 'none';

    document.getElementById('logoutBtn')?.addEventListener('click', ()=>{
      localStorage.removeItem('user');
      location.href = '/index.html';
    });

    const listBody = document.getElementById('listBody');
    const filterBox = document.getElementById('filterBox');
    const countLabel = document.getElementById('countLabel');
    const cbNonZero = document.getElementById('cbNonZero');
    const cbOnlyZero = document.getElementById('cbOnlyZero');
    const editModalBackdrop = document.getElementById('editModalBackdrop');

    let ALL_ROWS = [];
    let modalMode = 'edit';

    async function loadData(){
      const uname = getUsername(currentUser);
      const invRes = await fetch(API_BASE + '/inventory-all', { headers: { 'x-user': uname } });
      const invData = await invRes.json();

      const DB_ROWS = {};
      (invData || []).forEach(r => DB_ROWS[r.partNumber] = r);

      const cat = Array.isArray(window.catalog) ? window.catalog : [];
      const merged = [];

      cat.forEach(c=>{
        const db = DB_ROWS[c.partNumber];
        if(db){
          merged.push({
            partNumber: db.partNumber,
            printName: db.description ?? c.printName ?? '',
            location: db.location ?? (c.location||''),
            qty: typeof db.qty === 'number' ? db.qty : 0,
            minQty: typeof db.minQty === 'number' ? db.minQty : 0,
            notes: db.notes ?? (c.notes||'')
          });
        } else {
          merged.push({
            partNumber: c.partNumber,
            printName: c.printName||'',
            location: c.location||'',
            qty: 0,
            minQty: 0,
            notes: c.notes||''
          });
        }
      });

      (invData || []).forEach(db=>{
        if(!cat.find(c=>c.partNumber===db.partNumber)){
          merged.push({
            partNumber: db.partNumber,
            printName: db.description ?? '',
            location: db.location ?? '',
            qty: typeof db.qty === 'number' ? db.qty : 0,
            minQty: typeof db.minQty === 'number' ? db.minQty : 0,
            notes: db.notes ?? ''
          });
        }
      });

      merged.sort((a,b)=>(a.partNumber||'').localeCompare(b.partNumber||''));
      ALL_ROWS = merged;
      renderList();
    }

    function renderList(){
      const filter = filterBox.value.trim().toLowerCase();
      const onlyNZ = cbNonZero.checked;
      const onlyZ = cbOnlyZero.checked;

      listBody.innerHTML=''; let shown=0;
      ALL_ROWS.forEach(row=>{
        if(filter){
          const hay = (row.partNumber+' '+(row.printName||'')+' '+(row.location||'')).toLowerCase();
          if(!hay.includes(filter)) return;
        }
        if(onlyNZ && (!row.qty || row.qty===0)) return;
        if(onlyZ && (row.qty && row.qty!==0)) return;

        const div = document.createElement('div'); div.className='row';

        const partA = document.createElement('a');
        partA.href = '/inv/'+encodeURIComponent(row.partNumber);
        partA.textContent = row.partNumber;
        partA.style.color='#003574'; partA.style.fontSize='12px';

        const nameDiv = document.createElement('div'); nameDiv.textContent=row.printName||''; nameDiv.style.fontSize='12px';
        const locDiv = document.createElement('div'); locDiv.textContent=row.location||''; locDiv.style.fontSize='12px';
        const qtyDiv = document.createElement('div'); qtyDiv.textContent = row.qty!=null?row.qty:0; qtyDiv.style.fontSize='12px';

        const minDiv = document.createElement('div');
        minDiv.textContent = (row.minQty!=null ? row.minQty : 0);
        minDiv.style.fontSize='12px';

        const adjustDiv = document.createElement('div'); adjustDiv.className='adjust-controls';
        if (isAdmin){
          const adjustInput = document.createElement('input'); adjustInput.type='text'; adjustInput.className='qty-input'; adjustInput.placeholder='+/-';
          const applyBtn = document.createElement('button'); applyBtn.className='apply-btn'; applyBtn.textContent='Apply';
          applyBtn.onclick = ()=>applyAdjust(row.partNumber,row.qty,adjustInput.value);
          const editBtn = document.createElement('button'); editBtn.className='edit-btn'; editBtn.textContent='Edit';
          editBtn.onclick = ()=>openEdit(row);
          adjustDiv.append(adjustInput,applyBtn,editBtn);
        } else {
          adjustDiv.innerHTML = '<span class="muted">—</span>';
        }

        const notesDiv = document.createElement('div'); notesDiv.className='notes-cell'; notesDiv.textContent=row.notes||'';

        div.append(partA,nameDiv,locDiv,qtyDiv,minDiv,adjustDiv,notesDiv);
        listBody.appendChild(div); shown++;
      });
      countLabel.textContent = shown+' items';
    }

    async function applyAdjust(partNumber,currentQty,deltaStr){
      if(!isAdmin) return;
      const delta = Number(deltaStr); if(isNaN(delta)){alert('enter a number');return;}
      const newQty=(Number(currentQty)||0)+delta;

      const uname = getUsername(currentUser);
      const res=await fetch(API_BASE+'/inventory/'+encodeURIComponent(partNumber)+'/qty',{
        method:'POST',
        headers:{'Content-Type':'application/json','x-user': uname},
        body:JSON.stringify({qty:newQty})
      });
      const data=await res.json();
      if(!res.ok){alert(data.error||'failed to adjust');return;}
      const row=ALL_ROWS.find(r=>r.partNumber===partNumber);
      if(row) row.qty=newQty;
      renderList();
    }

    function openEdit(row,isNew=false){
      if(!isAdmin) return;
      modalMode = isNew?'add':'edit';
      const editingPart = row ? {...row} : {partNumber:'',printName:'',location:'',qty:0,minQty:0,notes:''};

      document.getElementById('modalTitle').textContent = isNew?'Add Part':'Edit Part';
      document.getElementById('mPart').readOnly = !isNew;
      document.getElementById('mPart').value = editingPart.partNumber||'';
      document.getElementById('mDesc').value = editingPart.printName||'';
      document.getElementById('mLoc').value = editingPart.location||'';
      document.getElementById('mQty').value = editingPart.qty!=null?editingPart.qty:0;
      document.getElementById('mMinQty').value = editingPart.minQty!=null?editingPart.minQty:0;
      document.getElementById('mNotes').value = editingPart.notes||'';
      editModalBackdrop.style.display='flex';
      document.getElementById('deleteBtn').style.display = isNew?'none':'inline-block';
    }

    async function saveModal(){
      if(!isAdmin) return;
      const part=document.getElementById('mPart').value.trim();
      const desc=document.getElementById('mDesc').value;
      const loc=document.getElementById('mLoc').value;
      const qty=Number(document.getElementById('mQty').value||0);
      const minQty=Number(document.getElementById('mMinQty').value||0);
      const notes=document.getElementById('mNotes').value;
      if(!part){alert('part number required');return;}

      const payload={partNumber:part,description:desc,location:loc,qty,minQty,notes};
      const uname = getUsername(currentUser);
      const hdrs={'Content-Type':'application/json','x-user': uname};

      if(modalMode==='add'){
        const res=await fetch(API_BASE+'/inventory',{method:'POST',headers:hdrs,body:JSON.stringify(payload)});
        const data=await res.json(); if(!res.ok){alert(data.error||'failed to add');return;}
      }else{
        const res=await fetch(API_BASE+'/inventory/'+encodeURIComponent(part),{method:'PUT',headers:hdrs,body:JSON.stringify(payload)});
        const data=await res.json(); if(!res.ok){alert(data.error||'failed to save');return;}
      }
      editModalBackdrop.style.display='none';
      await loadData();
    }

    async function deleteModal(){
      if(!isAdmin) return;
      const part=document.getElementById('mPart').value.trim(); if(!part) return;
      if(!confirm('Delete '+part+'?')) return;

      const uname = getUsername(currentUser);
      const res=await fetch(API_BASE+'/inventory/'+encodeURIComponent(part),{
        method:'DELETE',
        headers:{'x-user': uname}
      });
      const data=await res.json(); if(!res.ok){alert(data.error||'failed to delete');return;}
      editModalBackdrop.style.display='none';
      await loadData();
    }

    document.getElementById('exportBtn').addEventListener('click',()=>{
      let csv='partNumber,description,location,qty,minQty,notes\n';
      ALL_ROWS.forEach(r=>{
        csv+=`"${r.partNumber}","${(r.printName||'').replace(/"/g,'""')}","${(r.location||'').replace(/"/g,'""')}",${r.qty||0},${r.minQty||0},"${(r.notes||'').replace(/"/g,'""')}"\n`;
      });
      const blob=new Blob([csv],{type:'text/csv'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='inventory.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('addBtn').addEventListener('click',()=>openEdit(null,true));
    document.getElementById('cancelBtn').addEventListener('click',()=>editModalBackdrop.style.display='none');
    document.getElementById('saveBtn').addEventListener('click',saveModal);
    document.getElementById('deleteBtn').addEventListener('click',deleteModal);

    filterBox.addEventListener('input',renderList);
    cbNonZero.addEventListener('change',renderList);
    cbOnlyZero.addEventListener('change',renderList);

    loadData();
  </script>
</body>
</html>
