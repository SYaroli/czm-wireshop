<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CZM • Inventory</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    /* keep it minimal, reuse your styles; match Apply button */
    .btn { padding: 6px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; }
    .btn-apply { background:#b30000; color:#fff; border:none; }
    .btn-edit  { background:#b30000; color:#fff; border:none; } /* same look as Apply */
    .btn-muted { background:#333; color:#fff; border:none; }
    .btn-danger{ background:#7a0000; color:#fff; border:none; }
    .toolbar   { display:flex; gap:10px; align-items:center; }
    .hidden { display:none !important; }
    dialog.modal { width: 600px; max-width: 95vw; border:none; border-radius:10px; padding:0; }
    .modal-head { padding:14px 16px; background:#131313; color:#fff; border-bottom:1px solid #222; }
    .modal-body { padding:16px; background:#0e0e0e; color:#ddd; }
    .modal-foot { padding:12px 16px; background:#0e0e0e; display:flex; gap:8px; justify-content:flex-end; border-top:1px solid #222; }
    .grid { display:grid; grid-template-columns: 160px 1fr; gap:10px 12px; align-items:center; }
    input, textarea, select { background:#151515; color:#eee; border:1px solid #333; padding:8px; border-radius:8px; width:100%; }
    table.inv { width:100%; border-collapse:collapse; }
    table.inv th, table.inv td { padding:10px; border-bottom:1px solid #252525; }
    a.partlink { color:#7db3ff; text-decoration:none; }
  </style>
</head>
<body>
  <header class="topbar">
    <nav class="navbar">
      <a href="/dashboard" class="navbtn">Dashboard</a>
      <a href="/assignments" class="navbtn">Assignments</a>
      <a href="/inventory" class="navbtn active">Inventory</a>
      <a href="/archive" class="navbtn">Archive</a>
      <a href="/admin" class="navbtn">Admin</a>
      <button id="logoutBtn" class="navbtn">Logout</button>
    </nav>
  </header>

  <main class="container">
    <h2>Inventory — Snapshot</h2>

    <div class="toolbar">
      <input id="filter" type="text" placeholder="part number, print name, or location" />
      <select id="qtyFilter">
        <option value="nonzero">only non-zero</option>
        <option value="all">all items</option>
      </select>
      <button id="addPartBtn" class="btn btn-edit hidden">+ Add New Part</button>
      <span id="countBadge" style="margin-left:auto; opacity:.7;"></span>
    </div>

    <div id="tableWrap" style="margin-top:14px;">
      <table class="inv" id="invTable">
        <thead>
          <tr>
            <th>Part Number</th>
            <th>Print Name</th>
            <th>Location</th>
            <th>Min</th>
            <th>Qty</th>
            <th>Adjust</th>
            <th></th>
            <th class="adminCol hidden"></th>
            <th>Updated</th>
            <th>By</th>
          </tr>
        </thead>
        <tbody id="invBody"></tbody>
      </table>
    </div>
  </main>

  <!-- Edit/Create Modal -->
  <dialog id="partModal" class="modal">
    <form method="dialog">
      <div class="modal-head">
        <h3 id="modalTitle">Edit Part</h3>
      </div>
      <div class="modal-body">
        <div class="grid">
          <label>Part Number</label>
          <input id="f_partNumber" required />
          <label>Print Name</label>
          <input id="f_printName" />
          <label>Location</label>
          <input id="f_location" />
          <label>Min</label>
          <input id="f_min" type="number" step="1" />
          <label>Qty</label>
          <input id="f_qty" type="number" step="1" />
          <label>Notes</label>
          <textarea id="f_notes" rows="3"></textarea>
          <label>Expected Hours</label>
          <input id="f_expectedHours" type="number" step="0.1" />
        </div>
      </div>
      <div class="modal-foot">
        <button type="button" id="deleteBtn" class="btn btn-danger">Delete</button>
        <button type="submit" id="saveBtn" class="btn btn-edit">Save</button>
        <button type="button" id="cancelBtn" class="btn btn-muted">Cancel</button>
      </div>
    </form>
  </dialog>

  <script>
    // Basic session role check. If your app exposes /api/auth/me use that.
    let currentUser = null;
    async function getMe() {
      try {
        const r = await fetch('/api/auth/me', { credentials: 'include' });
        if (r.ok) return await r.json();
      } catch {}
      // Fallback if your JWT payload is already stashed
      try {
        const raw = localStorage.getItem('czm_user');
        if (raw) return JSON.parse(raw);
      } catch {}
      return null;
    }

    // Inventory data cache
    let INV = [];
    let isAdmin = false;

    const invBody = document.getElementById('invBody');
    const countBadge = document.getElementById('countBadge');
    const filterInput = document.getElementById('filter');
    const qtyFilter = document.getElementById('qtyFilter');
    const addPartBtn = document.getElementById('addPartBtn');

    const partModal = document.getElementById('partModal');
    const modalTitle = document.getElementById('modalTitle');
    const f_partNumber = document.getElementById('f_partNumber');
    const f_printName = document.getElementById('f_printName');
    const f_location = document.getElementById('f_location');
    const f_min = document.getElementById('f_min');
    const f_qty = document.getElementById('f_qty');
    const f_notes = document.getElementById('f_notes');
    const f_expectedHours = document.getElementById('f_expectedHours');
    const deleteBtn = document.getElementById('deleteBtn');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    let editingExisting = false;
    let originalPartNumber = null;

    function showAdminControls(show) {
      isAdmin = !!show;
      document.querySelectorAll('.adminCol').forEach(td => td.classList.toggle('hidden', !show));
      addPartBtn.classList.toggle('hidden', !show);
      document.querySelectorAll('.btn-edit').forEach(btn => {
        // row edit buttons carry data-admin-ok class so we don't hide the Add button
        if (btn.classList.contains('rowedit')) btn.classList.toggle('hidden', !show);
      });
    }

    function rowTemplate(item) {
      const pn = item.partNumber;
      const applyBtn = `<button class="btn btn-apply" data-act="apply" data-pn="${pn}">Apply</button>`;
      const editBtn  = `<button class="btn btn-edit rowedit ${isAdmin ? '' : 'hidden'}" data-act="edit" data-pn="${pn}">Edit</button>`;
      const adjustCtrls = `
        <div style="display:flex; gap:6px; align-items:center;">
          <button class="btn btn-muted" data-act="dec" data-pn="${pn}">-</button>
          <input type="number" step="1" value="0" data-field="delta" data-pn="${pn}" style="width:64px; text-align:center;" />
          <button class="btn btn-muted" data-act="inc" data-pn="${pn}">+</button>
        </div>`;
      return `
        <tr>
          <td><a class="partlink" href="/inventory?pn=${encodeURIComponent(pn)}">${pn}</a></td>
          <td>${escapeHtml(item.printName || '')}</td>
          <td>${escapeHtml(item.location || '')}</td>
          <td>${item.min ?? 0}</td>
          <td>${item.qty ?? 0}</td>
          <td>${adjustCtrls}</td>
          <td>${applyBtn}</td>
          <td class="adminCol ${isAdmin ? '' : 'hidden'}">${editBtn}</td>
          <td>${item.updatedAt ? new Date(item.updatedAt).toLocaleString() : ''}</td>
          <td>${escapeHtml(item.updatedBy || '')}</td>
        </tr>
      `;
    }

    function render() {
      const q = filterInput.value.trim().toLowerCase();
      const onlyNonZero = qtyFilter.value !== 'all';
      const rows = INV.filter(x => {
        if (onlyNonZero && !Number(x.qty)) return false;
        if (!q) return true;
        const blob = `${x.partNumber} ${x.printName||''} ${x.location||''}`.toLowerCase();
        return blob.includes(q);
      });
      invBody.innerHTML = rows.map(rowTemplate).join('');
      countBadge.textContent = `${rows.length} items (Loaded ${INV.length})`;
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    async function loadInventory() {
      const r = await fetch('/api/inventory');
      if (!r.ok) throw new Error('failed inventory');
      INV = await r.json();
      render();
    }

    // Quantity adjust handlers (existing behavior preserved)
    invBody.addEventListener('click', async e => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const act = btn.dataset.act;
      const pn  = btn.dataset.pn;
      if (!act || !pn) return;

      if (act === 'inc' || act === 'dec') {
        const inp = invBody.querySelector(`input[data-field="delta"][data-pn="${pn}"]`);
        const cur = parseInt(inp.value || '0', 10) || 0;
        inp.value = cur + (act === 'inc' ? 1 : -1);
        return;
      }

      if (act === 'apply') {
        const inp = invBody.querySelector(`input[data-field="delta"][data-pn="${pn}"]`);
        const delta = parseInt(inp.value || '0', 10) || 0;
        if (!delta) return;
        const res = await fetch(`/api/inventory/${encodeURIComponent(pn)}/adjust`, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ delta })
        });
        if (res.ok) {
          await loadInventory();
        } else {
          alert('Failed to apply quantity.');
        }
        return;
      }

      if (act === 'edit') {
        const item = INV.find(x => x.partNumber === pn);
        openModalFor(item);
        return;
      }
    });

    function openModalFor(item) {
      editingExisting = !!item;
      modalTitle.textContent = editingExisting ? `Edit Part: ${item.partNumber}` : 'Add New Part';
      deleteBtn.style.display = editingExisting ? 'inline-block' : 'none';
      originalPartNumber = editingExisting ? item.partNumber : null;
      f_partNumber.value = item?.partNumber ?? '';
      f_printName.value = item?.printName ?? '';
      f_location.value = item?.location ?? '';
      f_min.value = item?.min ?? 0;
      f_qty.value = item?.qty ?? 0;
      f_notes.value = item?.notes ?? '';
      f_expectedHours.value = item?.expectedHours ?? '';
      partModal.showModal();
    }

    addPartBtn.addEventListener('click', () => openModalFor(null));
    cancelBtn.addEventListener('click', () => partModal.close());

    deleteBtn.addEventListener('click', async () => {
      if (!editingExisting || !originalPartNumber) return;
      if (!confirm('Delete this part? This cannot be undone.')) return;
      const r = await fetch(`/api/inventory/${encodeURIComponent(originalPartNumber)}`, { method:'DELETE' });
      if (r.ok) {
        partModal.close();
        await loadInventory();
      } else {
        alert('Delete failed.');
      }
    });

    // Save (create or update)
    partModal.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        partNumber: f_partNumber.value.trim(),
        printName: f_printName.value.trim(),
        location: f_location.value.trim(),
        min: Number(f_min.value || 0),
        qty: Number(f_qty.value || 0),
        notes: f_notes.value.trim(),
        expectedHours: f_expectedHours.value ? Number(f_expectedHours.value) : null
      };
      let url, method;
      if (editingExisting) {
        url = `/api/inventory/${encodeURIComponent(originalPartNumber)}`;
        method = 'PUT';
      } else {
        url = '/api/inventory';
        method = 'POST';
      }
      const r = await fetch(url, {
        method,
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      if (r.ok) {
        partModal.close();
        await loadInventory();
      } else {
        const msg = await r.text().catch(()=> 'Save failed.');
        alert(msg || 'Save failed.');
      }
    });

    // Filter wiring
    filterInput.addEventListener('input', render);
    qtyFilter.addEventListener('change', render);

    // Bootstrap
    (async function init(){
      currentUser = await getMe();
      showAdminControls(currentUser && (currentUser.role === 'admin' || currentUser.isAdmin === true));
      await loadInventory();
    })();

    // Logout
    document.getElementById('logoutBtn')?.addEventListener('click', async () => {
      try { await fetch('/api/auth/logout', { method:'POST' }); } catch {}
      location.href = '/';
    });
  </script>
</body>
</html>
