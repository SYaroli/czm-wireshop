<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>CZM • WireShop Inventory</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    .page-wrap{max-width:1100px;margin:30px auto;}
    .card{background:#fff;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.05);margin-bottom:14px;overflow:hidden;}
    .card-head{padding:16px 18px;border-bottom:1px solid #eee;font-weight:700;}
    .card-body{padding:16px 18px;}
    .adjust-btns{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    .adjbtn {
      background: #fff;
      color: #000; /* make numbers visible */
      border: 1px solid #cfd4da;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(15,23,42,.15);
      min-width: 46px;
      text-align: center;
    }
    .adjbtn:hover{background:#f3f4f6;}
    .qty-big{font-size:40px;font-weight:700;margin:0;}
    .qty-sub{font-size:12px;color:#6b7280;margin-top:2px;}
    .meta-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px;font-size:13px;}
    .meta-pill{background:#f3f4f6;border-radius:999px;padding:4px 10px;border:1px solid #e5e7eb;}
    .meta-pill span{font-weight:600;}
    .status-msg{font-size:12px;margin-top:6px;}
    .status-msg.ok{color:#0a0;}
    .status-msg.bad{color:#b30000;}

    .table-log{width:100%;border-collapse:collapse;font-size:12px;}
    .table-log th,.table-log td{border-bottom:1px solid #e5e7eb;padding:6px 8px;text-align:left;}
    .table-log th{background:#f9fafb;font-weight:600;}
    .muted{color:#9ca3af;font-size:12px;}

    .brand-bar{background:#0f1114;border-bottom:4px solid #c30000}
    .brand-inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:8px 12px}
    .brand-logo{display:flex;align-items:center;gap:10px;color:#fff;text-decoration:none}
    .brand-logo img{height:22px;opacity:.95}
    .brand-title{font-size:16px;margin:0;color:#fff}
    .brand-actions .navbtn{display:inline-block;background:#1a1c1f;color:#fff;border-radius:20px;padding:6px 12px;text-decoration:none;border:1px solid #3a3f44;font-weight:600;font-size:.9rem;margin-left:8px}
    .brand-actions .navbtn.active{background:#b30000;color:#fff;border-color:#ff4d4d}
    #logoutBtn{cursor:pointer;}

    .field-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px;}
    .field-row input[type="number"]{width:80px;padding:4px 6px;border-radius:4px;border:1px solid #cfd4da;}
    .field-row input[type="text"]{flex:1;min-width:220px;padding:4px 6px;border-radius:4px;border:1px solid #cfd4da;}
    .btn-primary{background:#c30000;color:#fff;border:1px solid #9f0000;border-radius:4px;padding:6px 10px;font-size:13px;cursor:pointer;}
    .btn-primary:hover{background:#9f0000;}
  </style>
</head>
<body>
  <!-- Brand bar -->
  <div class="brand-bar">
    <div class="brand-inner">
      <a class="brand-logo" href="/dashboard.html">
        <img src="/czm-logo.png" alt="CZM">
        <h1 class="brand-title">CZM • Inventory Item</h1>
      </a>
      <div class="brand-actions">
        <a class="navbtn" href="/dashboard.html">Dashboard</a>
        <a class="navbtn" href="/assignments.html">Build Next</a>
        <a class="navbtn active" href="/inventory-list.html">Inventory</a>
        <a class="navbtn" href="/archive.html">Archive</a>
        <a class="navbtn" href="/admin.html">Admin</a>
        <button id="logoutBtn" class="navbtn">Logout</button>
      </div>
    </div>
  </div>

  <main class="page-wrap">
    <div class="card">
      <div class="card-head" id="partTitle">Part</div>
      <div class="card-body">
        <div id="partMeta" class="meta-row"></div>
        <p class="qty-big" id="qty">0</p>
        <p class="qty-sub" id="lastUpdate">Last update: —</p>
        <p class="status-msg" id="statusMsg"></p>

        <div class="adjust-btns">
          <button class="adjbtn" data-delta="-10">-10</button>
          <button class="adjbtn" data-delta="-5">-5</button>
          <button class="adjbtn" data-delta="-1">-1</button>
          <button class="adjbtn" data-delta="+1">+1</button>
          <button class="adjbtn" data-delta="+5">+5</button>
          <button class="adjbtn" data-delta="+10">+10</button>
        </div>

        <div class="field-row">
          <input type="number" id="customDelta" placeholder="+/-" />
          <input type="text" id="reason" placeholder="Reason / note" />
          <button id="applyCustom" class="btn-primary">Apply custom</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-head">Recent Activity</div>
      <div class="card-body">
        <table class="table-log" id="logTable">
          <thead><tr><th>When</th><th>User</th><th>Δ</th><th>Before → After</th><th>Note</th></tr></thead>
          <tbody id="logBody"><tr><td colspan="5" class="muted">No entries.</td></tr></tbody>
        </table>
      </div>
    </div>
  </main>

  <script src="/catalog.js"></script>
  <script>
    const API_ROOT = 'https://wireshop-backend.onrender.com';
    const user = (() => { try { return JSON.parse(localStorage.getItem('user')||'{}'); } catch { return {}; } })();
    if (!user || !user.username) { window.location.href = '/index.html'; }
    document.getElementById('logoutBtn').onclick = () => { localStorage.removeItem('user'); window.location.href = '/index.html'; };

    // get part from /inv/<part>
    const pathParts = window.location.pathname.split('/');
    const partNumber = decodeURIComponent(pathParts[pathParts.length - 1]);

    const partTitle = document.getElementById('partTitle');
    const partMeta = document.getElementById('partMeta');
    const qtyEl = document.getElementById('qty');
    const lastUpdateEl = document.getElementById('lastUpdate');
    const statusMsg = document.getElementById('statusMsg');
    const logBody = document.getElementById('logBody');

    function setStatus(msg, good) {
      statusMsg.textContent = msg || '';
      statusMsg.classList.remove('ok','bad');
      if (!msg) return;
      statusMsg.classList.add(good ? 'ok' : 'bad');
    }

    async function api(path, opts={}) {
      const res = await fetch(API_ROOT + path, {
        method: opts.method || 'GET',
        headers: { 'Content-Type':'application/json', 'x-user': user.username },
        body: opts.body ? JSON.stringify(opts.body) : undefined
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function loadPart() {
      // try backend for live qty
      let live = null;
      try {
        live = await api(`/api/inventory/${encodeURIComponent(partNumber)}`);
      } catch (e) {
        // ignore
      }

      // catalog fallback
      const cat = Array.isArray(window.catalog) ? window.catalog : [];
      const fromCat = cat.find(c => String(c.partNumber) === String(partNumber));

      const desc = live?.description || fromCat?.printName || '';
      const location = live?.location || fromCat?.location || '';
      const qty = typeof live?.qty === 'number' ? live.qty : 0;
      const minQty = typeof live?.minQty === 'number' ? live.minQty : (fromCat?.minQty || 0);
      const notes = live?.notes || fromCat?.notes || '';

      partTitle.textContent = `${partNumber} — ${desc || 'No description'}`;
      qtyEl.textContent = qty;

      const metaBits = [];
      if (location) metaBits.push(`<div class="meta-pill"><span>Location:</span> ${location}</div>`);
      metaBits.push(`<div class="meta-pill"><span>Min qty:</span> ${minQty}</div>`);
      if (notes) metaBits.push(`<div class="meta-pill"><span>Notes:</span> ${notes}</div>`);
      const updated = live?.updatedAt ? new Date(live.updatedAt).toLocaleString() : null;
      if (updated) {
        lastUpdateEl.textContent = `Last update: ${updated} by ${live.updatedBy||'unknown'}`;
      } else {
        lastUpdateEl.textContent = 'Last update: —';
      }
      partMeta.innerHTML = metaBits.join('') || '<div class="meta-pill">No extra metadata.</div>';

      setStatus('', true);

      // load log from backend if available
      try {
        const log = await api(`/api/inventory/${encodeURIComponent(partNumber)}/log`);
        renderLog(log);
      } catch (e) {
        // if log endpoint missing or errors, we just leave "No entries"
      }
    }

    function renderLog(log) {
      if (!Array.isArray(log) || !log.length) {
        logBody.innerHTML = `<tr><td colspan="5" class="muted">No entries.</td></tr>`;
        return;
      }
      logBody.innerHTML = log.map(entry => `
        <tr>
          <td>${entry.when ? new Date(entry.when).toLocaleString() : ''}</td>
          <td>${entry.user || ''}</td>
          <td>${entry.delta || ''}</td>
          <td>${entry.before ?? ''} → ${entry.after ?? ''}</td>
          <td>${entry.note || ''}</td>
        </tr>
      `).join('');
    }

    async function applyDelta(delta, note) {
      const currentQty = parseInt(qtyEl.textContent || '0', 10);
      const newQty = currentQty + delta;

      try {
        // 1) Save the new quantity
        await api(`/api/inventory/${encodeURIComponent(partNumber)}/qty`, {
          method: 'POST',
          body: { qty: newQty }
        });

        // 2) Persist a log entry to the backend
        await api(`/api/inventory/${encodeURIComponent(partNumber)}/log`, {
          method: 'POST',
          body: {
            delta,
            before: currentQty,
            after: newQty,
            note: note || '',
            user: user.username,
            when: Date.now()
          }
        });

        // 3) Update UI
        qtyEl.textContent = newQty;
        setStatus('Updated.', true);

        // 4) Reload log from backend so what you see is real data
        try {
          const log = await api(`/api/inventory/${encodeURIComponent(partNumber)}/log`);
          renderLog(log);
        } catch (err) {
          console.warn('Failed to reload log', err);
        }

      } catch (e) {
        console.error(e);
        setStatus('Failed to adjust.', false);
      }
    }

    // preset buttons
    document.querySelectorAll('.adjbtn').forEach(btn =>
      btn.addEventListener('click', () => {
        const d = parseInt(btn.dataset.delta, 10);
        applyDelta(d, '');
      })
    );

    // custom
    document.getElementById('applyCustom').addEventListener('click', () => {
      const d = parseInt(document.getElementById('customDelta').value||'0', 10);
      const note = document.getElementById('reason').value || '';
      if (!d) return;
      applyDelta(d, note);
      document.getElementById('customDelta').value = '';
      document.getElementById('reason').value = '';
    });

    loadPart().catch(()=>setStatus('Failed to load part', false));
  </script>
</body>
</html>
