<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>CZM • WireShop Inventory</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    .page-wrap{max-width:1100px;margin:30px auto;}
    .card{background:#fff;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.05);margin-bottom:14px;overflow:hidden;}
    .card-head{padding:16px 18px;border-bottom:1px solid #eee;font-weight:700;}
    .card-body{padding:16px 18px;}
    .adjust-btns{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    .adjbtn {
  background: #fff;
  color: #000; /* make numbers visible */
  border: 1px solid #d4d6da;
  border-radius: 10px;
  padding: 10px 18px;
  min-width: 60px;
  text-align: center;
  font-weight: 700;
  cursor: pointer;
}

.adjbtn:hover {
  background: #b30000;
  color: #fff;
  border-color: #b30000;
}
    .inline-inputs{display:flex;gap:10px;margin-bottom:10px}
    .inline-inputs input{flex:1;padding:6px 8px;border:1px solid #d3d8e1;border-radius:8px}
    .apply{background:#b30000;color:#fff;border:none;border-radius:10px;padding:7px 14px;font-weight:700;cursor:pointer}
    .qty-big{font-size:36px;font-weight:800}
    .table-log{width:100%;border-collapse:collapse}
    .table-log th,.table-log td{border-bottom:1px solid #eee;padding:5px 0;font-size:12px}
    .muted{color:#666;font-size:12px}
    .brand-bar{background:#1a1c20;padding:10px 16px;color:#fff;display:flex;align-items:center;justify-content:space-between}
    .brand-title{font-weight:700}
    .navbtn{background:#1a1c20;color:#eee;border:1px solid #444;padding:5px 12px;border-radius:10px;text-decoration:none;margin-left:8px;font-size:.85rem}
    .navbtn.active{background:#b30000;border-color:#b30000}
  </style>
</head>
<body>
  <div class="brand-bar">
    <div class="brand-title">CZM • Wireshop Inventory</div>
    <div>
      <a class="navbtn" href="/dashboard.html">Build Next</a>
      <a class="navbtn active" href="/inventory">Inventory</a>
      <button id="logoutBtn" class="navbtn">Logout</button>
    </div>
  </div>

  <main class="page-wrap">
    <div class="card" id="headerCard">
      <div class="card-head" id="partTitle">Inventory — </div>
      <div class="card-body" id="partMeta">
        <div class="muted">Loading…</div>
      </div>
    </div>

    <div class="card">
      <div class="card-head">Quantity</div>
      <div class="card-body">
        <div class="qty-big" id="qty">0</div>
        <div class="muted" id="lastUpdate"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-head">Adjust</div>
      <div class="card-body">
        <div class="adjust-btns">
          <button class="adjbtn" data-delta="-5">−5</button>
          <button class="adjbtn" data-delta="-1">−1</button>
          <button class="adjbtn" data-delta="1">+1</button>
          <button class="adjbtn" data-delta="5">+5</button>
          <button class="adjbtn" data-delta="-10">−10</button>
          <button class="adjbtn" data-delta="10">+10</button>
        </div>
        <div class="inline-inputs">
          <input id="customDelta" type="number" placeholder="e.g. 12 or -3" />
          <input id="reason" type="text" placeholder="optional" />
          <button id="applyCustom" class="apply">Apply custom</button>
        </div>
        <div class="muted" id="statusMsg"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-head">Recent Activity</div>
      <div class="card-body">
        <table class="table-log" id="logTable">
          <thead><tr><th>When</th><th>User</th><th>Δ</th><th>Before → After</th><th>Note</th></tr></thead>
          <tbody id="logBody"><tr><td colspan="5" class="muted">No entries.</td></tr></tbody>
        </table>
      </div>
    </div>
  </main>

  <script src="/catalog.js"></script>
  <script>
    const API_ROOT = 'https://wireshop-backend.onrender.com';
    const user = (() => { try { return JSON.parse(localStorage.getItem('user')||'{}'); } catch { return {}; } })();
    if (!user || !user.username) { window.location.href = '/index.html'; }
    document.getElementById('logoutBtn').onclick = () => { localStorage.removeItem('user'); window.location.href = '/index.html'; };

    // get part from /inv/<part>
    const pathParts = window.location.pathname.split('/');
    const partNumber = decodeURIComponent(pathParts[pathParts.length - 1]);

    const partTitle = document.getElementById('partTitle');
    const partMeta = document.getElementById('partMeta');
    const qtyEl = document.getElementById('qty');
    const lastUpdateEl = document.getElementById('lastUpdate');
    const statusMsg = document.getElementById('statusMsg');
    const logBody = document.getElementById('logBody');

    function setStatus(msg, good) {
      statusMsg.textContent = msg || '';
      statusMsg.style.color = good ? '#0a0' : '#b30000';
    }

    async function api(path, opts={}) {
      const res = await fetch(API_ROOT + path, {
        method: opts.method || 'GET',
        headers: { 'Content-Type':'application/json', 'x-user': user.username },
        body: opts.body ? JSON.stringify(opts.body) : undefined
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function loadPart() {
      // try backend for live qty
      let live = null;
      try {
        live = await api(`/api/inventory/${encodeURIComponent(partNumber)}`);
      } catch (e) {
        // ignore, maybe part not in DB yet
      }

      // match against catalog for description/location
      const cat = (window.catalog || []).find(c => String(c.partNumber).trim() === partNumber);
      const description = live?.description || cat?.printName || '';
      const location = live?.location || cat?.location || '';

      partTitle.textContent = `Inventory — ${partNumber}`;
      partMeta.innerHTML = `
        <div><strong>Part Number:</strong> ${partNumber}</div>
        <div><strong>Print Name:</strong> ${description || 'n/a'}</div>
        <div><strong>Location:</strong> ${location || 'n/a'}</div>
        <div class="muted">If any of this looks wrong, fix the catalog later.</div>
      `;

      qtyEl.textContent = live ? (live.qty|0) : 0;
      lastUpdateEl.textContent = live && live.updatedAt ? `Last update: ${new Date(live.updatedAt).toLocaleString()} by ${live.updatedBy||'unknown'}` : '';

      // try to load log if backend has it
      try {
        const log = await api(`/api/inventory/${encodeURIComponent(partNumber)}/log`);
        renderLog(log);
      } catch (e) {
        // fine
      }
    }

    function renderLog(log) {
      if (!Array.isArray(log) || !log.length) {
        logBody.innerHTML = `<tr><td colspan="5" class="muted">No entries.</td></tr>`;
        return;
      }
      logBody.innerHTML = log.map(entry => `
        <tr>
          <td>${entry.when ? new Date(entry.when).toLocaleString() : ''}</td>
          <td>${entry.user || ''}</td>
          <td>${entry.delta || ''}</td>
          <td>${entry.before ?? ''} → ${entry.after ?? ''}</td>
          <td>${entry.note || ''}</td>
        </tr>
      `).join('');
    }

    async function applyDelta(delta, note) {
      const currentQty = parseInt(qtyEl.textContent || '0', 10);
      const newQty = currentQty + delta;
      try {
        await api(`/api/inventory/${encodeURIComponent(partNumber)}/qty`, {
          method: 'POST',
          body: { qty: newQty, note: note || '' }
        });
        qtyEl.textContent = newQty;
        setStatus('Updated.', true);
        // add to log visually
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${new Date().toLocaleString()}</td><td>${user.username}</td><td>${delta}</td><td>${currentQty} → ${newQty}</td><td>${note||''}</td>`;
        if (logBody.firstChild && !logBody.firstChild.classList?.contains('muted')) {
          logBody.prepend(tr);
        } else {
          logBody.innerHTML = '';
          logBody.appendChild(tr);
        }
      } catch (e) {
        setStatus('Failed to adjust.', false);
      }
    }

    // preset buttons
    document.querySelectorAll('.adjbtn').forEach(btn => {
      btn.addEventListener('click', () => {
        const d = parseInt(btn.dataset.delta, 10);
        applyDelta(d, '');
      });
    });

    // custom
    document.getElementById('applyCustom').addEventListener('click', () => {
      const d = parseInt(document.getElementById('customDelta').value||'0', 10);
      const note = document.getElementById('reason').value || '';
      if (!d) return;
      applyDelta(d, note);
      document.getElementById('customDelta').value = '';
      document.getElementById('reason').value = '';
    });

    loadPart().catch(()=>setStatus('Failed to load part', false));
  </script>
</body>
</html>
