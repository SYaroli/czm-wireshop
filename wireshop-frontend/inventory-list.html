<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CZM • Inventory</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    /* App chrome */
    :root{--czm-red:#c30000;--ink:#0b0c0e;}
    html,body{background:#eef0f3;margin:0}
    /* Top bar with right-aligned nav (match assignments.html feel) */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      background:#111; border-bottom:4px solid var(--czm-red); height:50px; padding:0 16px;
    }
    .brand{display:flex; align-items:center; gap:10px; color:#fff; font-weight:600; font-size:14px}
    .brand img{height:18px; opacity:.95}
    .nav{display:flex; gap:8px}
    .nav a{
      display:inline-flex; align-items:center; height:30px; padding:0 12px;
      background:#2a2a2a; color:#fff; text-decoration:none; border-radius:6px; font-size:13px
    }
    .nav a:hover{background:#3a3a3a}
    .nav a.active{background:var(--czm-red)}

    /* Card shell */
    .card{max-width:1200px; margin:24px auto; background:#fff; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,.08); overflow:hidden}
    .card-head{padding:14px 16px 8px}
    .card-head h2{margin:0 0 10px; font:600 16px/1.1 system-ui,Segoe UI,Roboto,Arial}

    /* Filter toolbar */
    .toolbar{display:flex; flex-wrap:wrap; align-items:center; gap:10px}
    .toolbar input[type="text"]{flex:1 1 360px; min-width:240px; height:34px; padding:0 10px; border:1px solid #cfd4da; border-radius:6px}
    .check{display:flex; align-items:center; gap:8px; height:34px; padding:0 10px; border:1px solid #cfd4da; border-radius:6px; background:#f7f8fa}
    .check input{width:16px; height:16px; margin:0}
    .btn{height:34px; padding:0 12px; border:1px solid #cfd4da; border-radius:6px; background:#eee; font-size:13px; cursor:pointer}
    .btn.red{background:var(--czm-red); color:#fff; border-color:#a00000}
    #countLabel{margin-left:auto; font-size:12px; white-space:nowrap}

    /* Header row + rows */
    .head, .row{
      display:grid; grid-template-columns: 160px 1fr 110px 70px 340px 1fr; gap:0; align-items:center;
      padding:10px 16px
    }
    .head{background:#0a0b0d; color:#fff; font-weight:700; font-size:12px}
    .row{border-top:1px solid #eef2f6; background:#fff}
    .row:nth-child(odd){background:#fafbfc}
    .row a{color:#003574; text-decoration:none; font-size:12px}
    .row div{font-size:12px}
    .notes{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    /* Adjust controls */
    .controls{display:flex; align-items:center; gap:10px}
    .qty{width:76px; height:30px; padding:0 8px; text-align:center; border:1px solid #d0d3d8; border-radius:20px}
    .apply{height:32px; min-width:64px; border:none; border-radius:6px; background:#b70000; color:#fff; cursor:pointer}
    .edit{height:32px; min-width:64px; border:none; border-radius:6px; background:#3a3a3a; color:#fff; cursor:pointer}
    .muted{color:#9aa3ad}

    /* Modal */
    .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:10}
    .modal{background:#122032; color:#fff; width:420px; padding:16px; border-radius:8px; box-shadow:0 8px 20px rgba(0,0,0,.4)}
    .modal h3{margin:0 0 10px}
    .modal label{display:block; font-size:12px; margin:8px 0 4px}
    .modal input,.modal textarea{width:100%; border:none; border-radius:6px; height:34px; padding:6px 8px; outline:none; color:#000}
    .modal textarea{height:90px; resize:vertical}
    .modal-actions{margin-top:14px; display:flex; gap:10px; justify-content:flex-end}
    .btn-sm{border:none; border-radius:6px; padding:6px 14px; cursor:pointer}
    .btn-red{background:var(--czm-red); color:#fff}
    .btn-gray{background:#c5c5c5; color:#000}

    @media (max-width:920px){
      .head, .row{grid-template-columns:150px 1fr 90px 60px 280px}
      .notes{grid-column:1 / -1; margin-top:2px}
      .controls{flex-wrap:wrap}
    }
  </style>
</head>
<body>
  <!-- Fixed top bar (right-aligned nav) -->
  <div class="topbar">
    <div class="brand">
      <img src="czm-logo.png" alt="CZM" />
      <span>CZM • Inventory</span>
    </div>
    <div class="nav">
      <a href="/assignments.html">Build Next</a>
      <a href="/inventory" class="active">Inventory</a>
      <a href="/logout" id="logoutLink">Logout</a>
    </div>
  </div>

  <div class="card">
    <div class="card-head">
      <h2>Inventory — Snapshot</h2>
      <div class="toolbar">
        <input id="filterBox" type="text" placeholder="part number, print name, or location" />
        <label class="check"><input id="cbNonZero" type="checkbox"><span>only non-zero</span></label>
        <label class="check"><input id="cbOnlyZero" type="checkbox"><span>only 0-qty</span></label>
        <button id="exportBtn" class="btn">Export</button>
        <button id="addBtn" class="btn red">Add part</button>
        <span id="countLabel">0 items</span>
      </div>
    </div>

    <div class="head">
      <div>Part Number</div><div>Print Name</div><div>Location</div><div>Qty</div><div>Adjust</div><div>Notes</div>
    </div>
    <div id="listBody"></div>
  </div>

  <!-- Edit/Add modal -->
  <div id="editModal" class="backdrop">
    <div class="modal">
      <h3 id="modalTitle">Edit Part</h3>
      <label for="mPart">Part Number</label><input id="mPart" readonly />
      <label for="mDesc">Description</label><input id="mDesc" />
      <label for="mLoc">Location</label><input id="mLoc" />
      <label for="mQty">Qty</label><input id="mQty" type="number" />
      <label for="mNotes">Notes</label><textarea id="mNotes"></textarea>
      <div class="modal-actions">
        <button id="saveBtn" class="btn-sm btn-red">Save</button>
        <button id="cancelBtn" class="btn-sm btn-gray">Cancel</button>
        <button id="deleteBtn" class="btn-sm btn-gray" style="margin-left:auto">Delete</button>
      </div>
    </div>
  </div>

  <!-- Data sources -->
  <script src="users.js"></script>
  <script src="catalog.js"></script>
  <script>
    const API_BASE = 'https://wireshop-backend.onrender.com/api';

    const listBody   = document.getElementById('listBody');
    const filterBox  = document.getElementById('filterBox');
    const countLabel = document.getElementById('countLabel');
    const cbNonZero  = document.getElementById('cbNonZero');
    const cbOnlyZero = document.getElementById('cbOnlyZero');
    const addBtn     = document.getElementById('addBtn');

    const modal      = document.getElementById('editModal');
    let modalMode = 'edit', isAdmin = false, currentUser = null, ALL = [], DB = {};

    function getUser(){
      try{ const raw = localStorage.getItem('user'); return raw ? JSON.parse(raw) : null; }catch{ return null; }
    }
    function isAdminUser(u){
      const name = (u?.username || u?.name || u?.user || '').trim();
      const fromUsersJs = (window.ADMIN_USERS?.includes?.(name)) || (window.ADMINS?.includes?.(name));
      if (fromUsersJs) return true;
      return ['Shane.Yaroli','Tyler.Ellis'].includes(name); // fallback safety
    }

    async function loadData(){
      currentUser = getUser();
      if(!currentUser){ alert('No user in localStorage. Please log in.'); return; }
      isAdmin = isAdminUser(currentUser);
      addBtn.style.display = isAdmin ? 'inline-block' : 'none';

      const invRes = await fetch(API_BASE+'/inventory-all', {headers:{'x-user': currentUser.username||currentUser.name||currentUser.user||currentUser}});
      const inv = await invRes.json();
      DB = {}; inv.forEach(r => DB[r.partNumber] = r);

      const cat = Array.isArray(window.catalog) ? window.catalog : [];
      const merged = [];

      // catalog + db (db wins)
      cat.forEach(c=>{
        const d = DB[c.partNumber];
        if (d){
          merged.push({
            partNumber: d.partNumber,
            printName:  d.description ?? c.printName ?? '',
            location:   d.location ?? c.location ?? '',
            qty:        (typeof d.qty === 'number') ? d.qty : 0,
            notes:      d.notes ?? c.notes ?? ''
          });
        } else {
          merged.push({
            partNumber: c.partNumber,
            printName:  c.printName ?? '',
            location:   c.location ?? '',
            qty:        0,
            notes:      c.notes ?? ''
          });
        }
      });

      // db-only rows
      inv.forEach(d=>{
        if (!cat.find(c=>c.partNumber===d.partNumber)){
          merged.push({
            partNumber: d.partNumber,
            printName:  d.description ?? '',
            location:   d.location ?? '',
            qty:        (typeof d.qty === 'number') ? d.qty : 0,
            notes:      d.notes ?? ''
          });
        }
      });

      merged.sort((a,b)=>(a.partNumber||'').localeCompare(b.partNumber||''));
      ALL = merged;
      render();
    }

    function render(){
      const f = filterBox.value.trim().toLowerCase(), onlyNZ = cbNonZero.checked, onlyZ = cbOnlyZero.checked;
      listBody.innerHTML = '';
      let shown = 0;

      ALL.forEach(r=>{
        if (f){
          const hay = (r.partNumber+' '+(r.printName||'')+' '+(r.location||'')).toLowerCase();
          if (!hay.includes(f)) return;
        }
        if (onlyNZ && (!r.qty || r.qty===0)) return;
        if (onlyZ  && ( r.qty && r.qty!==0)) return;

        const row = document.createElement('div'); row.className = 'row';

        const a   = document.createElement('a'); a.href='/inv/'+encodeURIComponent(r.partNumber); a.textContent=r.partNumber;
        const nm  = document.createElement('div'); nm.textContent=r.printName||'';
        const lc  = document.createElement('div'); lc.textContent=r.location||'';
        const q   = document.createElement('div'); q.textContent=(r.qty!=null?r.qty:0);

        const ctr = document.createElement('div'); ctr.className='controls';
        if (isAdmin){
          const qty = document.createElement('input'); qty.type='text'; qty.placeholder='+/-'; qty.className='qty';
          const apply = document.createElement('button'); apply.className='apply'; apply.textContent='Apply';
          apply.onclick = ()=>applyAdjust(r.partNumber, r.qty, qty.value);
          const edit = document.createElement('button'); edit.className='edit'; edit.textContent='Edit';
          edit.onclick = ()=>openModal(r);
          ctr.append(qty,apply,edit);
        } else {
          ctr.innerHTML = '<span class="muted">—</span>';
        }

        const nt  = document.createElement('div'); nt.className='notes'; nt.textContent=r.notes||'';

        row.append(a,nm,lc,q,ctr,nt);
        listBody.appendChild(row);
        shown++;
      });

      countLabel.textContent = shown + ' items';
    }

    async function applyAdjust(partNumber,currentQty,deltaStr){
      if(!isAdmin) return;
      const delta = Number(deltaStr); if(isNaN(delta)){alert('enter a number'); return;}
      const qty = (Number(currentQty)||0) + delta;

      const res = await fetch(API_BASE+'/inventory/'+encodeURIComponent(partNumber)+'/qty', {
        method:'POST',
        headers:{'Content-Type':'application/json','x-user': currentUser.username||currentUser.name||currentUser.user||currentUser},
        body:JSON.stringify({qty})
      });
      const data = await res.json(); if(!res.ok){alert(data.error||'failed to adjust'); return;}

      const row = ALL.find(x=>x.partNumber===partNumber); if(row) row.qty = qty;
      render();
    }

    function openModal(row,isNew=false){
      if(!isAdmin) return;
      modalMode = isNew ? 'add' : 'edit';
      document.getElementById('modalTitle').textContent = isNew ? 'Add Part' : 'Edit Part';
      document.getElementById('mPart').readOnly = !isNew;
      document.getElementById('mPart').value = row?.partNumber || '';
      document.getElementById('mDesc').value = row?.printName  || '';
      document.getElementById('mLoc').value  = row?.location   || '';
      document.getElementById('mQty').value  = row?.qty != null ? row.qty : 0;
      document.getElementById('mNotes').value= row?.notes || '';
      document.getElementById('deleteBtn').style.display = isNew ? 'none' : 'inline-block';
      modal.style.display = 'flex';
    }

    async function saveModal(){
      if(!isAdmin) return;
      const part = document.getElementById('mPart').value.trim();
      const description = document.getElementById('mDesc').value;
      const location = document.getElementById('mLoc').value;
      const qty = Number(document.getElementById('mQty').value || 0);
      const notes = document.getElementById('mNotes').value;
      if(!part){alert('part number required'); return;}

      const payload = {partNumber:part, description, location, qty, minQty:0, notes};
      const headers = {'Content-Type':'application/json','x-user': currentUser.username||currentUser.name||currentUser.user||currentUser};

      if (modalMode==='add'){
        const res = await fetch(API_BASE+'/inventory',{method:'POST', headers, body:JSON.stringify(payload)});
        const data= await res.json(); if(!res.ok){alert(data.error||'failed to add'); return;}
      } else {
        const res = await fetch(API_BASE+'/inventory/'+encodeURIComponent(part),{method:'PUT', headers, body:JSON.stringify(payload)});
        const data= await res.json(); if(!res.ok){alert(data.error||'failed to save'); return;}
      }
      modal.style.display='none';
      await loadData();
    }

    async function deleteModal(){
      if(!isAdmin) return;
      const part = document.getElementById('mPart').value.trim(); if(!part) return;
      if(!confirm('Delete '+part+'?')) return;

      const res = await fetch(API_BASE+'/inventory/'+encodeURIComponent(part), {
        method:'DELETE',
        headers:{'x-user': currentUser.username||currentUser.name||currentUser.user||currentUser}
      });
      const data = await res.json(); if(!res.ok){alert(data.error||'failed to delete'); return;}
      modal.style.display='none';
      await loadData();
    }

    // Wire events
    document.getElementById('cancelBtn').onclick = ()=> modal.style.display='none';
    document.getElementById('saveBtn').onclick   = saveModal;
    document.getElementById('deleteBtn').onclick = deleteModal;
    document.getElementById('exportBtn').onclick = ()=>{
      let csv='partNumber,description,location,qty,notes\n';
      ALL.forEach(r=>{
        csv+=`"${r.partNumber}","${(r.printName||'').replace(/"/g,'""')}","${(r.location||'').replace(/"/g,'""')}",${r.qty||0},"${(r.notes||'').replace(/"/g,'""')}"\n`;
      });
      const blob=new Blob([csv],{type:'text/csv'}), url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='inventory.csv'; a.click(); URL.revokeObjectURL(url);
    };
    addBtn.onclick = ()=>openModal(null,true);
    filterBox.addEventListener('input',render);
    cbNonZero.addEventListener('change',render);
    cbOnlyZero.addEventListener('change',render);

    // Start
    loadData();
  </script>
</body>
</html>
