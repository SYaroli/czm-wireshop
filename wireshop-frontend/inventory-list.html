<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Inventory List</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background:#101820; color:#fff; margin:0; padding:0; }
    header { background:#c8102e; padding:12px 16px; display:flex; justify-content:space-between; align-items:center; }
    h1 { margin:0; font-size:20px; }
    .user-box { font-size:12px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { padding:6px 8px; border-bottom:1px solid #333; font-size:13px; }
    th { background:#18222e; text-align:left; }
    tr:hover { background:#1a2735; }
    button { cursor:pointer; }
    .btn { background:#c8102e; border:none; color:#fff; padding:4px 10px; border-radius:4px; font-size:12px; }
    .btn.secondary { background:#444; }
    #editModalBg {
      position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center;
    }
    #editModal {
      background:#18222e; padding:16px; border-radius:6px; width:320px; box-shadow:0 4px 20px rgba(0,0,0,.5);
    }
    #editModal h2 { margin-top:0; font-size:16px; }
    .form-row { margin-bottom:8px; }
    .form-row label { display:block; font-size:12px; margin-bottom:2px; }
    .form-row input, .form-row textarea {
      width:100%; padding:4px; background:#101820; border:1px solid #444; color:#fff; border-radius:4px; font-size:12px;
    }
    .actions { display:flex; gap:6px; }
  </style>
</head>
<body>
  <header>
    <h1>Inventory</h1>
    <div class="user-box">
      User: <span id="userDisplay"></span>
    </div>
  </header>
  <main style="padding:10px;">
    <table id="invTable">
      <thead>
        <tr>
          <th>Part #</th>
          <th>Description</th>
          <th>Location</th>
          <th>Qty</th>
          <th>Min</th>
          <th>Notes</th>
          <th id="thActions" style="display:none;">Actions</th>
        </tr>
      </thead>
      <tbody id="invBody"></tbody>
    </table>
  </main>

  <!-- edit modal -->
  <div id="editModalBg">
    <div id="editModal">
      <h2 id="modalTitle">Edit Part</h2>
      <div class="form-row">
        <label>Part Number</label>
        <input id="mPartNumber" readonly />
      </div>
      <div class="form-row">
        <label>Description</label>
        <input id="mDescription" />
      </div>
      <div class="form-row">
        <label>Location</label>
        <input id="mLocation" />
      </div>
      <div class="form-row">
        <label>Qty</label>
        <input id="mQty" type="number" />
      </div>
      <div class="form-row">
        <label>Min Qty</label>
        <input id="mMinQty" type="number" />
      </div>
      <div class="form-row">
        <label>Notes</label>
        <textarea id="mNotes" rows="2"></textarea>
      </div>
      <div class="actions">
        <button class="btn" id="saveBtn">Save</button>
        <button class="btn secondary" id="cancelBtn">Cancel</button>
        <button class="btn secondary" id="deleteBtn" style="margin-left:auto;">Delete</button>
      </div>
    </div>
  </div>

  <script>
    // TEMP until you wire to real session
    const CURRENT_USER = 'shane';
    const ADMIN_USERS = ['shane','admin'];
    const isAdmin = ADMIN_USERS.includes(CURRENT_USER.toLowerCase());

    document.getElementById('userDisplay').textContent = CURRENT_USER;
    if (isAdmin) {
      document.getElementById('thActions').style.display = '';
    }

    async function fetchInventory() {
      const res = await fetch('/api/inventory-all', {
        headers: { 'x-user': CURRENT_USER }
      });
      const data = await res.json();
      renderTable(data);
    }

    function renderTable(rows) {
      const tbody = document.getElementById('invBody');
      tbody.innerHTML = '';
      rows.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.partNumber || ''}</td>
          <td>${row.description || ''}</td>
          <td>${row.location || ''}</td>
          <td>${row.qty ?? ''}</td>
          <td>${row.minQty ?? ''}</td>
          <td>${row.notes || ''}</td>
          ${isAdmin ? `<td><button class="btn secondary" data-part="${row.partNumber}">Edit</button></td>` : '<td style="display:none;"></td>'}
        `;
        if (isAdmin) {
          tr.querySelector('button').addEventListener('click', () => openEdit(row));
        }
        tbody.appendChild(tr);
      });
    }

    const modalBg = document.getElementById('editModalBg');
    const mPartNumber = document.getElementById('mPartNumber');
    const mDescription = document.getElementById('mDescription');
    const mLocation = document.getElementById('mLocation');
    const mQty = document.getElementById('mQty');
    const mMinQty = document.getElementById('mMinQty');
    const mNotes = document.getElementById('mNotes');

    function openEdit(row) {
      mPartNumber.value = row.partNumber || '';
      mDescription.value = row.description || '';
      mLocation.value = row.location || '';
      mQty.value = row.qty ?? 0;
      mMinQty.value = row.minQty ?? 0;
      mNotes.value = row.notes || '';
      modalBg.style.display = 'flex';
    }

    async function saveEdit() {
      const part = mPartNumber.value;
      const payload = {
        description: mDescription.value,
        location: mLocation.value,
        qty: Number(mQty.value) || 0,
        minQty: Number(mMinQty.value) || 0,
        notes: mNotes.value
      };
      await fetch(`/api/inventory/${encodeURIComponent(part)}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'x-user': CURRENT_USER
        },
        body: JSON.stringify(payload)
      });
      modalBg.style.display = 'none';
      fetchInventory();
    }

    async function deletePart() {
      const part = mPartNumber.value;
      if (!confirm('Delete ' + part + '?')) return;
      await fetch(`/api/inventory/${encodeURIComponent(part)}`, {
        method: 'DELETE',
        headers: { 'x-user': CURRENT_USER }
      });
      modalBg.style.display = 'none';
      fetchInventory();
    }

    document.getElementById('saveBtn').addEventListener('click', saveEdit);
    document.getElementById('cancelBtn').addEventListener('click', () => modalBg.style.display = 'none');
    document.getElementById('deleteBtn').addEventListener('click', deletePart);

    fetchInventory();
  </script>
</body>
</html>
