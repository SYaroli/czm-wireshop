<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CZM • Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/czm-logo.png" />
  <style>
    :root{
      --bg:#0f1115;
      --panel:#171a21;
      --line:#2a2f3a;
      --text:#e8eef8;
      --muted:#9fb0c7;
      --brand:#c40d0d;
      --btn:#2b3140;
      --btn-border:#3a4254;
      --btn-hover:#3a4254;
      --ok:#0f8b4c;
      --shadow: 0 6px 18px rgba(0,0,0,.35);
      --radius: 10px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial}
    a{color:#7bb3ff;text-decoration:none}
    a:hover{text-decoration:underline}

    /* Top bar */
    .topbar{
      height:44px; display:flex; align-items:center; gap:10px;
      padding:0 14px; background:#0b0d11; border-bottom:1px solid var(--line);
    }
    .brand{font-weight:700; letter-spacing:.3px; opacity:.9}

    /* Container */
    .wrap{max-width:1150px; margin:22px auto; padding:0 16px}

    /* Card */
    .card{background:var(--panel); border:1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow)}
    .card__head{padding:14px 14px 8px; border-bottom:1px solid var(--line)}
    .title{font-weight:700; font-size:16px; margin:0 0 8px}

    /* Controls row */
    .controls{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .input{height:34px; background:#0e1117; color:var(--text); border:1px solid var(--btn-border); border-radius:8px; padding:6px 10px; outline:none; min-width:280px}
    .check{display:flex; align-items:center; gap:6px; color:var(--muted); font-size:12px; padding:6px 8px; border:1px solid var(--btn-border); border-radius:8px; background:#0e1117; height:34px}
    .btn{height:34px; padding:0 12px; border:1px solid var(--btn-border); background:var(--btn); color:var(--text); border-radius:8px; cursor:pointer}
    .btn:hover{background:var(--btn-hover)}
    .btn--brand{background:var(--brand); border-color:#8c0a0a}
    .btn--brand:hover{filter:brightness(.95)}
    .muted{color:var(--muted); font-size:12px}

    /* Table */
    .table{width:100%; border-collapse:separate; border-spacing:0}
    .table th, .table td{padding:10px 10px; border-bottom:1px solid var(--line)}
    .table thead th{position:sticky; top:0; background:var(--panel); z-index:2; font-weight:700; text-align:left}
    .col-num{width:160px}
    .col-print{width:280px}
    .col-loc{width:100px}
    .col-qty{width:60px; text-align:right}
    .col-adjust{width:220px}
    .col-notes{min-width:220px}

    /* Adjust cell layout */
    .adjust{display:flex; align-items:center; gap:8px}
    .delta{width:68px; text-align:center}
    .pill{height:28px; padding:0 12px; border-radius:14px; border:1px solid var(--btn-border); background:var(--btn); color:var(--text); cursor:pointer; font-size:12px}
    .pill--brand{background:var(--brand); border-color:#8c0a0a}
    .pill:hover{background:var(--btn-hover)}
    .pill--brand:hover{filter:brightness(.95)}
    .pill--edit{background:#454b5c;border-color:#4f576c}

    /* Modal */
    dialog{
      border:1px solid var(--line); border-radius:12px; background:var(--panel); color:var(--text);
      width:520px; padding:0; box-shadow: var(--shadow);
    }
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .m-head{padding:14px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center}
    .m-title{margin:0; font-weight:700}
    .m-body{padding:14px; display:grid; gap:10px}
    .grid2{display:grid; grid-template-columns:1fr 140px; gap:10px}
    .m-row{display:flex; flex-direction:column; gap:6px}
    .m-row label{font-size:12px; color:var(--muted)}
    .m-actions{padding:12px 14px; border-top:1px solid var(--line); display:flex; gap:8px; justify-content:flex-end}
    .full{width:100%}
    .danger{background:#8c0a0a}
    .danger:hover{filter:brightness(.95)}

    .right{margin-left:auto}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">CZM • Inventory</div>
    <div class="muted right" id="who"></div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="card__head">
        <h3 class="title">Inventory — Snapshot</h3>
        <div class="controls">
          <input id="filter" class="input" placeholder="part number, print name, or location" />
          <label class="check"><input id="onlyNonZero" type="checkbox" /> only non-zero</label>
          <label class="check"><input id="onlyZero" type="checkbox" /> only 0-qty</label>
          <button id="exportBtn" class="btn">Export</button>
          <button id="addBtn" class="btn btn--brand">Add part</button>
          <div class="muted" id="count">0 items</div>
        </div>
      </div>

      <div style="overflow:auto">
        <table class="table" id="table">
          <thead>
            <tr>
              <th class="col-num">Part Number</th>
              <th class="col-print">Print Name</th>
              <th class="col-loc">Location</th>
              <th class="col-qty">Qty</th>
              <th class="col-adjust">Adjust</th>
              <th class="col-notes">Notes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Edit / Add modal -->
  <dialog id="editModal">
    <div class="m-head">
      <h4 class="m-title" id="modalTitle">Edit Part</h4>
      <button class="btn" id="closeModal">Close</button>
    </div>
    <div class="m-body">
      <div class="m-row">
        <label for="mPart">Part Number</label>
        <input id="mPart" class="input full" />
      </div>

      <div class="m-row">
        <label for="mPrint">Print Name</label>
        <input id="mPrint" class="input full" />
      </div>

      <div class="grid2">
        <div class="m-row">
          <label for="mLoc">Location</label>
          <input id="mLoc" class="input" />
        </div>
        <div class="m-row">
          <label for="mQty">Qty</label>
          <input id="mQty" class="input" type="number" />
        </div>
      </div>

      <div class="m-row">
        <label for="mNotes">Notes</label>
        <textarea id="mNotes" class="input full" rows="3" style="resize:vertical"></textarea>
      </div>
    </div>
    <div class="m-actions">
      <button id="deleteBtn" class="btn danger">Delete</button>
      <button id="saveBtn" class="btn btn--brand">Save</button>
    </div>
  </dialog>

  <script>
    // ====== CONFIG / STATE ====================================================
    const API = '/api';
    const XUSER = (localStorage.getItem('x-user') || '').trim() || 'shane.yaroli';
    document.getElementById('who').textContent = `user: ${XUSER}`;
    const headers = {'Content-Type':'application/json','x-user':XUSER};

    let data = [];
    let filtered = [];
    let editingPart = null;
    let modalMode = 'edit';   // <-- keep SINGLE declaration (fix for the duplicate error)

    // ====== HELPERS ===========================================================
    const $ = (id) => document.getElementById(id);
    function smart(v, ...alts){ for(const k of [v, ...alts]) if(k !== undefined && k !== null) return k; return ''; }
    function matchFilter(row, q){
      if(!q) return true;
      q = q.toLowerCase();
      return (row.partNumber||'').toLowerCase().includes(q)
          || (row.printName||'').toLowerCase().includes(q)
          || (row.location||'').toLowerCase().includes(q)
          || (row.notes||'').toLowerCase().includes(q);
    }
    function normalizeItem(it){
      return {
        partNumber: smart(it.partNumber, it.part_number, it.part),
        printName: smart(it.printName, it.print_name, it.description, ''),
        location: smart(it.location, ''),
        qty: Number(smart(it.qty, it.quantity, 0)),
        notes: smart(it.notes, '')
      };
    }

    // ====== RENDER ============================================================
    function render(){
      const tbody = $('tbody');
      tbody.innerHTML = '';
      const onlyNZ = $('onlyNonZero').checked;
      const onlyZ  = $('onlyZero').checked;
      const q = $('filter').value.trim().toLowerCase();

      filtered = data.filter(r => matchFilter(r, q))
                     .filter(r => onlyNZ ? r.qty !== 0 : true)
                     .filter(r => onlyZ ? r.qty === 0 : true);

      $('count').textContent = `${filtered.length} items`;

      for(const row of filtered){
        const tr = document.createElement('tr');

        // Part Number
        const tdPN = document.createElement('td'); tdPN.className='col-num';
        const a = document.createElement('a'); a.href = `/inv/${row.partNumber}`; a.textContent = row.partNumber; tdPN.appendChild(a);
        tr.appendChild(tdPN);

        // Print
        const tdPrint = document.createElement('td'); tdPrint.className='col-print';
        tdPrint.textContent = row.printName || '—';
        tr.appendChild(tdPrint);

        // Location
        const tdLoc = document.createElement('td'); tdLoc.className='col-loc';
        tdLoc.textContent = row.location || '—';
        tr.appendChild(tdLoc);

        // Qty
        const tdQty = document.createElement('td'); tdQty.className='col-qty';
        tdQty.textContent = row.qty;
        tr.appendChild(tdQty);

        // Adjust
        const tdAdj = document.createElement('td'); tdAdj.className='col-adjust';
        const adjWrap = document.createElement('div'); adjWrap.className='adjust';

        const delta = document.createElement('input'); delta.className='input delta'; delta.placeholder='+/-';
        adjWrap.appendChild(delta);

        const apply = document.createElement('button'); apply.className='pill pill--brand'; apply.textContent='Apply';
        apply.addEventListener('click', async () => {
          const n = Number(delta.value);
          if(!Number.isFinite(n) || n === 0) return;
          try{
            // adjust endpoint best-guess
            const res = await fetch(`${API}/inventory/${encodeURIComponent(row.partNumber)}/adjust`, {
              method:'POST', headers, body: JSON.stringify({ delta: n, note:'' })
            });
            if(!res.ok){
              // fall back to legacy endpoint if present
              const legacy = await fetch(`${API}/inventory-adjust`, {
                method:'POST', headers, body: JSON.stringify({ partNumber: row.partNumber, delta: n })
              });
              if(!legacy.ok) throw new Error('adjust failed');
            }
            await loadData();  // refresh
          }catch(err){
            alert('Failed to adjust: ' + err.message);
          }
        });
        adjWrap.appendChild(apply);

        const edit = document.createElement('button'); edit.className='pill pill--edit'; edit.textContent='Edit';
        edit.addEventListener('click', ()=> openEdit(row.partNumber));
        adjWrap.appendChild(edit);

        tdAdj.appendChild(adjWrap);
        tr.appendChild(tdAdj);

        // Notes
        const tdNotes = document.createElement('td'); tdNotes.className='col-notes';
        tdNotes.textContent = row.notes || '';
        tr.appendChild(tdNotes);

        tbody.appendChild(tr);
      }
    }

    // ====== DATA IO ===========================================================
    async function loadData(){
      $('count').textContent = 'loading…';
      try{
        const res = await fetch(`${API}/inventory-all`, {headers});
        if(!res.ok) throw new Error('load failed');
        const json = await res.json();
        data = (Array.isArray(json) ? json : json.items || []).map(normalizeItem);
      }catch(err){
        console.error(err);
        data = [];
      }
      render();
    }

    async function openEdit(partNumber){
      modalMode = 'edit';
      $('modalTitle').textContent = 'Edit Part';
      $('deleteBtn').style.display = '';

      try{
        const res = await fetch(`${API}/inventory/${encodeURIComponent(partNumber)}`, {headers});
        if(!res.ok) throw new Error('not found');
        const it = normalizeItem(await res.json());
        editingPart = it.partNumber;

        $('mPart').value  = it.partNumber;
        $('mPrint').value = it.printName;
        $('mLoc').value   = it.location;
        $('mQty').value   = it.qty;
        $('mNotes').value = it.notes;
      }catch(err){
        alert('Failed to open: ' + err.message);
        return;
      }
      $('editModal').showModal();
    }

    function openAdd(){
      modalMode = 'add';
      $('modalTitle').textContent = 'Add Part';
      $('deleteBtn').style.display = 'none';
      editingPart = null;

      $('mPart').value  = '';
      $('mPrint').value = '';
      $('mLoc').value   = '';
      $('mQty').value   = 0;
      $('mNotes').value = '';

      $('editModal').showModal();
    }

    async function saveModal(){
      const payload = {
        partNumber: $('mPart').value.trim(),
        printName:  $('mPrint').value.trim(),
        location:   $('mLoc').value.trim(),
        qty:        Number($('mQty').value || 0),
        notes:      $('mNotes').value
      };

      try{
        if(modalMode === 'add'){
          const res = await fetch(`${API}/inventory`, {method:'POST', headers, body: JSON.stringify(payload)});
          if(!res.ok) throw new Error('create failed');
        }else{
          // Allow clearing strings; send explicit empty values (no local fallback)
          const res = await fetch(`${API}/inventory/${encodeURIComponent(editingPart)}`, {
            method:'PUT', headers, body: JSON.stringify(payload)
          });
          if(!res.ok) throw new Error('save failed');
        }
        $('editModal').close();
        await loadData();
      }catch(err){
        alert('Failed to save: ' + err.message);
      }
    }

    async function deleteModal(){
      if(!editingPart) return;
      if(!confirm(`Delete ${editingPart}?`)) return;
      try{
        const res = await fetch(`${API}/inventory/${encodeURIComponent(editingPart)}`, {method:'DELETE', headers});
        if(!res.ok) throw new Error('delete failed');
        $('editModal').close();
        await loadData();
      }catch(err){
        alert('Failed to delete: ' + err.message);
      }
    }

    // ====== EVENTS ============================================================
    $('filter').addEventListener('input', render);
    $('onlyNonZero').addEventListener('change', e=>{
      if(e.target.checked) $('onlyZero').checked = false;
      render();
    });
    $('onlyZero').addEventListener('change', e=>{
      if(e.target.checked) $('onlyNonZero').checked = false;
      render();
    });

    $('addBtn').addEventListener('click', openAdd);
    $('saveBtn').addEventListener('click', saveModal);
    $('deleteBtn').addEventListener('click', deleteModal);
    $('closeModal').addEventListener('click', ()=> $('editModal').close());

    $('exportBtn').addEventListener('click', async ()=>{
      const rows = filtered.length ? filtered : data;
      const header = ['partNumber','printName','location','qty','notes'];
      const csv = [header.join(',')].concat(
        rows.map(r => header.map(k=>{
          const v = r[k] ?? '';
          return `"${String(v).replace(/"/g,'""')}"`;
        }).join(','))
      ).join('\n');

      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `inventory_export_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    // ====== START =============================================================
    loadData();
  </script>
</body>
</html>
