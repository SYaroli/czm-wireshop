<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CZM • Inventory</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    /* Brand bar (match assignments.html) */
    .brand-bar{background:#0f1114;border-bottom:4px solid #c30000}
    .brand-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:8px 12px}
    .brand-logo{display:flex;align-items:center;gap:10px;color:#fff;text-decoration:none}
    .brand-logo img{height:22px;opacity:.95}
    .brand-title{font-size:16px;margin:0;color:#fff}
    .brand-actions .navbtn{display:inline-block;background:#1a1c20;color:#bbb;padding:6px 12px;border-radius:10px;text-decoration:none;border:1px solid #3a3f44;font-weight:600;font-size:.9rem;margin-left:8px}
    .brand-actions .navbtn.active{background:#b30000;color:#fff;border-color:#ff4d4d}
    .brand-actions .navbtn:hover{background:#24272b;color:#fff}

    /* Page chrome */
    body{background:#eef0f3;margin:0}

    /* Card shell */
    .inventory-shell{max-width:1200px;margin:24px auto;background:#fff;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,.08);padding:0 0 12px}
    .inventory-header{padding:14px 16px 6px}
    .inventory-header h2{margin:0 0 6px;font-size:16px;font-weight:600}

    /* Filter toolbar */
    .filter-row{display:flex;flex-wrap:wrap;align-items:center;gap:10px}
    .filter-row input[type="text"]{flex:1;min-width:260px;height:32px;border:1px solid #cfd4da;border-radius:6px;padding:0 10px}
    .cb{display:flex;align-items:center;gap:8px;height:32px;padding:0 10px;border:1px solid #cfd4da;border-radius:6px;background:#f7f8fa;user-select:none}
    .cb input{margin:0;width:16px;height:16px}
    .toolbar-btn{background:#eee;border:1px solid #cfd4da;border-radius:6px;height:32px;padding:0 12px;font-size:13px;cursor:pointer}
    .toolbar-btn.red{background:#c30000;color:#fff;border-color:#a00000}
    #countLabel{font-size:12px;margin-left:auto;white-space:nowrap}

    /* Header row */
    .table-head{background:#0a0b0d;color:#fff;display:grid;grid-template-columns:150px 220px 100px 60px 280px 1fr;gap:0;padding:8px 16px;font-size:12px;font-weight:600;margin-top:12px}

    /* Data rows */
    .list-body .row{display:grid;grid-template-columns:150px 220px 100px 60px 280px 1fr;gap:0;padding:10px 16px;border-bottom:1px solid #eef2f6;background:#fff;align-items:center}
    .list-body .row:nth-child(odd){background:#fafbfc}
    .notes-cell{font-size:12px;color:#333;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Adjust + actions */
    .adjust-controls{display:flex;align-items:center;gap:10px;flex-wrap:nowrap}
    .qty-input{width:76px;border:1px solid #d0d3d8;border-radius:20px;height:30px;padding:0 8px;text-align:center}
    .apply-btn{background:#b70000;color:#fff;border:none;border-radius:6px;height:32px;min-width:64px;padding:0 10px;cursor:pointer}
    .edit-btn{background:#3a3a3a;color:#fff;border:none;border-radius:6px;height:32px;min-width:64px;padding:0 10px;cursor:pointer}
    .muted{color:#9aa3ad;font-size:12px}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:#122032;color:#fff;padding:16px;width:420px;border-radius:8px;box-shadow:0 8px 20px rgba(0,0,0,.4)}
    .modal h3{margin:0 0 10px;font-size:18px}
    .modal label{display:block;font-size:12px;margin-top:8px;margin-bottom:4px}
    .modal input,.modal textarea{width:100%;border:none;border-radius:6px;height:34px;padding:6px 8px;outline:none;font-size:14px;color:#000}
    .modal textarea{height:90px;resize:vertical}
    .modal-actions{margin-top:14px;display:flex;gap:10px;justify-content:flex-end}
    .btn-small{border:none;border-radius:6px;padding:6px 14px;cursor:pointer}
    .btn-red{background:#c30000;color:#fff}
    .btn-gray{background:#c5c5c5;color:#000}

    @media (max-width:900px){
      .inventory-shell{max-width:100%;margin:0;border-radius:0;box-shadow:none}
      .table-head,.list-body .row{grid-template-columns:140px 1fr 90px 60px 240px}
      .notes-cell{grid-column:1 / -1;margin-top:4px}
    }
  </style>
</head>
<body>
  <!-- Top navigation -->
  <div class="brand-bar">
    <div class="brand-inner">
      <a class="brand-logo" href="/dashboard.html">
        <img src="/czm-logo.png" alt="CZM">
        <h1 class="brand-title">CZM • Inventory</h1>
      </a>
      <div class="brand-actions">
        <a class="navbtn" href="/dashboard.html">Dashboard</a>
        <a class="navbtn" href="/assignments.html">Assignment</a>
        <a class="navbtn active" href="/inventory">Inventory</a>
        <a class="navbtn" href="/archive.html">Archive</a>
        <a id="adminNavBtn" class="navbtn" href="/admin.html">Admin</a>
        <button id="logoutBtn" class="navbtn">Logout</button>
      </div>
    </div>
  </div>

  <div class="inventory-shell">
    <div class="inventory-header">
      <h2>Inventory — Snapshot</h2>
      <div class="filter-row">
        <input id="filterBox" type="text" placeholder="part number, print name, or location" />
        <label class="cb"><input id="cbNonZero" type="checkbox"><span>only non-zero</span></label>
        <label class="cb"><input id="cbOnlyZero" type="checkbox"><span>only 0-qty</span></label>
        <button id="exportBtn" class="toolbar-btn">Export</button>
        <button id="addBtn" class="toolbar-btn red">Add part</button>
        <span id="countLabel">0 items</span>
      </div>
    </div>

    <div class="table-head">
      <div>Part Number</div><div>Print Name</div><div>Location</div><div>Qty</div><div>Adjust</div><div>Notes</div>
    </div>
    <div id="listBody" class="list-body"></div>
  </div>

  <div id="editModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <h3 id="modalTitle">Edit Part</h3>
      <label for="mPart">Part Number</label><input id="mPart" readonly />
      <label for="mDesc">Description</label><input id="mDesc" />
      <label for="mLoc">Location</label><input id="mLoc" />
      <label for="mQty">Qty</label><input id="mQty" type="number" />
      <label for="mNotes">Notes</label><textarea id="mNotes"></textarea>
      <div class="modal-actions">
        <button id="saveBtn" class="btn-small btn-red">Save</button>
        <button id="cancelBtn" class="btn-small btn-gray">Cancel</button>
        <button id="deleteBtn" class="btn-small btn-gray" style="margin-left:auto;">Delete</button>
      </div>
    </div>
  </div>

  <!-- Data sources -->
  <script src="/catalog.js"></script>
  <script>
    const API_BASE = 'https://wireshop-backend.onrender.com/api';

    function getUser(){
      try{ return JSON.parse(localStorage.getItem('user')||'null'); }catch{ return null; }
    }
    const currentUser = getUser();
    if (!currentUser || !currentUser.username) window.location.href = '/index.html';

    const isAdmin = String(currentUser.role || '').toLowerCase() === 'admin';
    const adminNavBtn = document.getElementById('adminNavBtn');
    if (adminNavBtn) adminNavBtn.style.display = isAdmin ? 'inline-block' : 'none';

    document.getElementById('logoutBtn')?.addEventListener('click', ()=>{
      localStorage.removeItem('user');
      location.href = '/index.html';
    });

    const listBody = document.getElementById('listBody');
    const filterBox = document.getElementById('filterBox');
    const countLabel = document.getElementById('countLabel');
    const cbNonZero = document.getElementById('cbNonZero');
    const cbOnlyZero = document.getElementById('cbOnlyZero');
    const editModalBackdrop = document.getElementById('editModalBackdrop');
    const addBtn = document.getElementById('addBtn');

    let ALL_ROWS = [];
    let DB_ROWS = {};
    let modalMode = 'edit';
    let editingPart = null;

    // Admin-only controls
    addBtn.style.display = isAdmin ? 'inline-block' : 'none';
    document.getElementById('deleteBtn').style.display = isAdmin ? 'inline-block' : 'none';

    function userHeader(){
      return currentUser.username;
    }

    async function loadData(){
      const invRes = await fetch(API_BASE+'/inventory-all', { headers:{'x-user': userHeader()} });
      const invData = await invRes.json();
      DB_ROWS = {}; invData.forEach(r => DB_ROWS[r.partNumber]=r);

      const cat = Array.isArray(window.catalog) ? window.catalog : [];
      const merged = [];

      cat.forEach(c=>{
        const db = DB_ROWS[c.partNumber];
        if(db){
          merged.push({
            partNumber: db.partNumber,
            description: db.description ?? c.printName ?? '',
            printName: db.description ?? c.printName ?? '',
            location: db.location ?? (c.location||''),
            qty: typeof db.qty === 'number' ? db.qty : 0,
            notes: db.notes ?? (c.notes||'')
          });
        }else{
          merged.push({
            partNumber: c.partNumber,
            description: c.printName||'',
            printName: c.printName||'',
            location: c.location||'',
            qty: 0,
            notes: c.notes||''
          });
        }
      });

      invData.forEach(db=>{
        if(!cat.find(c=>c.partNumber===db.partNumber)){
          merged.push({
            partNumber: db.partNumber,
            description: db.description ?? '',
            printName: db.description ?? '',
            location: db.location ?? '',
            qty: typeof db.qty === 'number' ? db.qty : 0,
            notes: db.notes ?? ''
          });
        }
      });

      merged.sort((a,b)=>(a.partNumber||'').localeCompare(b.partNumber||''));
      ALL_ROWS = merged;
      renderList();
    }

    function renderList(){
      const filter = filterBox.value.trim().toLowerCase();
      const onlyNZ = cbNonZero.checked;
      const onlyZ = cbOnlyZero.checked;

      listBody.innerHTML=''; let shown=0;

      ALL_ROWS.forEach(r=>{
        const hay = `${r.partNumber} ${r.printName} ${r.location} ${r.notes||''}`.toLowerCase();
        if(filter && !hay.includes(filter)) return;

        const qty = Number(r.qty||0);
        if(onlyNZ && qty===0) return;
        if(onlyZ && qty!==0) return;

        shown++;
        const row = document.createElement('div');
        row.className='row';

        const adjCell = document.createElement('div');
        adjCell.className='adjust-controls';

        if(isAdmin){
          const input = document.createElement('input');
          input.className='qty-input';
          input.type='number';
          input.placeholder='qty';
          input.value='';

          const apply = document.createElement('button');
          apply.className='apply-btn';
          apply.textContent='Apply';
          apply.addEventListener('click', ()=>applyAdjust(r.partNumber, input.value));

          const edit = document.createElement('button');
          edit.className='edit-btn';
          edit.textContent='Edit';
          edit.addEventListener('click', ()=>openEdit(r.partNumber));

          adjCell.appendChild(input);
          adjCell.appendChild(apply);
          adjCell.appendChild(edit);
        }else{
          const muted = document.createElement('div');
          muted.className='muted';
          muted.textContent='—';
          adjCell.appendChild(muted);
        }

        row.innerHTML = `
          <div><a class="part-link" href="/inv/${encodeURIComponent(r.partNumber)}" target="_blank">${r.partNumber}</a></div>
          <div>${escapeHtml(r.printName||'')}</div>
          <div>${escapeHtml(r.location||'')}</div>
          <div>${qty}</div>
        `;
        row.appendChild(adjCell);

        const notes = document.createElement('div');
        notes.className='notes-cell';
        notes.title = r.notes || '';
        notes.textContent = r.notes || '';
        row.appendChild(notes);

        listBody.appendChild(row);
      });

      countLabel.textContent = `${shown} items`;
    }

    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    async function applyAdjust(partNumber, newQty){
      if(!isAdmin) return;
      const qty = Number(newQty);
      if(!Number.isFinite(qty)) return alert('Enter a number.');
      const res = await fetch(API_BASE+'/inventory/adjust', {
        method:'POST',
        headers:{'Content-Type':'application/json','x-user': userHeader()},
        body: JSON.stringify({ partNumber, qty })
      });
      if(!res.ok) return alert('Adjust failed');
      await loadData();
    }

    function openEdit(partNumber){
      if(!isAdmin) return;
      modalMode = 'edit';
      editingPart = partNumber;
      const row = DB_ROWS[partNumber] || ALL_ROWS.find(x=>x.partNumber===partNumber) || {};
      document.getElementById('modalTitle').textContent = 'Edit Part';
      document.getElementById('mPart').value = partNumber || '';
      document.getElementById('mPart').readOnly = true;
      document.getElementById('mDesc').value = row.description ?? row.printName ?? '';
      document.getElementById('mLoc').value = row.location ?? '';
      document.getElementById('mQty').value = Number(row.qty ?? 0);
      document.getElementById('mNotes').value = row.notes ?? '';
      document.getElementById('deleteBtn').style.display = 'inline-block';
      editModalBackdrop.style.display='flex';
    }

    function openAdd(){
      if(!isAdmin) return;
      modalMode = 'add';
      editingPart = null;
      document.getElementById('modalTitle').textContent = 'Add Part';
      document.getElementById('mPart').value = '';
      document.getElementById('mPart').readOnly = false;
      document.getElementById('mDesc').value = '';
      document.getElementById('mLoc').value = '';
      document.getElementById('mQty').value = 0;
      document.getElementById('mNotes').value = '';
      document.getElementById('deleteBtn').style.display = 'none';
      editModalBackdrop.style.display='flex';
    }

    async function saveModal(){
      if(!isAdmin) return;
      const partNumber = document.getElementById('mPart').value.trim();
      const description = document.getElementById('mDesc').value.trim();
      const location = document.getElementById('mLoc').value.trim();
      const qty = Number(document.getElementById('mQty').value || 0);
      const notes = document.getElementById('mNotes').value.trim();

      if(!partNumber) return alert('Part number required.');

      const url = modalMode === 'add' ? API_BASE+'/inventory/add' : API_BASE+'/inventory/edit';
      const payload = { partNumber, description, location, qty, notes };

      const res = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json','x-user': userHeader()},
        body: JSON.stringify(payload)
      });
      if(!res.ok) return alert('Save failed');
      closeModal();
      await loadData();
    }

    async function deleteModal(){
      if(!isAdmin) return;
      const partNumber = document.getElementById('mPart').value.trim();
      if(!partNumber) return;
      if(!confirm(`Delete ${partNumber}?`)) return;

      const res = await fetch(API_BASE+'/inventory/delete', {
        method:'POST',
        headers:{'Content-Type':'application/json','x-user': userHeader()},
        body: JSON.stringify({ partNumber })
      });
      if(!res.ok) return alert('Delete failed');
      closeModal();
      await loadData();
    }

    function closeModal(){
      editModalBackdrop.style.display='none';
    }

    async function exportCsv(){
      const res = await fetch(API_BASE+'/inventory/export', { headers:{'x-user': userHeader()} });
      if(!res.ok) return alert('Export endpoint not available');
      const blob = await res.blob();
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='inventory.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // events
    filterBox.addEventListener('input', renderList);
    cbNonZero.addEventListener('change', ()=>{ if(cbNonZero.checked) cbOnlyZero.checked=false; renderList(); });
    cbOnlyZero.addEventListener('change', ()=>{ if(cbOnlyZero.checked) cbNonZero.checked=false; renderList(); });
    document.getElementById('exportBtn').addEventListener('click', exportCsv);

    addBtn.addEventListener('click', openAdd);
    document.getElementById('cancelBtn').addEventListener('click', closeModal);
    document.getElementById('saveBtn').addEventListener('click', saveModal);
    document.getElementById('deleteBtn').addEventListener('click', deleteModal);
    editModalBackdrop.addEventListener('click', (e)=>{ if(e.target===editModalBackdrop) closeModal(); });

    loadData().catch(err=>{ console.error(err); alert('Inventory load failed'); });
  </script>
</body>
</html>
