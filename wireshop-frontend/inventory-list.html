<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CZM • Inventory List</title>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    /* --- original look preserved --- */
    .brand-actions .navbtn{display:inline-block;background:#1a1c20;color:#bbb;padding:6px 12px;border-radius:10px;text-decoration:none;border:1px solid #3a3f44;font-weight:600;font-size:.9rem;margin-left:8px}
    .brand-actions .navbtn.active{background:#b30000;color:#fff;border-color:#ff4d4d}
    .toolbar{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px}
    .badge{background:#eee;border:1px solid #ddd;border-radius:8px;padding:4px 8px;font-weight:700}
    .qtycell{font-weight:900;text-align:right}
    .row-actions{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .row-actions input[type=number]{width:84px;padding:6px;border:1px solid #d3d8e1;border-radius:10px}
    .apply{padding:6px 14px;border:1px solid #b30000;border-radius:10px;background:#b30000;color:#fff;font-weight:800;cursor:pointer;}
    .edit{padding:6px 14px;border:1px solid #444;border-radius:10px;background:#444;color:#fff;font-weight:800;cursor:pointer;}
    .notes-cell{min-width:425px;word-break:break-word}
    #editModalBg{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:999;}
    #editModal{background:#18222e;padding:16px;border-radius:6px;width:360px;box-shadow:0 4px 20px rgba(0,0,0,.5);}
    #editModal h2{margin-top:0;font-size:16px;color:#fff;}
    #editModal label{display:block;font-size:12px;margin-bottom:2px;color:#fff;}
    .form-row{margin-bottom:8px;}
    .form-row input,.form-row textarea{width:100%;padding:6px;background:#101820;border:1px solid #444;color:#fff;border-radius:6px;font-size:13px;}
    .actions{display:flex;gap:6px;}
    .status{margin-left:8px;color:#888;font-weight:600}
    .sticky-head thead th{position:sticky;top:0;background:#fff}
    @media (max-width:900px){
      .notes-cell{min-width:260px}
    }
  </style>
</head>
<body>
  <div class="brand-bar">
    <div class="brand-inner">
      <a class="brand-logo" href="/dashboard.html">
        <img src="/czm-logo.png" alt="CZM">
        <h1 class="brand-title">CZM • Inventory</h1>
      </a>
      <div class="brand-actions">
        <a class="navbtn" href="/dashboard.html">Dashboard</a>
        <a class="navbtn" href="/assignments.html">Build Next</a>
        <a class="navbtn active" href="/inventory">Inventory</a>
        <a class="navbtn" href="/archive.html">Archive</a>
        <a class="navbtn" href="/admin.html">Admin</a>
        <button id="logoutBtn" class="navbtn">Logout</button>
      </div>
    </div>
  </div>

  <main class="page">
    <div class="card">
      <h2>Inventory — Snapshot</h2>
      <div class="toolbar">
        <div style="flex:1">
          <label for="q">Filter</label>
          <input id="q" type="text" placeholder="part number, print name, or location">
        </div>
        <div style="display:flex;align-items:end;gap:10px">
          <label class="badge"><input type="checkbox" id="onlyNonZero"> only non-zero</label>
          <label class="badge"><input type="checkbox" id="onlyZero"> only 0-qty</label>
          <button id="exportBtn" class="badge">Export</button>
          <button id="addPartBtn" class="badge" style="display:none;">Add part</button>
          <span class="badge" id="countBadge">0 items</span>
          <span class="status" id="status">Loading…</span>
        </div>
      </div>

      <table class="sticky-head" id="tbl">
        <thead>
          <tr>
            <th style="width:210px">Part Number</th>
            <th>Print Name</th>
            <th style="width:180px">Location</th>
            <th style="width:90px;text-align:right">Qty</th>
            <th style="min-width:300px">Adjust</th>
            <th style="min-width:425px">Notes</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>

  <!-- Modal (kept from original look) -->
  <div id="editModalBg">
    <div id="editModal">
      <h2 id="modalTitle">Edit Part</h2>
      <div class="form-row">
        <label for="mPartNumber">Part Number</label>
        <input id="mPartNumber" type="text" />
      </div>
      <div class="form-row">
        <label for="mPrintName">Print Name</label>
        <input id="mPrintName" type="text" />
      </div>
      <div class="form-row">
        <label for="mLocation">Location</label>
        <input id="mLocation" type="text" />
      </div>
      <div class="form-row">
        <label for="mQty">Qty</label>
        <input id="mQty" type="number" />
      </div>
      <div class="form-row">
        <label for="mNotes">Notes</label>
        <textarea id="mNotes" rows="2"></textarea>
      </div>
      <div class="actions">
        <button class="apply" id="saveBtn">Save</button>
        <button class="apply" style="background:#444" id="cancelBtn">Cancel</button>
        <button class="apply" style="margin-left:auto;background:#444" id="deleteBtn">Delete</button>
      </div>
    </div>
  </div>

  <script src="/catalog.js"></script>
  <script>
    // ====== CONFIG ============================================================
    const API_ROOT = ''; // relative to same origin, e.g. /api
    const API_BASE = (API_ROOT || '') + '/api';
    const userHeader = (localStorage.getItem('x-user') || (JSON.parse(localStorage.getItem('user')||'{}').username) || 'shane.yaroli');
    const headers = {'Content-Type':'application/json','x-user': userHeader};

    // login check (keep original behavior)
    const user = (()=>{try{return JSON.parse(localStorage.getItem('user')||'{}');}catch{return{};}})();
    if(!user||!user.username) {
      // fall back to x-user header only; don't hard redirect if you use header-only auth
      // window.location.href='/index.html';
    }
    document.getElementById('logoutBtn').onclick=()=>{localStorage.removeItem('user');window.location.href='/index.html';};

    const ADMIN_USERS = ['shane','admin','shane.yaroli','Shane.Yaroli','Tyler.Ellis','tyler.ellis','tyler'];
    const isAdmin = ADMIN_USERS.map(x=>x.toLowerCase()).includes((userHeader||'').toLowerCase());
    if(isAdmin)document.getElementById('addPartBtn').style.display='';

    const tbody = document.getElementById('tbody');
    const qEl = document.getElementById('q');
    const onlyNonZeroEl = document.getElementById('onlyNonZero');
    const onlyZeroEl = document.getElementById('onlyZero');
    const countBadge = document.getElementById('countBadge');
    const statusEl = document.getElementById('status');

    let rows = [];
    const esc = s => String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

    async function api(path,opts={}) {
      const res = await fetch(API_BASE+path,{
        method:opts.method||'GET',
        headers,
        body:opts.body?JSON.stringify(opts.body):undefined
      });
      if(!res.ok) {
        const text = await res.text();
        throw new Error(text || ('HTTP '+res.status));
      }
      return res.json();
    }

    // ====== LOAD & MERGE CATALOG + DB ========================================
    function normalize(it){
      return {
        partNumber: String(it.partNumber ?? it.part ?? '').trim(),
        printName:  String(it.printName ?? it.description ?? '').trim(),
        location:   String(it.location ?? '').trim(),
        notes:      (it.notes == null || String(it.notes).trim().toLowerCase() === 'nan') ? '' : String(it.notes),
        qty:        Number(it.qty ?? it.quantity ?? 0) | 0
      };
    }

    async function load() {
      statusEl.textContent = 'Loading…';

      const snap = await api('/inventory-all');
      const inv = Array.isArray(snap) ? snap : (snap.items || []);
      const invMap = new Map(inv.map(x=>{
        const n = normalize(x);
        return [n.partNumber, n];
      }));

      // merge in catalog.js so you see items not yet in DB
      const catalog = (window.catalog||[]).map(c=>normalize({
        partNumber: c.partNumber,
        printName:  c.printName,
        location:   c.location,
        notes:      c.notes,
        qty:        0
      })).filter(r=>r.partNumber);

      const merged = [];
      for(const r of catalog){
        const s = invMap.get(r.partNumber);
        if(s){ invMap.delete(r.partNumber); merged.push({...r, ...s}); }
        else  { merged.push(r); }
      }
      // any extras that exist only in DB
      for(const [pn, s] of invMap){
        merged.push(s);
      }

      rows = merged.sort((a,b)=>a.partNumber.localeCompare(b.partNumber,undefined,{numeric:true}));
      build();
      statusEl.textContent = `Loaded ${rows.length} items`;
    }

    // ====== RENDER ============================================================
    function build() {
      const q = qEl.value.trim().toLowerCase();
      const onlyNZ = onlyNonZeroEl.checked;
      const onlyZ  = onlyZeroEl.checked;

      const filtered = rows.filter(r=>{
        if (onlyZ  && (r.qty|0) !== 0) return false;
        if (onlyNZ && (r.qty|0) === 0) return false;
        if (!q) return true;
        return (
          (r.partNumber||'').toLowerCase().includes(q) ||
          (r.printName||'').toLowerCase().includes(q) ||
          (r.location||'').toLowerCase().includes(q)   ||
          (r.notes||'').toLowerCase().includes(q)
        );
      });

      countBadge.textContent = `${filtered.length} items`;
      tbody.innerHTML = filtered.map(r=>`
        <tr data-pn="${esc(r.partNumber)}">
          <td><a href="/inv/${encodeURIComponent(r.partNumber)}" target="_blank">${esc(r.partNumber)}</a></td>
          <td>${esc(r.printName||'')}</td>
          <td>${esc(r.location||'')}</td>
          <td class="qtycell">${r.qty|0}</td>
          <td>
            <div class="row-actions">
              <input type="number" class="customDelta" placeholder="+/−">
              <button class="apply" data-action="apply">Apply</button>
              ${isAdmin ? `<button class="edit" data-edit="${esc(r.partNumber)}">Edit</button>` : ''}
            </div>
          </td>
          <td class="notes-cell"><span title="${esc(r.notes||'')}">${esc(r.notes||'')}</span></td>
        </tr>
      `).join('');
    }

    // ====== EVENTS: TABLE =====================================================
    tbody.addEventListener('click', async e=>{
      const editBtn = e.target.closest('button[data-edit]');
      if (editBtn) return openEdit(editBtn.getAttribute('data-edit'), false);

      const applyBtn = e.target.closest('button[data-action="apply"]');
      if (!applyBtn) return;
      const tr = e.target.closest('tr');
      const pn = tr?.dataset?.pn;
      if (!pn) return;
      const inp = tr.querySelector('input.customDelta');
      let delta = parseInt(inp?.value||'0', 10);
      if (!Number.isInteger(delta) || delta === 0) return;
      inp.value = '';
      const r = rows.find(x=>x.partNumber===pn);
      try{
        // Preferred: delta adjust
        let res = await fetch(`${API_BASE}/inventory/${encodeURIComponent(pn)}/adjust`, {
          method:'POST', headers, body: JSON.stringify({ delta, note:'' })
        });
        if(!res.ok){
          // Legacy: aggregate adjust endpoint
          res = await fetch(`${API_BASE}/inventory-adjust`, {
            method:'POST', headers, body: JSON.stringify({ partNumber: pn, delta })
          });
          if(!res.ok){
            // Fallback: absolute qty set
            const newQty = (r.qty|0) + delta;
            res = await fetch(`${API_BASE}/inventory/${encodeURIComponent(pn)}/qty`, {
              method:'POST', headers, body: JSON.stringify({ qty: newQty })
            });
            if(!res.ok) throw new Error('adjust failed');
          }
        }
        await load();
      }catch(err){
        alert('Failed to adjust: ' + err.message);
      }
    });

    qEl.oninput = build;
    onlyNonZeroEl.onchange = () => { if(onlyNonZeroEl.checked) onlyZeroEl.checked = false; build(); };
    onlyZeroEl.onchange = () => { if(onlyZeroEl.checked) onlyNonZeroEl.checked = false; build(); };

    // ====== MODAL LOGIC =======================================================
    const modalBg = document.getElementById('editModalBg');
    const mPartNumber = document.getElementById('mPartNumber');
    const mPrintName  = document.getElementById('mPrintName');
    const mLocation   = document.getElementById('mLocation');
    const mQty        = document.getElementById('mQty');
    const mNotes      = document.getElementById('mNotes');
    const modalTitle  = document.getElementById('modalTitle');
    let isNew = false;

    function openEdit(pn, createNew) {
      isNew = !!createNew;
      if (isNew) {
        modalTitle.textContent = 'Add Part';
        mPartNumber.readOnly = false;
        mPartNumber.value = '';
        mPrintName.value = '';
        mLocation.value = '';
        mQty.value = 0;
        mNotes.value = '';
        modalBg.style.display = 'flex';
        return;
      }
      const row = rows.find(r=>r.partNumber===pn);
      if (!row) return;
      modalTitle.textContent = 'Edit Part';
      mPartNumber.readOnly = true;
      mPartNumber.value = row.partNumber;
      mPrintName.value = row.printName||'';
      mLocation.value = row.location||'';
      mQty.value = row.qty||0;
      mNotes.value = row.notes||'';
      modalBg.style.display = 'flex';
    }

    document.getElementById('addPartBtn').onclick = () => openEdit('', true);
    document.getElementById('cancelBtn').onclick = () => modalBg.style.display = 'none';

    document.getElementById('saveBtn').onclick = async () => {
      const part = mPartNumber.value.trim();
      if (!part) return alert('Part number required.');
      const payload = {
        partNumber: part,
        printName:  mPrintName.value,
        location:   mLocation.value,
        qty:        Number(mQty.value)||0,
        notes:      mNotes.value
      };

      try {
        if (isNew) {
          await api(`/inventory`, { method:'POST', body: payload });
        } else {
          const put = await fetch(`${API_BASE}/inventory/${encodeURIComponent(part)}`, {
            method:'PUT', headers, body: JSON.stringify(payload)
          });
          if(!put.ok) throw new Error('save failed');
        }
      } catch (err) {
        alert('Failed to save: ' + err.message);
        return;
      }

      modalBg.style.display = 'none';
      load();
    };

    document.getElementById('deleteBtn').onclick = async () => {
      const part = mPartNumber.value.trim();
      if (!part || !confirm(`Delete ${part}?`)) return;
      try {
        const res = await fetch(`${API_BASE}/inventory/${encodeURIComponent(part)}`, {method:'DELETE', headers});
        if(!res.ok) throw new Error('delete failed');
      } catch (err) {
        alert('Failed to delete: ' + err.message);
        return;
      }
      modalBg.style.display = 'none';
      load();
    };

    // ====== EXPORT ============================================================
    document.getElementById('exportBtn').addEventListener('click', async ()=>{
      // Export filtered view if active; else all rows
      const q = qEl.value.trim().toLowerCase();
      const onlyNZ = onlyNonZeroEl.checked;
      const onlyZ  = onlyZeroEl.checked;
      const rowsOut = rows.filter(r=>{
        if (onlyZ  && (r.qty|0) !== 0) return false;
        if (onlyNZ && (r.qty|0) === 0) return false;
        if (!q) return true;
        return (
          (r.partNumber||'').toLowerCase().includes(q) ||
          (r.printName||'').toLowerCase().includes(q) ||
          (r.location||'').toLowerCase().includes(q)   ||
          (r.notes||'').toLowerCase().includes(q)
        );
      });

      const header = ['partNumber','printName','location','qty','notes'];
      const csv = [header.join(',')].concat(
        rowsOut.map(r => header.map(k=>`"${String(r[k] ?? '').replace(/"/g,'""')}"`).join(','))
      ).join('\\n');

      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `inventory_export_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    // ====== START =============================================================
    load().catch(()=>statusEl.textContent='Failed to load');
  </script>
</body>
</html>
