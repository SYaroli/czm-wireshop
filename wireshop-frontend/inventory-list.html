<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CZM • Build Next</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    /* Layout tweaks specific to assignments page */
    .page-shell{max-width:1200px;margin:0 auto;padding:16px}
    .header-row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .filters-row{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .filters-row select,
    .filters-row input{min-width:150px}
    .summary-pill{font-size:0.8rem;padding:4px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.6);color:#e5e7eb;background:rgba(15,23,42,.9)}
    .summary-pill strong{color:#f97316}
    .table-wrap{margin-top:8px}
    .qtyDone{width:60px}
    .text-right{text-align:right}
    .muted{color:#9ca3af;font-size:0.8rem}
    .btn-link{background:none;border:none;color:#93c5fd;text-decoration:underline;cursor:pointer;font-size:0.8rem;padding:0}
    .badge{display:inline-block;padding:2px 6px;border-radius:999px;font-size:0.7rem}
    .badge-pri1{background:#064e3b;color:#bbf7d0}
    .badge-pri2{background:#1e3a8a;color:#bfdbfe}
    .badge-pri3{background:#7f1d1d;color:#fecaca}
    .brand-bar{background:#0f1114;border-bottom:4px solid #c30000}
    .brand-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:10px 16px}
    .brand-left{display:flex;align-items:center;gap:10px}
    .brand-logo{width:38px;height:38px;border-radius:50%;background:#c30000;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:0.9rem;box-shadow:0 0 14px rgba(220,38,38,.8)}
    .brand-title{font-size:0.95rem;font-weight:600;letter-spacing:.08em;color:#e5e7eb;text-transform:uppercase}
    .brand-sub{font-size:0.75rem;color:#9ca3af}
    .brand-nav{display:flex;align-items:center;gap:8px}
    .brand-btn{padding:6px 12px;border-radius:999px;border:1px solid rgba(148,163,184,.6);background:#020617;color:#e5e7eb;font-size:0.75rem;font-weight:500;cursor:pointer;letter-spacing:.05em;text-transform:uppercase}
    .brand-btn.primary{background:#c30000;border-color:#fecaca;color:#fee2e2;box-shadow:0 0 12px rgba(248,113,113,.7)}
    .brand-btn.logout{border-color:#fecaca;color:#fecaca}
    .brand-user{font-size:0.8rem;color:#9ca3af;padding:4px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.4);background:#020617}
    .status-bar{font-size:0.8rem;margin-top:4px;color:#9ca3af}
    .status-bar strong{color:#e5e7eb}
    .chip{display:inline-flex;align-items:center;gap:4px;padding:3px 7px;border-radius:999px;border:1px solid rgba(148,163,184,.6);font-size:0.75rem;color:#e5e7eb;background:rgba(15,23,42,.9)}
    .chip-dot{width:7px;height:7px;border-radius:999px;background:#22c55e;box-shadow:0 0 8px rgba(34,197,94,.9)}
    @media (max-width:768px){
      .brand-inner{flex-direction:column;align-items:flex-start;gap:8px}
      .header-row{flex-direction:column;align-items:flex-start}
      .filters-row{flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>
  <div class="brand-bar">
    <div class="brand-inner">
      <div class="brand-left">
        <div class="brand-logo">CZM</div>
        <div>
          <div class="brand-title">WireShop</div>
          <div class="brand-sub">Build Next • Assignments</div>
        </div>
      </div>
      <div class="brand-nav">
        <button class="brand-btn primary" onclick="location.href='assignments.html'">Build Next</button>
        <button class="brand-btn" onclick="location.href='inventory.html'">Inventory</button>
        <button class="brand-btn" onclick="location.href='inventory-list.html'">Inventory List</button>
        <button class="brand-btn logout" id="logoutBtn">Logout</button>
        <div class="brand-user" id="userLabel">User: -</div>
      </div>
    </div>
  </div>

  <div class="page-shell">
    <div class="header-row">
      <div>
        <h1>Build Queue</h1>
        <div class="status-bar">
          <span id="statusText">Loading assignments…</span>
        </div>
      </div>
      <div class="summary-pill">
        Open: <strong id="openCount">0</strong> • In Progress: <strong id="inProgCount">0</strong> • Completed (today): <strong id="doneCount">0</strong>
      </div>
    </div>

    <div class="filters-row">
      <select id="filterMachine">
        <option value="">All machines</option>
      </select>
      <select id="filterStatus">
        <option value="">All statuses</option>
        <option value="open">Open</option>
        <option value="inprogress">In progress</option>
        <option value="done">Completed</option>
      </select>
      <select id="filterPriority">
        <option value="">All priorities</option>
        <option value="1">Priority 1 (Hot)</option>
        <option value="2">Priority 2</option>
        <option value="3">Priority 3</option>
      </select>
      <input type="text" id="filterPart" placeholder="Filter by part number or description" />
      <button id="btnRefresh" class="brand-btn">Refresh</button>
      <button id="btnAdd" class="brand-btn">Add Job</button>
      <button id="clearDoneBtn" class="brand-btn">Clear Done</button>
      <button id="exportBtn" class="brand-btn">Export Done</button>
      <span class="chip">
        <span class="chip-dot"></span>
        Live from backend
      </span>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Machine</th>
            <th>Part</th>
            <th>Description</th>
            <th>Qty</th>
            <th>Priority</th>
            <th>Assigned</th>
            <th>Status</th>
            <th>Actions</th>
            <th class="text-right">Complete Qty</th>
          </tr>
        </thead>
        <tbody id="assignBody">
          <tr><td colspan="9" class="muted">Loading…</td></tr>
        </tbody>
      </table>
    </div>

    <p class="muted" id="lastUpdated"></p>
  </div>

  <script src="/users.js"></script>
  <script>
    const API_ROOT = (window.BACKEND_BASE || 'https://wireshop-backend.onrender.com') + '/api';

    let user = null;
    let isAdmin = false;
    let assignments = [];
    let machines = [];

    function readSession(){
      try{
        const raw = localStorage.getItem('wireShopSession');
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){
        return null;
      }
    }

    function ensureUser(){
      const session = readSession();
      if(!session || !session.username){
        location.href = 'index.html';
        return null;
      }
      return { username: session.username, role: session.role || '' };
    }

    function computeIsAdmin(u){
      if(!u) return false;
      const uname = String(u.username || u.name || u.user || '').trim();
      if(window.ADMIN_USERS && Array.isArray(window.ADMIN_USERS) && window.ADMIN_USERS.includes(uname)) return true;
      if(window.ADMINS && Array.isArray(window.ADMINS) && window.ADMINS.includes(uname)) return true;
      const FALLBACK = ['Shane.Yaroli','Tyler.Ellis'];
      return FALLBACK.includes(uname);
    }

    function setStatus(msg){
      document.getElementById('statusText').textContent = msg;
    }

    function updateCounts(){
      let open=0,inprog=0,done=0;
      const today = new Date().toDateString();
      assignments.forEach(a=>{
        if(a.status==='open') open++;
        else if(a.status==='inprogress') inprog++;
        else if(a.status==='done' && a.completedAt && new Date(a.completedAt).toDateString()===today) done++;
      });
      document.getElementById('openCount').textContent=open;
      document.getElementById('inProgCount').textContent=inprog;
      document.getElementById('doneCount').textContent=done;
    }

    function buildMachineOptions(){
      const sel = document.getElementById('filterMachine');
      const unique = Array.from(new Set(assignments.map(a=>a.machine).filter(Boolean))).sort();
      sel.innerHTML = '<option value="">All machines</option>' + unique.map(m=>`<option value="${m}">${m}</option>`).join('');
    }

    function esc(s){ return String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }
    function ts(ms){ if(!ms) return ''; return new Date(ms).toLocaleString(); }

    async function api(path, opts={}){
      const res = await fetch(API_ROOT + path, {
        method: opts.method || 'GET',
        headers: {
          'Content-Type':'application/json',
          'x-user': user.username,
          'x-role': String(user.role || '')
        },
        body: opts.body ? JSON.stringify(opts.body) : undefined
      });
      if (!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }

    const pnInput = document.getElementById('part');
    const qAdd = document.getElementById('qAdd');
    const prioritySel = document.getElementById('prioritySel');

    document.getElementById('btnAdd')?.addEventListener('click', async ()=>{
      const pn = (pnInput.value||'').trim();
      const qty = Number(qAdd.value||0);
      const pri = Number(prioritySel.value||0) | 0;
      if (!pn) return alert('Pick a part');
      if (!Number.isInteger(qty) || qty <= 0) return alert('Qty must be positive');
      try{
        await api('/build-tasks', { method:'POST', body:{ partNumber:pn, qty, priority:pri } });
        await refreshAll();
      }catch(e){
        alert('Add failed');
      }
    });

    function renderAssignments(){
      const tbody = document.getElementById('assignBody');
      const fMachine = document.getElementById('filterMachine').value;
      const fStatus = document.getElementById('filterStatus').value;
      const fPriority = document.getElementById('filterPriority').value;
      const fPart = document.getElementById('filterPart').value.toLowerCase();

      let rows = assignments.slice();

      if (fMachine) rows = rows.filter(r => r.machine === fMachine);
      if (fStatus) rows = rows.filter(r => r.status === fStatus);
      if (fPriority) rows = rows.filter(r => String(r.priority||'') === fPriority);
      if (fPart) {
        rows = rows.filter(r => {
          const text = (r.partNumber||'') + ' ' + (r.description||'');
          return text.toLowerCase().includes(fPart);
        });
      }

      if (!rows.length){
        tbody.innerHTML = '<tr><td colspan="9" class="muted">No assignments match the filters.</td></tr>';
        return;
      }

      tbody.innerHTML = rows.map(r=>{
        const priBadge = r.priority===1 ? 'badge-pri1' : r.priority===2 ? 'badge-pri2' : 'badge-pri3';
        const priLabel = r.priority===1 ? 'Hot' : r.priority===2 ? 'Normal' : 'Low';
        const statusLabel = r.status==='open' ? 'Open' :
                            r.status==='inprogress' ? 'In Progress' :
                            'Done';
        const canClaim = r.status==='open';
        const canStart = r.status==='open' && r.claimedBy===user.username;
        const canComplete = r.status==='inprogress' && r.claimedBy===user.username;
        const canCancel = isAdmin && r.status!=='done';
        const canUnclaim = isAdmin && r.status==='open' && r.claimedBy;
        const disabled = r.status==='done';

        return `
          <tr data-id="${r.id}">
            <td>${esc(r.machine||'')}</td>
            <td>${esc(r.partNumber||'')}</td>
            <td>${esc(r.description||'')}</td>
            <td>${r.qty||0}</td>
            <td><span class="badge ${priBadge}">${priLabel}</span></td>
            <td>${esc(r.claimedBy||'-')}</td>
            <td>${statusLabel}</td>
            <td>
              ${canClaim ? `<button class="btn-link act-claim">Claim</button>` : ''}
              ${canStart ? `<button class="btn-link act-start">Start</button>` : ''}
              ${canComplete ? `<button class="btn-link act-complete">Complete</button>` : ''}
              ${canCancel ? `<button class="btn-link act-cancel">Cancel</button>` : ''}
              ${canUnclaim ? `<button class="btn-link act-unclaim">Unclaim</button>` : ''}
            </td>
            <td class="text-right">
              ${canComplete ? `<input type="number" class="qtyDone" min="1" max="${r.qty||1}" value="${r.qty||1}" />` : ''}
            </td>
          </tr>
        `;
      }).join('');

      document.getElementById('lastUpdated').textContent =
        'Last updated: '+new Date().toLocaleTimeString();
    }

    async function refreshAll(){
      try{
        setStatus('Loading from backend…');
        const data = await api('/build-tasks');
        assignments = data.assignments||[];
        machines = data.machines||[];
        buildMachineOptions();
        renderAssignments();
        updateCounts();
        setStatus('Live from backend');
      }catch(e){
        console.error(e);
        setStatus('Failed to load: '+e.message);
      }
    }

    document.getElementById('filterMachine').addEventListener('change', renderAssignments);
    document.getElementById('filterStatus').addEventListener('change', renderAssignments);
    document.getElementById('filterPriority').addEventListener('change', renderAssignments);
    document.getElementById('filterPart').addEventListener('input', renderAssignments);

    document.getElementById('assignBody').addEventListener('click', async (e)=>{
      const btn = e.target.closest('button');
      if (!btn) return;
      const tr = btn.closest('tr');
      const id = tr?.dataset?.id;
      if (!id) return;

      const claimId = btn.classList.contains('act-claim') ? id : null;
      const startId = btn.classList.contains('act-start') ? id : null;
      const completeId = btn.classList.contains('act-complete') ? id : null;
      const cancelId = btn.classList.contains('act-cancel') ? id : null;
      const unclaimId = btn.classList.contains('act-unclaim') ? id : null;

      try{
        if (claimId){
          await api(`/api/build-tasks/${claimId}/claim`, { method:'PATCH' });
          await refreshAll(); return;
        }
        if (startId){
          await api(`/api/build-tasks/${startId}/start`, { method:'PATCH' });
          await refreshAll(); return;
        }
        if (cancelId && isAdmin){
          await api(`/api/build-tasks/${cancelId}/cancel`, { method:'PATCH' });
          await refreshAll(); return;
        }
        if (unclaimId && isAdmin){
          await api(`/api/build-tasks/${unclaimId}/unclaim`, { method:'PATCH' });
          await refreshAll(); return;
        }
        if (completeId){
          const tr = e.target.closest('tr');
          const qtyBox = tr?.querySelector('.qtyDone');
          const qty = Number(qtyBox?.value||0);
          if (!Number.isInteger(qty) || qty <= 0) { alert('Enter a positive quantity'); return; }
          const res = await api(`/api/build-tasks/${completeId}/complete`, { method:'PATCH', body:{ qty } });
          const pn = res?.addToInventory?.partNumber;
          const inc = Number(res?.addToInventory?.qty||0);
          if (pn && inc > 0){
            // update inventory qty using new /qty endpoint
            let currentQty = 0;
            try {
              const invItem = await api(`/api/inventory/${encodeURIComponent(pn)}`);
              currentQty = Number(invItem?.qty || 0);
            } catch (e) {
              console.warn('Failed to read current inventory qty, assuming 0', e);
            }
            const newQty = currentQty + inc;
            await api(`/api/inventory/${encodeURIComponent(pn)}/qty`, {
              method:'POST',
              body:{ qty: newQty }
            });
          }
          await refreshAll(); return;
        }
      } catch(err){
        alert('Action failed');
      }
    });

    document.getElementById('clearDoneBtn')?.addEventListener('click', async ()=>{
      if (!isAdmin) return;
      try{
        await api('/api/build-task-events?type=complete', { method:'DELETE' });
        await refreshAll();
      }catch(e){ alert('Clear failed'); }
    });

    document.getElementById('exportBtn')?.addEventListener('click', async ()=>{
      try{
        const res = await api('/api/build-task-events?type=complete', { method:'GET' });
        const rows = res.events || [];
        if (!rows.length){ alert('No completed events to export.'); return; }
        const header = ['When','User','Machine','Part Number','Description','Qty'];
        const csv = [header.join(',')].concat(rows.map(r=>[
          `"${new Date(r.when).toLocaleString().replace(/"/g,'""')}"`,
          `"${(r.user||'').replace(/"/g,'""')}"`,
          `"${(r.machine||'').replace(/"/g,'""')}"`,
          `"${(r.partNumber||'').replace(/"/g,'""')}"`,
          `"${(r.description||'').replace(/"/g,'""')}"`,
          r.qty||0
        ].join(','))).join('\n');

        const blob = new Blob([csv],{type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'build-completed.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }catch(e){
        alert('Export failed');
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', ()=>{
      localStorage.removeItem('wireShopSession');
      location.href='index.html';
    });

    (function init(){
      user = ensureUser();
      if (!user) return;
      isAdmin = computeIsAdmin(user);
      document.getElementById('userLabel').textContent = 'User: '+user.username + (isAdmin ? ' (Admin)' : '');
      refreshAll();
    })();
  </script>
</body>
</html>
