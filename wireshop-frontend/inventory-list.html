<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CZM • Inventory Snapshot</title>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    .brand-actions .navbtn{display:inline-block;background:#1a1c20;color:#bbb;padding:6px 12px;border-radius:10px;text-decoration:none;border:1px solid #3a3f44;font-weight:600;font-size:.9rem;margin-left:8px}
    .brand-actions .navbtn.active{background:#b30000;color:#fff;border-color:#ff4d4d}

    .toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
    .toolbar .grow{flex:1}
    .toolbar label{display:inline-flex;align-items:center;gap:6px;font-weight:700;color:#333}
    .toolbar input[type="search"]{width:100%}
    .hint{color:#666;font-size:.9rem;margin-top:0}

    table.compact td, table.compact th{padding:8px 10px;vertical-align:top}
    td.qty{font-weight:900}
    .wrap{white-space:normal;word-break:break-word}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .muted{color:#666;font-size:.95rem}
    th.minw, td.minw{min-width:240px}
    th.notes, td.notes{min-width:320px}
  </style>
</head>
<body>
  <div class="brand-bar">
    <div class="brand-inner">
      <a class="brand-logo" href="/dashboard.html">
        <img src="/czm-logo.png" alt="CZM">
        <h1 class="brand-title">CZM • Inventory Snapshot</h1>
      </a>
      <div class="brand-actions">
        <a class="navbtn" href="/dashboard.html">Dashboard</a>
        <a class="navbtn" href="/assignments.html">Build Next</a>
        <a class="navbtn active" href="/inventory-list.html">Snapshot</a>
        <a class="navbtn" href="/inventory">Inventory</a>
        <a class="navbtn" href="/archive.html">Archive</a>
        <a class="navbtn" href="/admin.html">Admin</a>
        <button id="logoutBtn" class="navbtn">Logout</button>
      </div>
    </div>
  </div>

  <main class="page">
    <div class="card">
      <div class="toolbar">
        <div class="grow">
          <input id="q" type="search" placeholder="Filter by part number or print name">
        </div>
        <label><input id="onlyNonZero" type="checkbox"> Only non-zero</label>
        <label><input id="onlyZero" type="checkbox"> Only zero</label>
      </div>
      <p class="hint">Tip: checking “Only zero” will automatically uncheck “Only non-zero” (and vice versa), because math.</p>

      <table class="sticky-head compact" id="tbl">
        <thead>
          <tr>
            <th class="minw">Print Number</th>
            <th class="minw">Print Name</th>
            <th class="notes">Notes</th>
            <th class="nowrap">Qty</th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
      </table>
    </div>
  </main>

  <script src="/catalog.js"></script>
  <script>
    const API_ROOT = 'https://wireshop-backend.onrender.com';

    // auth guard
    const user = (() => { try { return JSON.parse(localStorage.getItem('user')||'{}'); } catch { return {}; } })();
    if (!user || !user.username) { window.location.href = '/index.html'; }
    document.getElementById('logoutBtn')?.addEventListener('click', ()=>{ localStorage.removeItem('user'); location.href='/index.html'; });

    // elements
    const q = document.getElementById('q');
    const onlyNonZero = document.getElementById('onlyNonZero');
    const onlyZero = document.getElementById('onlyZero');
    const tbody = document.getElementById('body');

    // catalog join (for names/notes)
    const CATALOG = Array.isArray(window.catalog) ? window.catalog : [];
    const byPN = new Map(CATALOG.map(x => [String(x.partNumber||'').trim(), x]));

    function esc(s){ return String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

    async function api(path){
      const res = await fetch(API_ROOT + path, {
        headers: {'Content-Type':'application/json','x-user':user.username,'x-role':String(user.role||'')}
      });
      if (!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }

    let rows = [];
    function render(){
      const term = q.value.trim().toLowerCase();

      let list = rows.slice();

      // mutually exclusive toggles
      if (onlyNonZero.checked && onlyZero.checked){
        // last toggle wins; we'll just uncheck the older one. But to be safe, prefer nonZero.
        onlyZero.checked = false;
      }

      if (onlyNonZero.checked) list = list.filter(r => Number(r.qty||0) > 0);
      if (onlyZero.checked)    list = list.filter(r => Number(r.qty||0) === 0);

      if (term){
        list = list.filter(r => {
          const cat = byPN.get(String(r.partNumber)) || {};
          const hay = (String(r.partNumber)+' '+String(cat.printName||'')).toLowerCase();
          return hay.includes(term);
        });
      }

      // stable sort: PN asc
      list.sort((a,b)=> String(a.partNumber).localeCompare(String(b.partNumber), undefined, {numeric:true}));

      tbody.innerHTML = list.map(r => {
        const cat = byPN.get(String(r.partNumber)) || {};
        const name = cat.printName || '';
        const notes = cat.notes || '';
        return `<tr>
          <td class="mono wrap">${esc(r.partNumber)}</td>
          <td class="wrap">${esc(name)}</td>
          <td class="wrap notes">${esc(notes)}</td>
          <td class="qty">${Number(r.qty||0)}</td>
        </tr>`;
      }).join('');
    }

    // keep toggles mutually exclusive like radios
    onlyNonZero.addEventListener('change', ()=>{ if (onlyNonZero.checked) onlyZero.checked = false; render(); });
    onlyZero.addEventListener('change', ()=>{ if (onlyZero.checked) onlyNonZero.checked = false; render(); });
    q.addEventListener('input', render);

    async function init(){
      const data = await api('/api/inventory-all');
      rows = Array.isArray(data) ? data : [];
      render();
    }

    init().catch(()=> alert('Failed to load inventory snapshot'));
  </script>
</body>
</html>
