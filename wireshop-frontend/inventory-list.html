<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CZM • Inventory List</title>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    .brand-actions .navbtn{display:inline-block;background:#1a1c20;color:#bbb;padding:6px 12px;border-radius:10px;text-decoration:none;border:1px solid #3a3f44;font-weight:600;font-size:.9rem;margin-left:8px}
    .brand-actions .navbtn.active{background:#b30000;color:#fff;border-color:#ff4d4d}
    .toolbar{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px}
    .badge{background:#eee;border:1px solid #ddd;border-radius:8px;padding:4px 8px;font-weight:700}
    .qtycell{font-weight:900;text-align:right}
    .row-actions{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .custom-wrap{display:flex;gap:6px;align-items:center}
    .custom-wrap input[type=number]{width:84px;padding:6px;border:1px solid #d3d8e1;border-radius:10px}
    .apply{padding:6px 14px;border:1px solid #b30000;border-radius:10px;background:#b30000;color:#fff;font-weight:800;cursor:pointer;}
    .apply:hover:enabled{filter:brightness(1.1)}
    .apply:disabled{background:#b30000;border-color:#b30000;color:#fff;opacity:0.6;cursor:not-allowed}
    .status{font-size:12px;color:#666}
    .low{color:#b30000}
    .notes-cell{min-width:425px;white-space:normal;overflow:visible;text-overflow:initial;word-break:break-word}
    #tbl th:last-child,#tbl td:last-child{padding-right:24px}
    #editModalBg{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;}
    #editModal{background:#18222e;padding:16px;border-radius:6px;width:320px;box-shadow:0 4px 20px rgba(0,0,0,.5);}
    #editModal h2{margin-top:0;font-size:16px;}
    .form-row{margin-bottom:8px;}
    .form-row label{display:block;font-size:12px;margin-bottom:2px;}
    .form-row input,.form-row textarea{width:100%;padding:4px;background:#101820;border:1px solid #444;color:#fff;border-radius:4px;font-size:12px;}
    .actions{display:flex;gap:6px;}
  </style>
</head>
<body>
  <div class="brand-bar">
    <div class="brand-inner">
      <a class="brand-logo" href="/dashboard.html">
        <img src="/czm-logo.png" alt="CZM">
        <h1 class="brand-title">CZM • Inventory</h1>
      </a>
      <div class="brand-actions">
        <a class="navbtn" href="/dashboard.html">Dashboard</a>
        <a class="navbtn" href="/assignments.html">Build Next</a>
        <a class="navbtn active" href="/inventory">Inventory</a>
        <a class="navbtn" href="/archive.html">Archive</a>
        <a class="navbtn" href="/admin.html">Admin</a>
        <button id="logoutBtn" class="navbtn">Logout</button>
      </div>
    </div>
  </div>

  <main class="page">
    <div class="card">
      <h2>Inventory — Snapshot</h2>
      <div class="toolbar">
        <div style="flex:1">
          <label for="q">Filter</label>
          <input id="q" type="text" placeholder="part number, print name, or location">
        </div>
        <div style="display:flex;align-items:end;gap:10px">
          <label class="badge"><input type="checkbox" id="onlyNonZero"> only non-zero</label>
          <label class="badge"><input type="checkbox" id="onlyZero"> only 0-qty</label>
          <button id="exportBtn" class="badge">Export</button>
          <span class="badge" id="countBadge">0 items</span>
          <span class="status" id="status">Loading…</span>
        </div>
      </div>

      <table class="sticky-head" id="tbl">
        <thead>
          <tr>
            <th style="width:210px">Part Number</th>
            <th>Print Name</th>
            <th style="width:180px">Location</th>
            <th style="width:90px;text-align:right">Min</th>
            <th style="width:90px;text-align:right">Qty</th>
            <th style="min-width:220px">Adjust</th>
            <th style="min-width:425px">Notes</th>
            <th id="thActions" style="width:80px;text-align:center;display:none;">Edit</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>

  <!-- Edit Modal -->
  <div id="editModalBg">
    <div id="editModal">
      <h2>Edit Part</h2>
      <div class="form-row"><label>Part Number</label><input id="mPartNumber" readonly/></div>
      <div class="form-row"><label>Description</label><input id="mDescription"/></div>
      <div class="form-row"><label>Location</label><input id="mLocation"/></div>
      <div class="form-row"><label>Qty</label><input id="mQty" type="number"/></div>
      <div class="form-row"><label>Min Qty</label><input id="mMinQty" type="number"/></div>
      <div class="form-row"><label>Notes</label><textarea id="mNotes" rows="2"></textarea></div>
      <div class="actions">
        <button class="apply" id="saveBtn">Save</button>
        <button class="apply" style="background:#444" id="cancelBtn">Cancel</button>
        <button class="apply" style="margin-left:auto;background:#444" id="deleteBtn">Delete</button>
      </div>
    </div>
  </div>

  <script src="/catalog.js"></script>
  <script>
    const API_ROOT = 'https://wireshop-backend.onrender.com';
    const user = (() => { try { return JSON.parse(localStorage.getItem('user')||'{}'); } catch { return {}; } })();
    if (!user || !user.username) { window.location.href = '/index.html'; }
    document.getElementById('logoutBtn')?.addEventListener('click', () => { localStorage.removeItem('user'); window.location.href = '/index.html'; });

    const ADMIN_USERS = ['shane','admin'];
    const isAdmin = ADMIN_USERS.includes(user.username?.toLowerCase());
    if (isAdmin) document.getElementById('thActions').style.display = '';

    const tbody = document.getElementById('tbody');
    const qEl = document.getElementById('q');
    const onlyNonZeroEl = document.getElementById('onlyNonZero');
    const onlyZeroEl = document.getElementById('onlyZero');
    const countBadge = document.getElementById('countBadge');
    const statusEl = document.getElementById('status');
    const exportBtn = document.getElementById('exportBtn');

    let rows = [];
    const esc = s => String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

    async function api(path, opts={}) {
      const res = await fetch(API_ROOT + path, {
        method: opts.method || 'GET',
        headers: { 'Content-Type':'application/json', 'x-user': user.username },
        body: opts.body ? JSON.stringify(opts.body) : undefined
      });
      if(!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }

    async function load(){
      statusEl.textContent = 'Loading…';
      const snap = await api('/api/inventory-all');
      rows = snap.sort((a,b)=>a.partNumber.localeCompare(b.partNumber,undefined,{numeric:true}));
      build();
      statusEl.textContent = `Loaded ${rows.length} items`;
    }

    function build(){
      const q = qEl.value.trim().toLowerCase();
      const onlyNZ = onlyNonZeroEl.checked;
      const onlyZ = onlyZeroEl.checked;
      const filtered = rows.filter(r=>{
        if (onlyZ && r.qty!==0) return false;
        if (onlyNZ && r.qty===0) return false;
        if (!q) return true;
        return (
          (r.partNumber||'').toLowerCase().includes(q) ||
          (r.description||'').toLowerCase().includes(q) ||
          (r.location||'').toLowerCase().includes(q) ||
          (r.notes||'').toLowerCase().includes(q)
        );
      });
      countBadge.textContent = `${filtered.length} items`;
      tbody.innerHTML = filtered.map(r => `
        <tr data-part="${r.partNumber}">
          <td>${esc(r.partNumber||'')}</td>
          <td>${esc(r.description||'')}</td>
          <td>${esc(r.location||'')}</td>
          <td style="text-align:right">${r.minQty|0}</td>
          <td style="text-align:right" class="${r.qty<r.minQty?'low':''}">${r.qty|0}</td>
          <td></td>
          <td>${esc(r.notes||'')}</td>
          ${isAdmin ? `<td style="text-align:center"><button class="apply" style="background:#444" data-part="${r.partNumber}">Edit</button></td>` : ''}
        </tr>
      `).join('');
      if (isAdmin) tbody.querySelectorAll('button[data-part]').forEach(btn => btn.addEventListener('click', e => openEdit(e.target.dataset.part)));
    }

    const modalBg = document.getElementById('editModalBg');
    const mPartNumber = document.getElementById('mPartNumber');
    const mDescription = document.getElementById('mDescription');
    const mLocation = document.getElementById('mLocation');
    const mQty = document.getElementById('mQty');
    const mMinQty = document.getElementById('mMinQty');
    const mNotes = document.getElementById('mNotes');

    function openEdit(partNumber) {
      const row = rows.find(r=>r.partNumber===partNumber);
      if(!row) return;
      mPartNumber.value = row.partNumber||'';
      mDescription.value = row.description||'';
      mLocation.value = row.location||'';
      mQty.value = row.qty||0;
      mMinQty.value = row.minQty||0;
      mNotes.value = row.notes||'';
      modalBg.style.display = 'flex';
    }

    document.getElementById('cancelBtn').onclick = ()=> modalBg.style.display='none';
    document.getElementById('saveBtn').onclick = async ()=>{
      const part = mPartNumber.value;
      const payload = {
        description: mDescription.value,
        location: mLocation.value,
        qty: Number(mQty.value)||0,
        minQty: Number(mMinQty.value)||0,
        notes: mNotes.value
      };
      await api(`/api/inventory/${encodeURIComponent(part)}`, { method:'PUT', body:payload });
      modalBg.style.display='none';
      load();
    };
    document.getElementById('deleteBtn').onclick = async ()=>{
      const part = mPartNumber.value;
      if(!confirm(`Delete ${part}?`)) return;
      await api(`/api/inventory/${encodeURIComponent(part)}`, { method:'DELETE' });
      modalBg.style.display='none';
      load();
    };

    qEl.addEventListener('input', build);
    onlyNonZeroEl.addEventListener('change', build);
    onlyZeroEl.addEventListener('change', build);

    exportBtn.onclick = ()=>{
      if(!rows.length) return alert('No data to export.');
      const headers = ["Part Number","Description","Location","Min","Qty","Notes"];
      const csv = [headers.join(",")].concat(rows.map(r =>
        [r.partNumber,r.description,r.location,r.minQty,r.qty,(r.notes||"").replace(/[\r\n]+/g," ")].map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")
      )).join("\n");
      const blob = new Blob([csv],{type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href=url;a.download="inventory.csv";document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
    };

    load().catch(()=> alert('Failed to load inventory list'));
  </script>
</body>
</html>
