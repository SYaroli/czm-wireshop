<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CZM • Inventory</title>

  <!-- Shared styles and page CSS -->
  <link rel="stylesheet" href="style.css" />

  <style>
    /* Keep layout consistent with Build Next */
    .page-wrap { max-width: 1200px; margin: 18px auto 64px; }
    .toolbar { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
    .toolbar .spacer { flex: 1; } /* pushes right-side controls away */
    .filters {
      display: grid;
      grid-template-columns: 1fr auto auto auto auto;
      gap: 10px;
      align-items: center;
    }
    .filters .toggle { display: inline-flex; gap: 6px; align-items: center; padding: 6px 10px; }
    .filters .count-badge { font-size: 12px; opacity: .8; padding-left: 6px; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 10px 8px; }
    .table th { background: #0f0f10; color: #fff; position: sticky; top: 0; z-index: 1; }
    .qty-controls { display: inline-flex; gap: 8px; align-items: center; }
    .qty-controls input[type="text"] { width: 70px; text-align: center; }
    /* Keep action buttons compact and aligned */
    .btn-apply { background:#c10; color:#fff; border:0; padding:6px 10px; border-radius:6px; }
    .btn-edit  { background:#444; color:#fff; border:0; padding:6px 10px; border-radius:6px; }
    /* Hide admin-only by default; users.js will reveal when role=admin */
    .admin-only { display: none; }
  </style>
</head>

<body>
  <!-- Top navigation rendered exactly like Build Next -->
  <div id="topnav"></div>

  <main class="page-wrap">
    <section class="toolbar">
      <h2 style="margin:0;">Inventory — Snapshot</h2>
      <div class="spacer"></div>
      <!-- “Export” is optional; keep class admin-only if you want it gated -->
      <button id="exportBtn" class="btn btn-small admin-only" type="button">Export</button>
      <button id="addPartBtn" class="btn btn-small admin-only" type="button">Add part</button>
      <span id="itemCount" class="count-badge">0 items</span>
    </section>

    <section class="filters">
      <input id="search" class="input" type="text" placeholder="part number, print name, or location" />
      <label class="toggle"><input id="onlyNonZero" type="checkbox" /> only non-zero</label>
      <label class="toggle"><input id="onlyZero" type="checkbox" /> only 0-qty</label>
      <div></div><div></div>
    </section>

    <table class="table" id="invTable">
      <thead>
        <tr>
          <th style="width: 190px;">Part Number</th>
          <th>Print Name</th>
          <th style="width: 90px;">Location</th>
          <th style="width: 60px; text-align:right;">Qty</th>
          <th style="width: 160px;">Adjust</th>
          <th style="width: 170px;">Notes</th>
        </tr>
      </thead>
      <tbody id="invBody">
        <!-- rows rendered by JS -->
      </tbody>
    </table>
  </main>

  <!-- Shared scripts -->
  <script src="users.js"></script>
  <script src="admin-nav.js"></script>

  <script>
    // Render the same header as Build Next, with Inventory highlighted
    if (typeof renderNav === 'function') {
      renderNav('inventory'); // expects admin-nav.js to create “Build Next | Inventory | Logout”
    }

    // Track the logged-in user, then gate admin-only controls
    let CURRENT_USER = null;
    async function fetchMe() {
      try {
        const r = await fetch('/api/users/me', { credentials: 'include' });
        if (!r.ok) throw new Error('me failed');
        CURRENT_USER = await r.json(); // { name, email, role }
      } catch (e) { CURRENT_USER = null; }
      const isAdmin = CURRENT_USER && CURRENT_USER.role === 'admin';
      document.querySelectorAll('.admin-only').forEach(el => { el.style.display = isAdmin ? '' : 'none'; });
    }

    // Inventory rendering
    const elBody = document.getElementById('invBody');
    const elSearch = document.getElementById('search');
    const elOnlyNonZero = document.getElementById('onlyNonZero');
    const elOnlyZero = document.getElementById('onlyZero');
    const elItemCount = document.getElementById('itemCount');
    const elAddPart = document.getElementById('addPartBtn');
    const elExport = document.getElementById('exportBtn');

    let INVENTORY = [];

    function rowHTML(item, isAdmin) {
      const id = item.part || item.partNumber;
      const qty = Number(item.qty || 0);
      const pn = id || '';
      const printName = item.print_name || item.printName || '';
      const loc = item.location || '';
      const notes = item.notes || '';

      return `
        <tr data-part="${pn}">
          <td><a href="/inventory.html?part=${encodeURIComponent(pn)}">${pn}</a></td>
          <td>${printName || ''}</td>
          <td>${loc || ''}</td>
          <td style="text-align:right;">${qty}</td>
          <td>
            <div class="qty-controls">
              <input type="text" data-delta placeholder="+/-" />
              <button class="btn-apply" data-action="apply">Apply</button>
              ${isAdmin ? `<button class="btn-edit admin-only" data-action="edit">Edit</button>` : ''}
            </div>
          </td>
          <td>${notes || ''}</td>
        </tr>
      `;
    }

    function render() {
      const isAdmin = CURRENT_USER && CURRENT_USER.role === 'admin';
      const q = (elSearch.value || '').trim().toLowerCase();
      const showNonZero = elOnlyNonZero.checked;
      const showOnlyZero = elOnlyZero.checked;

      let list = INVENTORY.slice();
      if (q) {
        list = list.filter(it =>
          String(it.part || it.partNumber).toLowerCase().includes(q) ||
          String(it.print_name || it.printName || '').toLowerCase().includes(q) ||
          String(it.location || '').toLowerCase().includes(q)
        );
      }
      if (showNonZero) list = list.filter(it => Number(it.qty || 0) !== 0);
      if (showOnlyZero) list = list.filter(it => Number(it.qty || 0) === 0);

      elBody.innerHTML = list.map(it => rowHTML(it, isAdmin)).join('');
      elItemCount.textContent = `${list.length} items`;
    }

    async function loadInventory() {
      const r = await fetch('/api/inventory', { credentials: 'include' });
      const data = await r.json();
      INVENTORY = Array.isArray(data) ? data : (data.items || []);
      render();
    }

    // Apply / Edit handlers
    elBody.addEventListener('click', async e => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const tr = e.target.closest('tr');
      const part = tr?.dataset?.part;
      if (!part) return;

      if (btn.dataset.action === 'apply') {
        const deltaInput = tr.querySelector('input[data-delta]');
        const delta = Number((deltaInput.value || '').replace(/[^-0-9]/g, '')) || 0;
        if (!delta) return;
        const res = await fetch(`/api/inventory/${encodeURIComponent(part)}/adjust`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ delta })
        });
        if (res.ok) { await loadInventory(); }
      }

      if (btn.dataset.action === 'edit') {
        // Simple inline prompt editor (admin only)
        const target = INVENTORY.find(x => (x.part || x.partNumber) === part);
        if (!target) return;
        const printName = prompt('Print name:', target.print_name || target.printName || '') ?? '';
        const location = prompt('Location:', target.location || '') ?? '';
        const notes = prompt('Notes:', target.notes || '') ?? '';

        const res = await fetch(`/api/inventory/${encodeURIComponent(part)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            print_name: printName,
            location,
            // send empty string when clearing; backend should treat "" as clear
            notes
          })
        });
        if (res.ok) { await loadInventory(); }
      }
    });

    // Wire filters
    [elSearch, elOnlyNonZero, elOnlyZero].forEach(el =>
      el.addEventListener('input', render)
    );

    // Optional admin actions
    elAddPart?.addEventListener('click', async () => {
      if (!(CURRENT_USER && CURRENT_USER.role === 'admin')) return;
      const part = prompt('Part number:'); if (!part) return;
      const qty = Number(prompt('Qty (number):') || '0') || 0;
      const printName = prompt('Print name:') || '';
      const location = prompt('Location:') || '';
      const notes = prompt('Notes:') || '';
      const res = await fetch('/api/inventory', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ part, qty, print_name: printName, location, notes })
      });
      if (res.ok) await loadInventory();
    });

    elExport?.addEventListener('click', async () => {
      if (!(CURRENT_USER && CURRENT_USER.role === 'admin')) return;
      window.location.href = '/api/inventory/export';
    });

    // Init
    (async function init() {
      await fetchMe();
      await loadInventory();
    })();
  </script>
</body>
</html>
