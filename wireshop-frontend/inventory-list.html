<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CZM • Inventory</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    /* Brand bar (match assignments.html) */
    .brand-bar{background:#0f1114;border-bottom:4px solid #c30000}
    .brand-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:8px 12px}
    .brand-logo{display:flex;align-items:center;gap:10px;color:#fff;text-decoration:none}
    .brand-logo img{height:22px;opacity:.95}
    .brand-title{font-size:16px;margin:0;color:#fff}
    .brand-actions .navbtn{display:inline-block;background:#1a1c1f;color:#fff;border-radius:20px;padding:6px 12px;text-decoration:none;border:1px solid #3a3f44;font-weight:600;font-size:.9rem;margin-left:8px}
    .brand-actions .navbtn.active{background:#b30000;color:#fff;border-color:#ff4d4d}

    body{background:#f1f3f7;font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;margin:0;padding:0}
    .page-wrap{max-width:1200px;margin:20px auto;padding:0 12px}
    .card{background:#fff;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.05);margin-bottom:14px;overflow:hidden;}
    .card-head{padding:16px 18px;border-bottom:1px solid #eee;font-weight:700;}
    .card-sub{font-size:12px;color:#6b7280;margin-top:2px}
    .card-body{padding:16px 18px;}

    .filter-row{display:flex;flex-wrap:wrap;align-items:center;gap:10px}
    .filter-row input[type="text"]{flex:1;min-width:260px;height:32px;border:1px solid #cfd4da;border-radius:6px;padding:0 10px}
    .cb{display:flex;align-items:center;gap:8px;height:32px;padding:0 10px;font-size:13px;border:1px solid #cfd4da;border-radius:6px;background:#f7f8fa;user-select:none}
    .cb input{margin:0;width:16px;height:16px}
    .toolbar-btn{background:#eee;border:1px solid #cfd4da;border-radius:6px;height:32px;padding:0 12px;font-size:13px;cursor:pointer}
    .toolbar-btn.red{background:#c30000;color:#fff;border-color:#a00000}
    #countLabel{font-size:12px;margin-left:auto;white-space:nowrap}

    /* Header row */
    .table-head{background:#0a0b0d;color:#fff;display:grid;grid-template-columns:150px 260px 80px 80px 130px minmax(160px,1fr);gap:0;border-radius:6px;margin-top:12px}
    .table-head div{padding:8px 16px;font-size:12px;font-weight:600}

    /* Data rows */
    .list-body .row{display:grid;grid-template-columns:150px 260px 80px 80px 130px minmax(160px,1fr);gap:0;border-bottom:1px solid #eef2f6;background:#fff;align-items:center}
    .list-body .row:nth-child(odd){background:#fafbfc}
    .list-body .cell{padding:8px 16px;font-size:13px}
    .pn{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px}
    .qty-low{color:#b91c1c;font-weight:700}
    .qty-ok{color:#0f766e;font-weight:700}
    .notes-cell{font-size:12px;color:#333;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .tag{display:inline-block;background:#e5e7eb;color:#374151;border-radius:999px;padding:1px 6px;font-size:11px;margin-right:4px;margin-bottom:3px}

    .list-body{border-radius:6px;overflow:hidden;border:1px solid #d1d5db;background:#fff;margin-top:2px}

    .foot-row{display:flex;align-items:center;justify-content:space-between;margin-top:10px;font-size:12px;color:#6b7280}
    .foot-row strong{color:#111827}
    .pill{display:inline-flex;align-items:center;border-radius:999px;border:1px solid #cfd4da;padding:3px 10px;font-size:12px;background:#f9fafb}
    .pill-dot{width:8px;height:8px;border-radius:999px;margin-right:6px;background:#22c55e;box-shadow:0 0 8px rgba(34,197,94,.8)}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.55);display:none;align-items:center;justify-content:center;z-index:40}
    .modal{background:#fff;border-radius:8px;box-shadow:0 20px 40px rgba(15,23,42,.6);max-width:420px;width:100%;padding:18px}
    .modal h2{margin:0 0 8px;font-size:16px}
    .modal p{margin:0 0 8px;font-size:12px;color:#4b5563}
    .modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
    .modal-grid label{font-size:12px;color:#374151;display:block;margin-bottom:4px}
    .modal-grid input,.modal-grid textarea{width:100%;box-sizing:border-box;border-radius:6px;border:1px solid #d1d5db;padding:6px 8px;font-size:13px}
    .modal-grid textarea{resize:vertical;min-height:60px}
    .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:14px}
    .btn{border-radius:6px;height:32px;padding:0 12px;border:1px solid transparent;font-size:13px;cursor:pointer}
    .btn-primary{background:#c30000;color:#fff;border-color:#a00000}
    .btn-gray{background:#c5c5c5;color:#000}
  </style>
</head>
<body>
  <!-- Brand bar -->
  <div class="brand-bar">
    <div class="brand-inner">
      <a class="brand-logo" href="/dashboard.html">
        <img src="/czm-logo.png" alt="CZM">
        <h1 class="brand-title">CZM • Inventory</h1>
      </a>
      <div class="brand-actions">
        <a class="navbtn" href="/dashboard.html">Dashboard</a>
        <a class="navbtn" href="/assignments.html">Build Next</a>
        <a class="navbtn active" href="/inventory">Inventory</a>
        <a class="navbtn" href="/archive.html">Archive</a>
        <a class="navbtn" href="/admin.html">Admin</a>
        <button id="logoutBtn" class="navbtn">Logout</button>
      </div>
    </div>
  </div>

  <main class="page-wrap">
    <section class="card">
      <div class="card-head">
        Inventory Overview
        <div class="card-sub">Merged view of DB inventory + catalog; zero / missing stock is highlighted.</div>
      </div>
      <div class="card-body">
        <div class="filter-row">
          <input type="text" id="filterBox" placeholder="Filter by part, description, location, print, or notes…" />
          <label class="cb">
            <input type="checkbox" id="cbNonZero" checked />
            <span>Hide zero / missing rows</span>
          </label>
          <label class="cb">
            <input type="checkbox" id="cbOnlyZero" />
            <span>Show ONLY zero / missing</span>
          </label>
          <button class="toolbar-btn" id="addBtn">Add Part</button>
          <button class="toolbar-btn red" id="exportBtn">Export CSV</button>
          <span id="countLabel">0 parts</span>
        </div>

        <div class="table-head">
          <div>Part Number</div>
          <div>Description</div>
          <div>Qty</div>
          <div>Min</div>
          <div>Location</div>
          <div>Print / Notes</div>
        </div>

        <div class="list-body" id="listBody">
          <!-- rows injected -->
        </div>

        <div class="foot-row">
          <div class="pill">
            <span class="pill-dot"></span>
            <span id="statusLabel">Loading from backend…</span>
          </div>
          <div>
            <span>Total parts: <strong id="totalParts">0</strong></span>
            &nbsp;•&nbsp;
            <span>Below min / zero: <strong id="lowParts">0</strong></span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Edit/Add Modal -->
  <div class="modal-backdrop" id="editModalBackdrop">
    <div class="modal">
      <h2 id="modalTitle">Edit Part</h2>
      <p id="modalSubtitle">Update inventory details.</p>
      <div class="modal-grid">
        <div>
          <label for="modalPartNumber">Part number</label>
          <input id="modalPartNumber" type="text" readonly />
        </div>
        <div>
          <label for="modalLocation">Location</label>
          <input id="modalLocation" type="text" />
        </div>
        <div>
          <label for="modalQty">Quantity</label>
          <input id="modalQty" type="number" step="1" />
        </div>
        <div>
          <label for="modalMinQty">Min qty</label>
          <input id="modalMinQty" type="number" step="1" />
        </div>
        <div style="grid-column:1/-1">
          <label for="modalDescription">Description / Print</label>
          <textarea id="modalDescription"></textarea>
        </div>
        <div style="grid-column:1/-1">
          <label for="modalNotes">Notes</label>
          <textarea id="modalNotes"></textarea>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-gray" id="cancelBtn">Cancel</button>
        <button class="btn btn-primary" id="saveBtn">Save</button>
        <button class="btn btn-primary" id="deleteBtn" style="margin-left:auto;background:#7f1d1d;border-color:#991b1b">Delete</button>
      </div>
    </div>
  </div>

  <script src="/catalog.js"></script>
  <script>
    const API_BASE = 'https://wireshop-backend.onrender.com/api';

    // read current user (same as assignments.html behavior)
    const currentUser = (()=>{ try{ return JSON.parse(localStorage.getItem('user')||'{}'); }catch{ return {}; } })();
    if (!currentUser || !currentUser.username) { window.location.href = '/index.html'; }
    document.getElementById('logoutBtn')?.addEventListener('click',()=>{ localStorage.removeItem('user'); location.href = '/index.html'; });

    const listBody = document.getElementById('listBody');
    const filterBox = document.getElementById('filterBox');
    const countLabel = document.getElementById('countLabel');
    const cbNonZero = document.getElementById('cbNonZero');
    const cbOnlyZero = document.getElementById('cbOnlyZero');
    const editModalBackdrop = document.getElementById('editModalBackdrop');
    const addBtn = document.getElementById('addBtn');

    let ALL_ROWS = [];
    let DB_ROWS = {};
    let isAdmin = false;
    let modalMode = 'edit';
    let editingPart = null;

    function computeIsAdmin(u){
      const uname = (u?.username || u?.name || u?.user || '').trim();
      const fromUsersJs =
        (window.ADMIN_USERS && Array.isArray(window.ADMIN_USERS) && window.ADMIN_USERS.includes(uname)) ||
        (window.ADMINS && Array.isArray(window.ADMINS) && window.ADMINS.includes(uname));
      if (fromUsersJs) return true;
      const FALLBACK = ['Shane.Yaroli','Tyler.Ellis'];
      return FALLBACK.includes(uname);
    }

    async function loadData(){
      isAdmin = computeIsAdmin(currentUser);
      addBtn.style.display = isAdmin ? 'inline-block' : 'none';

      const invRes = await fetch(API_BASE+'/inventory-all',{
        headers:{'x-user': currentUser.username||currentUser.name||currentUser.user||currentUser}
      });
      const invData = await invRes.json();
      DB_ROWS = {}; invData.forEach(r => DB_ROWS[r.partNumber]=r);

      const cat = Array.isArray(window.catalog) ? window.catalog : [];
      const merged = [];

      cat.forEach(c=>{
        const db = DB_ROWS[c.partNumber];
        if(db){
          merged.push({
            partNumber: db.partNumber,
            description: db.description ?? c.printName ?? '',
            printName: db.description ?? c.printName ?? '',
            location: db.location ?? (c.location||''),
            qty: typeof db.qty === 'number' ? db.qty : 0,
            notes: db.notes ?? (c.notes||''),
            minQty: typeof db.minQty === 'number' ? db.minQty : (c.minQty||0)
          });
        }else{
          merged.push({
            partNumber: c.partNumber,
            description: c.printName || '',
            printName: c.printName || '',
            location: c.location||'',
            qty: 0,
            notes: c.notes||'',
            minQty: c.minQty||0
          });
        }
      });

      const extras = Object.keys(DB_ROWS).filter(pn => !cat.some(c=>c.partNumber===pn));
      extras.forEach(pn=>{
        const db = DB_ROWS[pn];
        merged.push({
          partNumber: db.partNumber,
          description: db.description || '',
          printName: db.description || '',
          location: db.location||'',
          qty: typeof db.qty === 'number' ? db.qty : 0,
          notes: db.notes||'',
          minQty: typeof db.minQty === 'number' ? db.minQty : 0
        });
      });

      ALL_ROWS = merged.sort((a,b)=> (a.partNumber||'').localeCompare(b.partNumber||''));
      renderList();
    }

    function esc(s){ return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function qtyClass(row){
      const q = row.qty ?? 0;
      const min = row.minQty ?? 0;
      if (q <= 0 || q < min) return 'qty-low';
      return 'qty-ok';
    }

    function rowMatchesFilters(row, text, hideNonZero, onlyZero){
      const blob = (row.partNumber||'')+' '+(row.description||'')+' '+(row.location||' ')+' '+(row.printName||'')+' '+(row.notes||'');
      if (text && !blob.toLowerCase().includes(text)) return false;
      const isZero = (row.qty ?? 0) <= 0;
      const isLow  = (row.qty ?? 0) < (row.minQty ?? 0);
      if (hideNonZero && !isZero && !isLow) return false;
      if (onlyZero && !isZero && !isLow) return false;
      return true;
    }

    function renderList(){
      const text = filterBox.value.trim().toLowerCase();
      const hideNonZero = cbNonZero.checked;
      const onlyZero = cbOnlyZero.checked;

      const rows = ALL_ROWS.filter(r => rowMatchesFilters(r, text, hideNonZero, onlyZero));
      listBody.innerHTML = '';

      rows.forEach(row=>{
        const div = document.createElement('div');
        div.className = 'row';
        div.dataset.part = row.partNumber;

        const isZero = (row.qty ?? 0) <= 0;
        const isLow  = (row.qty ?? 0) < (row.minQty ?? 0);
        if (isZero || isLow) div.style.background = '#fef2f2';

        div.innerHTML = `
          <div class="cell pn">${esc(row.partNumber||'')}</div>
          <div class="cell">${esc(row.description||'')}</div>
          <div class="cell ${qtyClass(row)}">${row.qty ?? 0}</div>
          <div class="cell">${row.minQty ?? 0}</div>
          <div class="cell">${esc(row.location||'')}</div>
          <div class="cell notes-cell">
            ${row.printName ? `<span class="tag">Print: ${esc(row.printName)}</span>` : ''}
            ${row.notes ? `<span class="tag">Notes: ${esc(row.notes)}</span>` : ''}
          </div>
        `;

        if (isAdmin){
          div.style.cursor = 'pointer';
          div.addEventListener('click',()=> openModal('edit', row.partNumber));
        }

        listBody.appendChild(div);
      });

      countLabel.textContent = `${rows.length} parts`;
      document.getElementById('totalParts').textContent = ALL_ROWS.length;
      document.getElementById('lowParts').textContent =
        ALL_ROWS.filter(r => (r.qty ?? 0) <= 0 || (r.qty ?? 0) < (r.minQty ?? 0)).length;
      document.getElementById('statusLabel').textContent = 'Live from backend';
    }

    function openModal(mode, partNumber){
      modalMode = mode;
      editingPart = partNumber || null;
      const titleEl = document.getElementById('modalTitle');
      const subtitleEl = document.getElementById('modalSubtitle');

      if (mode === 'add'){
        titleEl.textContent = 'Add Part';
        subtitleEl.textContent = 'Create a new inventory record.';
        document.getElementById('modalPartNumber').readOnly = false;
        document.getElementById('modalPartNumber').value = partNumber || '';
        document.getElementById('modalDescription').value = '';
        document.getElementById('modalLocation').value = '';
        document.getElementById('modalQty').value = '';
        document.getElementById('modalMinQty').value = '';
        document.getElementById('modalNotes').value = '';
        document.getElementById('deleteBtn').style.display = 'none';
      }else{
        titleEl.textContent = 'Edit Part';
        subtitleEl.textContent = 'Update inventory details.';
        const row = ALL_ROWS.find(r => r.partNumber === partNumber) || {};
        document.getElementById('modalPartNumber').readOnly = true;
        document.getElementById('modalPartNumber').value = row.partNumber || '';
        document.getElementById('modalDescription').value = row.description || '';
        document.getElementById('modalLocation').value = row.location || '';
        document.getElementById('modalQty').value = row.qty ?? '';
        document.getElementById('modalMinQty').value = row.minQty ?? '';
        document.getElementById('modalNotes').value = row.notes || '';
        document.getElementById('deleteBtn').style.display = 'inline-block';
      }

      editModalBackdrop.style.display = 'flex';
    }

    function closeModal(){
      editModalBackdrop.style.display = 'none';
    }

    async function saveModal(){
      const pn = document.getElementById('modalPartNumber').value.trim();
      const desc = document.getElementById('modalDescription').value.trim();
      const loc = document.getElementById('modalLocation').value.trim();
      const qty = Number(document.getElementById('modalQty').value || 0);
      const minQty = Number(document.getElementById('modalMinQty').value || 0);
      const notes = document.getElementById('modalNotes').value.trim();
      if (!pn){ alert('Part number is required'); return; }

      const body = { partNumber: pn, description: desc, location: loc, qty, minQty, notes };

      const method = modalMode === 'add' ? 'POST' : 'PUT';
      const url = modalMode === 'add'
        ? `${API_BASE}/inventory`
        : `${API_BASE}/inventory/${encodeURIComponent(pn)}`;

      const res = await fetch(url,{
        method,
        headers:{
          'Content-Type':'application/json',
          'x-user': currentUser.username||currentUser.name||currentUser.user||currentUser
        },
        body: JSON.stringify(body)
      });

      if (!res.ok){
        const msg = await res.text().catch(()=> '');
        alert(`Save failed: ${res.status} ${msg}`);
        return;
      }

      closeModal();
      document.getElementById('statusLabel').textContent = 'Saved; refreshing…';
      await loadData();
    }

    async function deleteModal(){
      if (!editingPart) return;
      if (!confirm(`Delete ${editingPart} from inventory?`)) return;

      const res = await fetch(`${API_BASE}/inventory/${encodeURIComponent(editingPart)}`,{
        method:'DELETE',
        headers:{'x-user': currentUser.username||currentUser.name||currentUser.user||currentUser}
      });

      if (!res.ok){
        const msg = await res.text().catch(()=> '');
        alert(`Delete failed: ${res.status} ${msg}`);
        return;
      }

      closeModal();
      await loadData();
    }

    document.getElementById('cancelBtn').addEventListener('click',closeModal);
    editModalBackdrop.addEventListener('click',e=>{ if (e.target===editModalBackdrop) closeModal(); });
    addBtn.addEventListener('click',()=> openModal('add',''));

    document.getElementById('saveBtn').addEventListener('click',saveModal);
    document.getElementById('deleteBtn').addEventListener('click',deleteModal);
    filterBox.addEventListener('input',renderList);
    cbNonZero.addEventListener('change',renderList);
    cbOnlyZero.addEventListener('change',renderList);

    // Kickoff
    loadData();
  </script>
</body>
</html>
