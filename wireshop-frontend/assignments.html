<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CZM • Assignments</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    .brand-actions .navbtn{
      display:inline-block !important;
      background:var(--red) !important;
      color:#fff !important;
      padding:8px 12px !important;
      border-radius:9px !important;
      text-decoration:none !important;
      width:auto !important;
      border:0 !important;
      font-weight:700 !important;
      cursor:pointer !important;
    }
    .brand-actions .navbtn:hover{ filter:brightness(.92) }
    .small{ font-size:.85rem; padding:6px 10px; }
    .table td, .table th { vertical-align: middle; }
  </style>
</head>
<body>
  <div class="brand-bar">
    <div class="brand-inner">
      <a class="brand-logo" href="dashboard.html">
        <img src="czm-logo.png" alt="CZM">
        <h1 class="brand-title">CZM • Assignments</h1>
      </a>
      <div class="brand-actions" id="navActions">
        <a class="navbtn" href="dashboard.html">Dashboard</a>
        <!-- Admin-only buttons will be appended at runtime -->
      </div>
    </div>
  </div>

  <main class="page">
    <div id="app" style="display:none;">
      <div class="card">
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
          <div><strong>User:</strong> <span id="who"></span></div>
          <div class="muted">•</div>
          <div><strong>Role:</strong> <span id="role"></span></div>
          <div class="spacer"></div>
          <button id="refresh" class="secondary">Refresh</button>
        </div>
      </div>

      <!-- ADMIN VIEW -->
      <div id="adminView" style="display:none;">
        <div class="card">
          <h3 style="margin:0 0 8px;">Create Assignment</h3>
          <div class="grid cols-4">
            <label>Technician
              <select id="a_user">
                <option value="">-- Select technician --</option>
              </select>
            </label>

            <label>Part
              <select id="a_part_select">
                <option value="">-- Select part --</option>
              </select>
            </label>

            <label>Print Name
              <input id="a_print" type="text" placeholder="auto from part or enter manually"/>
            </label>

            <label>Expected Hours
              <input id="a_hours" type="number" min="0" step="0.25" placeholder="auto from part"/>
            </label>

            <label>Due Date
              <input id="a_due" type="date"/>
            </label>

            <label>Notes
              <input id="a_notes" type="text" placeholder="auto from part; editable"/>
            </label>

            <div class="spacer"></div>
            <button id="a_create" class="primary">Assign</button>
          </div>
          <div id="a_msg" class="muted" style="margin-top:6px"></div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px;">Assignments</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:end;margin-bottom:8px">
            <label>Filter by tech
              <select id="flt_user"><option value="">All</option></select>
            </label>
            <label>Status
              <select id="flt_status">
                <option value="">All</option>
                <option value="Open">Open</option>
                <option value="InProgress">InProgress</option>
                <option value="Completed">Completed</option>
                <option value="Canceled">Canceled</option>
              </select>
            </label>
            <button id="applyFilters" class="secondary">Apply</button>
            <button id="resetFilters" class="secondary">Reset</button>
          </div>

          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th>Created</th>
                  <th>Tech</th>
                  <th>Part #</th>
                  <th>Print</th>
                  <th>Hours</th>
                  <th>Due</th>
                  <th>Status</th>
                  <th>Notes</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="assignmentsBody"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px;">Requests Queue</h3>
          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th>Submitted By</th>
                  <th>Description / Part</th>
                  <th>Hours</th>
                  <th>Notes</th>
                  <th>Submitted</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="requestsBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TECH VIEW -->
      <div id="techView" style="display:none;">
        <div class="card">
          <h3 style="margin:0 0 8px;">My Assignments</h3>
          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th>Created</th>
                  <th>Part #</th>
                  <th>Print</th>
                  <th>Hours</th>
                  <th>Due</th>
                  <th>Status</th>
                  <th>Notes</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="myAssignmentsBody"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px;">Request Credit</h3>
          <div class="grid cols-3">
            <label>Part or Description
              <input id="r_part" type="text" placeholder="e.g. cabinet cleanup, quick fix"/>
            </label>
            <label>Hours
              <input id="r_hours" type="number" min="0" step="0.25" placeholder="e.g. 1.5"/>
            </label>
            <label>Notes
              <input id="r_notes" type="text" placeholder="optional"/>
            </label>
            <div class="spacer"></div>
            <button id="r_submit" class="primary">Submit Request</button>
          </div>
          <div id="r_msg" class="muted" style="margin-top:6px"></div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px;">My Requests</h3>
          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th>Description / Part</th>
                  <th>Hours</th>
                  <th>Notes</th>
                  <th>Status</th>
                  <th>Updated</th>
                </tr>
              </thead>
              <tbody id="myRequestsBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- LOGIN GATE -->
    <div id="loginGate" class="login-wrap">
      <div class="login-card">
        <div class="login-top">
          <img src="czm-logo.png" alt="CZM">
          <h1 class="login-title">CZM • Wireshop</h1>
        </div>
        <p class="login-sub">Sign in to view and manage assignments.</p>
        <form id="login-form">
          <div class="row">
            <label>Username
              <input type="text" id="username" required placeholder="firstname.lastname"/>
            </label>
            <label>PIN
              <input type="password" id="pin" required placeholder="1234" inputmode="numeric"/>
            </label>
          </div>
          <button type="submit">Login</button>
          <div id="error-message"></div>
        </form>
      </div>
    </div>
  </main>

  <!-- Fallback user list + the catalog used for part dropdown -->
  <script src="users.js"></script>
  <script src="catalog.js"></script>

  <script>
  (function(){
    const API_ROOT = 'https://wireshop-backend.onrender.com';
    const API = {
      users: `${API_ROOT}/api/users`,
      assignments: `${API_ROOT}/api/assignments`,
      requests: `${API_ROOT}/api/assignments/requests`
    };

    // Roles treated as technicians
    const TECH_ROLES = new Set(['assembler','tech','technician','assembler-tech','assembler/tech']);

    const el = (id) => document.getElementById(id);
    const navActions = () => document.getElementById('navActions');
    const getUser = () => { try { return JSON.parse(localStorage.getItem('user')) || null; } catch { return null; } };
    const setUser = (u) => localStorage.setItem('user', JSON.stringify(u));
    const username = () => (getUser()?.username || '');

    function headers(){
      return { 'Content-Type': 'application/json', 'x-user': username() };
    }
    async function apiGet(url){
      const res = await fetch(url, { headers: headers() });
      if (!res.ok) throw new Error(await res.text().catch(()=>`${res.status}`));
      return res.json();
    }
    async function apiJson(url, method, data){
      const res = await fetch(url, { method, headers: headers(), body: JSON.stringify(data) });
      if (!res.ok) throw new Error(await res.text().catch(()=>`${res.status}`));
      return res.json();
    }
    function opt(v,t){ const o = document.createElement('option'); o.value=v; o.textContent=t||v; return o; }
    const fmtHMM = (mins) => {
      if (mins == null || isNaN(mins)) return '';
      const h = Math.floor(mins/60), m = Math.abs(mins%60);
      return `${h}:${String(m).padStart(2,'0')}`;
    };

    // --------- Login gate ----------
    const loginForm = document.getElementById('login-form');
    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const u = el('username').value.trim();
      const p = el('pin').value.trim();
      try{
        const res = await fetch(`${API.users}/login`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: u, pin: p })
        });
        if(res.ok){
          const data = await res.json();
          setUser({ username: data.username, role: data.role });
          document.getElementById('loginGate').style.display='none';
          document.getElementById('app').style.display='block';
          init();
          return;
        }
      }catch{}
      document.getElementById('error-message').textContent='Invalid username or PIN.';
    });

    // Auto-login if already set
    if(getUser()){
      document.getElementById('loginGate').style.display='none';
      document.getElementById('app').style.display='block';
      init();
    }

    // --------- App init ----------
    async function init(){
      const me = getUser();
      const isAdmin = String(me?.role||'').toLowerCase()==='admin';

      // Header info
      el('who').textContent = me?.username || '';
      el('role').textContent = me?.role || '';

      // Admin-only nav
      const bar = navActions();
      [...bar.querySelectorAll('.navbtn[data-dyn="1"]')].forEach(n => n.remove());
      if (isAdmin) {
        bar.appendChild(makeNav('admin.html', 'Admin'));
        bar.appendChild(makeNav('archive.html', 'Archive'));
      }

      // Views
      document.getElementById('adminView').style.display = isAdmin ? 'block' : 'none';
      document.getElementById('techView').style.display   = isAdmin ? 'none' : 'block';

      // Load technicians and parts for admin UI
      if (isAdmin){
        await Promise.all([loadTechs(), loadParts()]);
        wirePartAutoFill();
      }

      // Data
      await Promise.all([loadAssignments(), loadRequests(), loadMine(), bindActions()]);
    }

    function makeNav(href, label){
      const a = document.createElement('a');
      a.href = href;
      a.textContent = label;
      a.className = 'navbtn';
      a.dataset.dyn = '1';
      return a;
    }

    // --------- Technician loader ----------
    async function loadTechs(){
      const me = getUser();
      const meIsAdmin = String(me?.role||'').toLowerCase() === 'admin';

      let techs = [];
      try {
        const list = await apiGet(`${API.users}`);
        if (Array.isArray(list)) {
          techs = list.filter(u => TECH_ROLES.has(String(u.role||'').toLowerCase()));
        }
      } catch (_) {}

      if (!techs.length && Array.isArray(window.users)) {
        techs = window.users.filter(u => TECH_ROLES.has(String(u.role||'').toLowerCase()));
      }

      const seen = new Set();
      techs = techs
        .filter(u => String(u.role||'').toLowerCase() !== 'admin')
        .filter(u => {
          const key = String(u.username||'').trim();
          if (!key || seen.has(key)) return false;
          seen.add(key); return true;
        })
        .sort((a,b)=> String(a.username).localeCompare(String(b.username)));

      const aSel = el('a_user');
      const fSel = el('flt_user');

      aSel.innerHTML = '<option value="">-- Select technician --</option>';
      fSel.innerHTML = '';
      fSel.append(opt('', 'All'));

      for (const u of techs) {
        if (meIsAdmin && String(u.username).toLowerCase() === String(me?.username||'').toLowerCase()) continue;
        aSel.append(opt(u.username));
        fSel.append(opt(u.username));
      }

      el('a_msg').textContent = techs.length ? '' : 'No technicians found. Add techs in Admin → Users.';
    }

    // --------- Part dropdown loader (from catalog.js) ----------
    async function loadParts(){
      const select = el('a_part_select');
      select.innerHTML = '<option value="">-- Select part --</option>';

      const list = Array.isArray(window.catalog) ? window.catalog : [];
      if (!list.length) {
        select.innerHTML = '<option value="">(no catalog loaded)</option>';
        return;
      }

      const items = list
        .filter(p => p && p.partNumber)
        .map(p => ({
          pn: String(p.partNumber),
          label: `${String(p.partNumber)} — ${p.printName ? String(p.printName) : ''}`.trim(),
          printName: p.printName || '',
          hours: typeof p.expectedHours === 'number' && !Number.isNaN(p.expectedHours) ? p.expectedHours : '',
          notes: p.notes || ''
        }))
        .sort((a,b)=> a.pn.localeCompare(b.pn));

      for (const it of items) {
        const o = document.createElement('option');
        o.value = it.pn;
        o.textContent = it.label;
        o.dataset.print = it.printName;
        o.dataset.hours = it.hours;
        o.dataset.notes = it.notes || '';
        select.appendChild(o);
      }
    }

    function wirePartAutoFill(){
      const sel = el('a_part_select');
      const print = el('a_print');
      const hours = el('a_hours');
      const notes = el('a_notes');

      sel.addEventListener('change', () => {
        const opt = sel.selectedOptions && sel.selectedOptions[0];
        if (!opt || !opt.value) { return; }
        if (opt.dataset.print)  print.value = opt.dataset.print;
        if (opt.dataset.hours !== undefined && opt.dataset.hours !== '') hours.value = opt.dataset.hours;
        if (opt.dataset.notes && !notes.value) notes.value = opt.dataset.notes;
      });
    }

    // --------- Loaders ----------
    async function loadAssignments(){
      if (String(getUser()?.role||'').toLowerCase()!=='admin') return;
      const user = el('flt_user').value;
      const status = el('flt_status').value;
      const qs = new URLSearchParams(); if(user) qs.set('username', user); if(status) qs.set('status', status);
      const rows = await apiGet(`${API.assignments}${qs.toString() ? `?${qs}` : ''}`);
      const tbody = el('assignmentsBody'); tbody.innerHTML='';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(r.createdAt).toLocaleString()}</td>
          <td>${r.username||''}</td>
          <td>${r.partNumber||''}</td>
          <td>${r.printName||''}</td>
          <td>${fmtHMM(r.expectedMinutes)}</td>
          <td>${r.dueDate ? new Date(r.dueDate).toLocaleDateString() : ''}</td>
          <td>${r.status||''}</td>
          <td>${r.notes||''}</td>
          <td>
            <button data-act="status" data-id="${r.id}" data-status="InProgress" class="secondary small">Start</button>
            <button data-act="status" data-id="${r.id}" data-status="Completed" class="primary small">Complete</button>
            <button data-act="status" data-id="${r.id}" data-status="Canceled" class="secondary small">Cancel</button>
            <button data-act="delete" data-id="${r.id}" class="danger small">Delete</button>
          </td>`;
        tbody.append(tr);
      });
    }

    async function loadRequests(){
      const me = getUser();
      const isAdmin = String(me?.role||'').toLowerCase()==='admin';
      const tbody = el('requestsBody'); tbody.innerHTML='';
      if(!isAdmin) return;
      const rows = await apiGet(API.requests);
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.username||''}</td>
          <td>${r.description || r.partNumber || ''}</td>
          <td>${fmtHMM(r.minutes)}</td>
          <td>${r.notes||''}</td>
          <td>${r.updatedAt ? new Date(r.updatedAt).toLocaleString() : ''}</td>
          <td>
            <button data-req="approve" data-id="${r.id}" class="primary small">Approve</button>
            <button data-req="reject" data-id="${r.id}" class="danger small">Reject</button>
          </td>`;
        tbody.append(tr);
      });
    }

    async function loadMine(){
      const me = getUser();
      const isAdmin = String(me?.role||'').toLowerCase()==='admin';
      if(isAdmin) return;
      const myBody = el('myAssignmentsBody'); myBody.innerHTML='';
      const rows = await apiGet(`${API.assignments}/me`);
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(r.createdAt).toLocaleString()}</td>
          <td>${r.partNumber||''}</td>
          <td>${r.printName||''}</td>
          <td>${fmtHMM(r.expectedMinutes)}</td>
          <td>${r.dueDate ? new Date(r.dueDate).toLocaleDateString() : ''}</td>
          <td>${r.status||''}</td>
          <td>${r.notes||''}</td>
          <td>
            ${r.status==='Open' ? '<button class="primary small" data-act="start">Start</button>' : ''}
            ${r.status==='InProgress' ? '<button class="primary small" data-act="complete">Complete</button>' : ''}
          </td>`;
        myBody.append(tr);
      });

      const reqBody = el('myRequestsBody'); reqBody.innerHTML='';
      const reqs = await apiGet(`${API.requests}/me`);
      reqs.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.description || r.partNumber || ''}</td>
          <td>${fmtHMM(r.minutes)}</td>
          <td>${r.notes||''}</td>
          <td>${r.status||''}</td>
          <td>${r.updatedAt ? new Date(r.updatedAt).toLocaleString() : ''}</td>`;
        reqBody.append(tr);
      });
    }

    // --------- Actions ----------
    async function bindActions(){
      document.getElementById('a_create')?.addEventListener('click', async ()=>{
        const tech = document.getElementById('a_user').value.trim();
        const pnSel = document.getElementById('a_part_select').value.trim();
        if(!tech){ el('a_msg').textContent='Select a technician.'; return; }

        const hoursVal = document.getElementById('a_hours').value;
        const minutes = hoursVal ? Math.round(parseFloat(hoursVal) * 60) : null;

        const dueVal = document.getElementById('a_due').value;
        const dueEpoch = dueVal ? new Date(dueVal + 'T00:00:00').getTime() : null; // backend expects number :contentReference[oaicite:1]{index=1}

        const data = {
          username: tech,
          partNumber: pnSel || null,
          printName: document.getElementById('a_print').value.trim() || null,
          expectedMinutes: minutes, // API takes minutes :contentReference[oaicite:2]{index=2}
          dueDate: dueEpoch,
          notes: document.getElementById('a_notes').value.trim() || null,
        };
        try{
          await apiJson(API.assignments, 'POST', data);
          el('a_msg').textContent='Assigned.';
          document.getElementById('a_part_select').value='';
          document.getElementById('a_print').value='';
          document.getElementById('a_hours').value='';
          document.getElementById('a_due').value='';
          document.getElementById('a_notes').value='';
          await loadAssignments();
        }catch(e){ el('a_msg').textContent='Failed to assign.'; }
      });

      document.getElementById('applyFilters')?.addEventListener('click', loadAssignments);
      document.getElementById('resetFilters')?.addEventListener('click', ()=>{
        document.getElementById('flt_user').value='';
        document.getElementById('flt_status').value='';
        loadAssignments();
      });

      document.getElementById('assignmentsBody')?.addEventListener('click', async (e)=>{
        const t = e.target;
        if(t.dataset.act==='delete'){
          try{ await apiJson(`${API.assignments}/${t.dataset.id}`, 'DELETE'); await loadAssignments(); }catch{}
        }else if(t.dataset.act==='status'){
          try{ await apiJson(`${API.assignments}/${t.dataset.id}`, 'PATCH', { status: t.dataset.status }); await loadAssignments(); }catch{}
        }
      });

      document.getElementById('myAssignmentsBody')?.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-act]'); if (!btn) return;
        const row = btn.closest('tr'); if (!row) return;
        const id = row.dataset.id || row.getAttribute('data-id'); // in case we add later
        const map = { start:'InProgress', complete:'Completed' };
        const status = map[btn.dataset.act]; if (!status || !id) return;
        try{
          await apiJson(`${API.assignments}/${id}`, 'PATCH', { status });
          await loadMine();
        }catch{}
      });

      document.getElementById('requestsBody')?.addEventListener('click', async (e)=>{
        const t = e.target;
        if(t.dataset.req==='approve'){
          try{ await apiJson(`${API.requests}/${t.dataset.id}/approve`, 'PATCH', {}); await Promise.all([loadRequests(), loadAssignments()]); }catch{}
        }else if(t.dataset.req==='reject'){
          try{ await apiJson(`${API.requests}/${t.dataset.id}/reject`, 'PATCH', {}); await loadRequests(); }catch{}
        }
      });

      document.getElementById('r_submit')?.addEventListener('click', async ()=>{
        const data = {
          partNumber: document.getElementById('r_part').value.trim() || null,
          description: document.getElementById('r_part').value.trim() || null,
          minutes: (document.getElementById('r_hours').value ? Math.round(parseFloat(document.getElementById('r_hours').value)*60) : null),
          notes: document.getElementById('r_notes').value.trim() || null
        };
        try{
          await apiJson(API.requests, 'POST', data);
          document.getElementById('r_msg').textContent='Sent.';
          document.getElementById('r_part').value='';
          document.getElementById('r_hours').value='';
          document.getElementById('r_notes').value='';
          await loadMine();
        }catch(e){ document.getElementById('r_msg').textContent='Failed to send.'; }
      });

      document.getElementById('refresh')?.addEventListener('click', async ()=>{
        await Promise.all([loadAssignments(), loadRequests(), loadMine()]);
      });
    }
  })();
  </script>
</body>
</html>
