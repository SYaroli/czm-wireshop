<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CZM • Build Next</title>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    .brand-actions .navbtn{display:inline-block;background:#1a1c20;color:#bbb;padding:6px 12px;border-radius:10px;text-decoration:none;border:1px solid #3a3f44;font-weight:600;font-size:.9rem;margin-left:8px}
    .brand-actions .navbtn.active{background:#b30000;color:#fff;border-color:#ff4d4d}
    .grid-2{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width: 1000px){ .grid-2{grid-template-columns:1fr 1fr} }
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .toolbar > *{flex:1}
    .toolbar .tight{flex:0}
    .right{display:flex;justify-content:flex-end;gap:8px}
    .pill{padding:10px 14px;border:1px solid #d3d8e1;border-radius:10px;background:#fff;cursor:pointer;font-weight:800;min-width:64px;text-align:center}
    .pill.claim{background:#0e7a0d;color:#fff;border-color:#0e7a0d}
    .pill.cancel{background:#a00;color:#fff;border-color:#a00}
    .pill.small{min-width:0;padding:8px 10px;font-size:.95rem}
    .pill.primary{background:#b30000;color:#fff;border-color:#b30000}
    table.compact td, table.compact th{padding:8px 10px}
    td.qty{font-weight:900}
    .muted{color:#666;font-size:.95rem}
    .kicker{font-weight:900;margin:0 0 8px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .note{font-size:.9rem;color:#666}
    .grow{flex:1}
    .minw{min-width:120px}
    .nowrap{white-space:nowrap}
    .danger{color:#a00}
  </style>
</head>
<body>
  <div class="brand-bar">
    <div class="brand-inner">
      <a class="brand-logo" href="/dashboard.html">
        <img src="/czm-logo.png" alt="CZM">
        <h1 class="brand-title">CZM • Build Next</h1>
      </a>
      <div class="brand-actions">
        <a class="navbtn" href="/dashboard.html">Dashboard</a>
        <a class="navbtn active" href="/assignments.html">Build Next</a>
        <a class="navbtn" href="/inventory">Inventory</a>
        <a class="navbtn" href="/archive.html">Archive</a>
        <a class="navbtn" href="/admin.html">Admin</a>
        <button id="logoutBtn" class="navbtn">Logout</button>
      </div>
    </div>
  </div>

  <main class="page">

    <!-- ADMIN: Add to build queue -->
    <div class="card" id="addCard" style="display:none">
      <h2 class="kicker">Add to build queue</h2>
      <div class="toolbar">
        <div>
          <label for="part">Part</label>
          <input id="part" list="partsList" placeholder="Start typing a part number or print name">
          <datalist id="partsList"></datalist>
        </div>
        <div class="minw">
          <label for="qAdd">Qty</label>
          <input id="qAdd" type="number" min="1" step="1" value="1">
        </div>
        <div class="tight" style="display:flex;align-items:end">
          <button id="btnAdd" class="pill primary">Add</button>
        </div>
      </div>
      <p class="note">Admins can add items to the queue. Techs will claim them and complete in batches; inventory increases on completion.</p>
    </div>

    <div class="grid-2">
      <!-- Left: Queue (unclaimed) -->
      <div class="card">
        <h2 class="kicker">Queue</h2>
        <table class="sticky-head compact" id="tblQueued">
          <thead>
            <tr>
              <th>Part</th>
              <th>Print Name</th>
              <th class="nowrap">Qty</th>
              <th>Created</th>
              <th class="nowrap">Actions</th>
            </tr>
          </thead>
          <tbody id="queuedBody"></tbody>
        </table>
      </div>

      <!-- Right: In progress (claimed) -->
      <div class="card">
        <h2 class="kicker">In Progress</h2>
        <table class="sticky-head compact" id="tblClaimed">
          <thead>
            <tr>
              <th>Part</th>
              <th>Print Name</th>
              <th class="nowrap">Remaining</th>
              <th>Claimed By</th>
              <th class="nowrap">Complete</th>
            </tr>
          </thead>
          <tbody id="claimedBody"></tbody>
        </table>
        <p class="note">Partial completes allowed. Completing adds to inventory automatically.</p>
      </div>
    </div>

    <!-- Done today -->
    <div class="card">
      <h2 class="kicker">Done today</h2>
      <table class="sticky-head compact" id="tblDone">
        <thead>
          <tr>
            <th>Part</th>
            <th>Print Name</th>
            <th class="nowrap">Qty</th>
            <th class="nowrap">By</th>
            <th class="nowrap">Completed</th>
          </tr>
        </thead>
        <tbody id="doneBody"></tbody>
      </table>
    </div>

  </main>

  <script src="/catalog.js"></script>
  <script>
    const API_ROOT = 'https://wireshop-backend.onrender.com';

    // auth
    const user = (() => { try { return JSON.parse(localStorage.getItem('user')||'{}'); } catch { return {}; } })();
    if (!user || !user.username) { window.location.href = '/index.html'; }
    const isAdmin = String(user.role||'').toLowerCase() === 'admin';
    document.getElementById('logoutBtn')?.addEventListener('click', ()=>{ localStorage.removeItem('user'); location.href='/index.html'; });

    // show admin card if admin
    if (isAdmin) document.getElementById('addCard').style.display = '';

    // catalog helpers
    const CATALOG = Array.isArray(window.catalog) ? window.catalog : [];
    const byPN = new Map(CATALOG.map(x => [String(x.partNumber), x]));
    const options = CATALOG.map(c => {
      const pn = String(c.partNumber||'').trim();
      const name = (c.printName||'').trim();
      return `<option value="${pn}">${name ? name + ' — ' + pn : pn}</option>`;
    }).join('');
    document.getElementById('partsList').innerHTML = options;

    function esc(s){ return String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }
    function ts(ms){ if(!ms) return ''; return new Date(ms).toLocaleString(); }

    async function api(path, opts={}){
      const res = await fetch(API_ROOT + path, {
        method: opts.method || 'GET',
        headers: { 'Content-Type':'application/json', 'x-user': user.username },
        body: opts.body ? JSON.stringify(opts.body) : undefined
      });
      if (!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }

    // ---- ADD (admin) ----
    const pnInput = document.getElementById('part');
    const qAdd = document.getElementById('qAdd');
    document.getElementById('btnAdd')?.addEventListener('click', async ()=>{
      const pn = (pnInput.value||'').trim();
      const qty = Number(qAdd.value||0);
      if (!pn) return alert('Pick a part');
      if (!Number.isInteger(qty) || qty <= 0) return alert('Qty must be a positive integer');
      try{
        await api('/api/build-tasks', { method:'POST', body:{ partNumber: pn, qty } });
        pnInput.value=''; qAdd.value='1';
        await refreshAll();
      }catch(e){ alert('Add failed'); }
    });

    // ---- TABLE RENDERERS ----
    const queuedBody = document.getElementById('queuedBody');
    const claimedBody = document.getElementById('claimedBody');
    const doneBody = document.getElementById('doneBody');

    function linkPN(pn){ return `<a class="mono" href="/inv/${encodeURIComponent(pn)}" target="_blank" rel="noopener">${esc(pn)}</a>`; }

    function rowQueued(r){
      const c = byPN.get(String(r.partNumber)) || {};
      const name = c.printName || '';
      const when = ts(r.createdAt);
      const who = esc(r.createdBy||'');
      const adminBtns = isAdmin ? `<button class="pill small cancel" data-cancel="${r.id}">Cancel</button>` : '';
      return `<tr data-id="${r.id}">
        <td>${linkPN(r.partNumber)}</td>
        <td>${esc(name)}</td>
        <td class="qty">${r.qty|0}</td>
        <td><span class="muted">${when}</span><br><span class="muted">${who}</span></td>
        <td class="right">
          <button class="pill small claim" data-claim="${r.id}">Claim</button>
          ${adminBtns}
        </td>
      </tr>`;
    }

    function rowClaimed(r){
      const c = byPN.get(String(r.partNumber)) || {};
      const name = c.printName || '';
      const who = esc(r.claimedBy||'');
      return `<tr data-id="${r.id}">
        <td>${linkPN(r.partNumber)}</td>
        <td>${esc(name)}</td>
        <td class="qty">${r.qty|0}</td>
        <td>${who}</td>
        <td class="right">
          <input type="number" class="qtyDone" min="1" step="1" placeholder="qty">
          <button class="pill small primary" data-complete="${r.id}">Complete</button>
          ${isAdmin ? `<button class="pill small" data-unclaim="${r.id}">Unclaim</button>` : ''}
        </td>
      </tr>`;
    }

    function rowDone(r){
      const c = byPN.get(String(r.partNumber)) || {};
      const name = c.printName || '';
      const who = esc(r.claimedBy||'');
      const when = ts(r.completedAt);
      // qty for 'done' rows is stored in events; we’ll pull last completion qty via events API later if needed.
      // For now we compute from difference between before/after is not available; store as zero here.
      // To display a real qty, backend would need /events or to echo last completion qty. We echo it in complete response for live updates.
      return `<tr data-id="${r.id}">
        <td>${linkPN(r.partNumber)}</td>
        <td>${esc(name)}</td>
        <td class="qty">${r._lastQtyDone ? r._lastQtyDone : (r.qty===0 ? '' : r.qty)}</td>
        <td>${who}</td>
        <td><span class="muted">${when}</span></td>
      </tr>`;
    }

    // ---- LOAD & BUILD ----
    async function load(status){
      return api('/api/build-tasks?status='+encodeURIComponent(status));
    }

    async function refreshAll(){
      const [queued, claimed, done] = await Promise.all([
        load('queued'), load('claimed'), load('done')
      ]);

      queuedBody.innerHTML = queued.map(rowQueued).join('');
      claimedBody.innerHTML = claimed.map(rowClaimed).join('');
      doneBody.innerHTML = done.map(rowDone).join('');
    }

    // ---- ACTIONS ----
    document.addEventListener('click', async (e)=>{
      const claimId = e.target?.dataset?.claim;
      const cancelId = e.target?.dataset?.cancel;
      const unclaimId = e.target?.dataset?.unclaim;
      const completeId = e.target?.dataset?.complete;

      try {
        if (claimId){
          await api(`/api/build-tasks/${claimId}/claim`, { method:'PATCH' });
          await refreshAll();
          return;
        }
        if (cancelId && isAdmin){
          await api(`/api/build-tasks/${cancelId}/cancel`, { method:'PATCH' });
          await refreshAll();
          return;
        }
        if (unclaimId && isAdmin){
          await api(`/api/build-tasks/${unclaimId}/unclaim`, { method:'PATCH' });
          await refreshAll();
          return;
        }
        if (completeId){
          const tr = e.target.closest('tr');
          const qtyBox = tr?.querySelector('.qtyDone');
          const qty = Number(qtyBox?.value||0);
          if (!Number.isInteger(qty) || qty <= 0) return alert('Enter a positive quantity');
          // complete on build_tasks
          const res = await api(`/api/build-tasks/${completeId}/complete`, { method:'PATCH', body:{ qty } });
          // then add to inventory
          const pn = res?.addToInventory?.partNumber;
          const inc = Number(res?.addToInventory?.qty||0);
          if (pn && inc > 0){
            await api(`/api/inventory/${encodeURIComponent(pn)}/adjust`, { method:'POST', body:{ delta: inc, note: `build task #${completeId}` } });
          }
          await refreshAll();
          return;
        }
      } catch(err){
        alert('Action failed');
      }
    });

    // initial load + poll
    refreshAll().catch(()=>alert('Failed to load build queue'));
    setInterval(()=>{ if(!document.hidden) refreshAll().catch(()=>{}); }, 15000);
  </script>
</body>
</html>
