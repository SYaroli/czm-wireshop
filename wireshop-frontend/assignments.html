<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CZM • Build Next</title>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    .brand-actions .navbtn{display:inline-block;background:#1a1c20;color:#bbb;padding:6px 12px;border-radius:10px;text-decoration:none;border:1px solid #3a3f44;font-weight:600;font-size:.9rem;margin-left:8px}
    .brand-actions .navbtn.active{background:#b30000;color:#fff;border-color:#ff4d4d}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .toolbar > *{flex:1}
    .toolbar .tight{flex:0}
    .right{display:flex;justify-content:flex-end;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{padding:10px 14px;border:1px solid #d3d8e1;border-radius:10px;background:#fff;cursor:pointer;font-weight:800;min-width:64px;text-align:center}
    .pill.claim{background:#0e7a0d;color:#fff;border-color:#0e7a0d}
    .pill.cancel{background:#a00;color:#fff;border-color:#a00}
    .pill.small{min-width:0;padding:8px 10px;font-size:.95rem}
    .pill.primary{background:#b30000;color:#fff;border-color:#b30000}
    table.compact td, table.compact th{padding:8px 10px}
    td.qty{font-weight:900}
    .muted{color:#666;font-size:.95rem}
    .kicker{font-weight:900;margin:0 0 8px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .note{font-size:.9rem;color:#666}
    .minw{min-width:120px}
    .nowrap{white-space:nowrap}
    .card.sized{min-height:320px}
    th.wide, td.wide{min-width:320px}
    @media (max-width: 900px){ th.wide, td.wide{min-width:260px} }
    .priority{display:inline-block;border:1px solid #ccc;border-radius:8px;padding:2px 8px;font-weight:800;font-size:.85rem}
    .p1{background:#fff3cd;border-color:#ffe08a}      /* High */
    .p2{background:#ffd5d5;border-color:#ff9b9b}      /* Urgent */
  </style>
</head>
<body>
  <div class="brand-bar">
    <div class="brand-inner">
      <a class="brand-logo" href="/dashboard.html">
        <img src="/czm-logo.png" alt="CZM">
        <h1 class="brand-title">CZM • Build Next</h1>
      </a>
      <div class="brand-actions">
        <a class="navbtn" href="/dashboard.html">Dashboard</a>
        <a class="navbtn active" href="/assignments.html">Build Next</a>
        <a class="navbtn" href="/inventory">Inventory</a>
        <a class="navbtn" href="/archive.html">Archive</a>
        <a class="navbtn" href="/admin.html">Admin</a>
        <button id="logoutBtn" class="navbtn">Logout</button>
      </div>
    </div>
  </div>

  <main class="page">

    <!-- ADMIN: Add to build queue -->
    <div class="card" id="addCard" style="display:none">
      <h2 class="kicker">Add to build queue</h2>
      <div class="toolbar">
        <div>
          <label for="part">Part</label>
          <input id="part" list="partsList" placeholder="Start typing a part number or print name">
          <datalist id="partsList"></datalist>
        </div>
        <div class="minw">
          <label for="qAdd">Qty</label>
          <input id="qAdd" type="number" min="1" step="1" value="1">
        </div>
        <div class="minw">
          <label for="prioritySel">Priority</label>
          <select id="prioritySel">
            <option value="0">Normal</option>
            <option value="1">High</option>
            <option value="2">Urgent</option>
          </select>
        </div>
        <div class="tight" style="display:flex;align-items:end">
          <button id="btnAdd" class="pill primary">Add</button>
        </div>
      </div>
      <p class="note">Admins can add items to the queue. Techs will claim them and complete in batches; inventory increases on completion.</p>
    </div>

    <!-- Queue -->
    <div class="card sized">
      <h2 class="kicker">Queue</h2>
      <table class="sticky-head compact" id="tblQueued">
        <thead>
          <tr>
            <th>Part</th>
            <th>Print Name</th>
            <th class="nowrap">Qty</th>
            <th>Created</th>
            <th class="nowrap wide">Actions</th>
          </tr>
        </thead>
        <tbody id="queuedBody"></tbody>
      </table>
    </div>

    <!-- In Progress -->
    <div class="card sized">
      <h2 class="kicker">In Progress</h2>
      <table class="sticky-head compact" id="tblClaimed">
        <thead>
          <tr>
            <th>Part</th>
            <th>Print Name</th>
            <th class="nowrap">Remaining</th>
            <th>Claimed By</th>
            <th class="nowrap wide">Complete</th>
          </tr>
        </thead>
        <tbody id="claimedBody"></tbody>
      </table>
      <p class="note">Partial completes allowed. Completing adds to inventory automatically.</p>
    </div>

    <!-- Done (last 20 completions including partials) -->
    <div class="card sized">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h2 class="kicker" style="margin:0">Done</h2>
        <div id="doneActions" style="display:none">
          <button id="clearDoneBtn" class="pill cancel small" title="Clear recent completions">Clear</button>
        </div>
      </div>
      <table class="sticky-head compact" id="tblDone" style="margin-top:8px">
        <thead>
          <tr>
            <th>Part</th>
            <th>Print Name</th>
            <th class="nowrap">Qty</th>
            <th class="nowrap">By</th>
            <th class="nowrap">Completed</th>
          </tr>
        </thead>
        <tbody id="doneBody"></tbody>
      </table>
      <p class="note">Showing the 20 most recent completions.</p>
    </div>

  </main>

  <script src="/catalog.js"></script>
  <script>
    const API_ROOT = 'https://wireshop-backend.onrender.com';

    // auth
    const user = (() => { try { return JSON.parse(localStorage.getItem('user')||'{}'); } catch { return {}; } })();
    if (!user || !user.username) { window.location.href = '/index.html'; }
    document.getElementById('logoutBtn')?.addEventListener('click', ()=>{ localStorage.removeItem('user'); location.href='/index.html'; });

    // admin detection via whoami
    let isAdmin = String(user.role||'').toLowerCase() === 'admin';
    async function whoami(){
      try{
        const me = await api('/api/whoami');
        isAdmin = !!me.isAdmin;
        document.getElementById('addCard').style.display = isAdmin ? '' : 'none';
        document.getElementById('doneActions').style.display = isAdmin ? '' : 'none';
      }catch(_){}
    }

    // catalog helpers
    const CATALOG = Array.isArray(window.catalog) ? window.catalog : [];
    const byPN = new Map(CATALOG.map(x => [String(x.partNumber), x]));
    const options = CATALOG.map(c => {
      const pn = String(c.partNumber||'').trim();
      const name = (c.printName||'').trim();
      return `<option value="${pn}">${name ? name + ' — ' + pn : pn}</option>`;
    }).join('');
    document.getElementById('partsList').innerHTML = options;

    function esc(s){ return String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }
    function ts(ms){ if(!ms) return ''; return new Date(ms).toLocaleString(); }

    async function api(path, opts={}){
      const res = await fetch(API_ROOT + path, {
        method: opts.method || 'GET',
        headers: {
          'Content-Type':'application/json',
          'x-user': user.username,
          'x-role': String(user.role || '')
        },
        body: opts.body ? JSON.stringify(opts.body) : undefined
      });
      if (!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }

    // ---- ADD (admin) ----
    const pnInput = document.getElementById('part');
    const qAdd = document.getElementById('qAdd');
    const prioritySel = document.getElementById('prioritySel');
    document.getElementById('btnAdd')?.addEventListener('click', async ()=>{
      const pn = (pnInput.value||'').trim();
      const qty = Number(qAdd.value||0);
      const pri = Number(prioritySel.value||0) | 0;
      if (!pn) return alert('Pick a part');
      if (!Number.isInteger(qty) || qty <= 0) return alert('Qty must be a positive integer');
      try{
        await api('/api/build-tasks', { method:'POST', body:{ partNumber: pn, qty, priority: pri } });
        pnInput.value=''; qAdd.value='1'; prioritySel.value='0';
        await refreshAll();
      }catch(e){ alert('Add failed'); }
    });

    // ---- TABLE RENDERERS ----
    const queuedBody = document.getElementById('queuedBody');
    const claimedBody = document.getElementById('claimedBody');
    const doneBody = document.getElementById('doneBody');

    function prBadge(priority){
      if (priority >= 2) return `<span class="priority p2">Urgent</span>`;
      if (priority === 1) return `<span class="priority p1">High</span>`;
      return '';
    }
    function linkPN(pn){ return `<a class="mono" href="/inv/${encodeURIComponent(pn)}" target="_blank" rel="noopener">${esc(pn)}</a>`; }

    function rowQueued(r){
      const c = byPN.get(String(r.partNumber)) || {};
      const name = c.printName || '';
      const when = ts(r.createdAt);
      const who = esc(r.createdBy||'');
      const adminBtns = isAdmin ? `<button class="pill small cancel" data-cancel="${r.id}">Cancel</button>` : '';
      return `<tr data-id="${r.id}">
        <td>${linkPN(r.partNumber)} ${prBadge(r.priority|0)}</td>
        <td>${esc(name)}</td>
        <td class="qty">${r.qty|0}</td>
        <td><span class="muted">${when}</span><br><span class="muted">${who}</span></td>
        <td class="right wide">
          <button class="pill small claim" data-claim="${r.id}">Claim</button>
          ${adminBtns}
        </td>
      </tr>`;
    }

    function rowClaimed(r){
      const c = byPN.get(String(r.partNumber)) || {};
      const name = c.printName || '';
      const who = esc(r.claimedBy||'');
      return `<tr data-id="${r.id}">
        <td>${linkPN(r.partNumber)} ${prBadge(r.priority|0)}</td>
        <td>${esc(name)}</td>
        <td class="qty">${r.qty|0}</td>
        <td>${who}</td>
        <td class="right wide">
          <input type="number" class="qtyDone" min="1" step="1" placeholder="qty">
          <button class="pill small primary" data-complete="${r.id}">Complete</button>
          ${isAdmin ? `<button class="pill small primary" data-unclaim="${r.id}">Unclaim</button>` : ''}
        </td>
      </tr>`;
    }

    // events-based row for Done (supports partials)
    function rowDoneEvt(e){
      const c = byPN.get(String(e.partNumber)) || {};
      const name = c.printName || '';
      const who = esc(e.user || e.claimedBy || '');
      const when = ts(e.ts);
      const qty = e.qty|0;
      return `<tr>
        <td>${linkPN(e.partNumber)}</td>
        <td>${esc(name)}</td>
        <td class="qty">${qty}</td>
        <td>${who}</td>
        <td><span class="muted">${when}</span></td>
      </tr>`;
    }

    // ---- LOAD & BUILD ----
    async function loadQueued(){ return api('/api/build-tasks?status=queued'); }
    async function loadClaimed(){ return api('/api/build-tasks?status=claimed'); }
    async function loadDoneEvents(){ return api('/api/build-task-events?type=complete'); }

    async function refreshAll(){
      const [queued, claimed, evts] = await Promise.all([ loadQueued(), loadClaimed(), loadDoneEvents() ]);

      const done = (evts || [])
        .filter(e => Number.isFinite(e.ts))
        .sort((a,b) => b.ts - a.ts)
        .slice(0, 20);

      queuedBody.innerHTML = queued.map(rowQueued).join('');
      claimedBody.innerHTML = claimed.map(rowClaimed).join('');
      doneBody.innerHTML = done.map(rowDoneEvt).join('');
    }

    // ---- ACTIONS ----
    document.addEventListener('click', async (e)=>{
      const claimId = e.target?.dataset?.claim;
      const cancelId = e.target?.dataset?.cancel;
      const unclaimId = e.target?.dataset?.unclaim;
      const completeId = e.target?.dataset?.complete;

      try {
        if (claimId){
          // partial-claim prompt
          const tr = e.target.closest('tr');
          const max = Number(tr?.querySelector('.qty')?.textContent || 0);
          if (!Number.isInteger(max) || max <= 0) return;
          const input = prompt(`How many to claim (1-${max})?`, String(max));
          if (input === null) return; // cancelled
          const want = Number(input);
          if (!Number.isInteger(want) || want <= 0 || want > max) {
            alert('Invalid quantity'); return;
          }
          await api(`/api/build-tasks/${claimId}/claim`, { method:'PATCH', body:{ qty: want } });
          await refreshAll(); return;
        }
        if (cancelId && isAdmin){
          await api(`/api/build-tasks/${cancelId}/cancel`, { method:'PATCH' });
          await refreshAll(); return;
        }
        if (unclaimId && isAdmin){
          await api(`/api/build-tasks/${unclaimId}/unclaim`, { method:'PATCH' });
          await refreshAll(); return;
        }
        if (completeId){
          const tr = e.target.closest('tr');
          const qtyBox = tr?.querySelector('.qtyDone');
          const qty = Number(qtyBox?.value||0);
          if (!Number.isInteger(qty) || qty <= 0) return alert('Enter a positive quantity');
          const res = await api(`/api/build-tasks/${completeId}/complete`, { method:'PATCH', body:{ qty } });
          const pn = res?.addToInventory?.partNumber;
          const inc = Number(res?.addToInventory?.qty||0);
          if (pn && inc > 0){
            await api(`/api/inventory/${encodeURIComponent(pn)}/adjust`, { method:'POST', body:{ delta: inc, note: `build task #${completeId}` } });
          }
          await refreshAll(); return;
        }
      } catch(err){ alert('Action failed'); }
    });

    // ---- CLEAR DONE (admin) ----
    document.getElementById('clearDoneBtn')?.addEventListener('click', async ()=>{
      if (!isAdmin) return;
      try{
        await api('/api/build-task-events?type=complete', { method:'DELETE' });
        await refreshAll();
      }catch(e){ alert('Clear failed'); }
    });

    // init
    (async function init(){
      await whoami();
      await refreshAll().catch(()=>alert('Failed to load build queue'));
      setInterval(()=>{ if(!document.hidden) refreshAll().catch(()=>{}); }, 15000);
    })();
  </script>
</body>
</html>
