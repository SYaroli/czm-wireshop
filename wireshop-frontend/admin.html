<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CZM • Admin</title>
  <link rel="stylesheet" href="style.css"/>

  <style>
    /* Red/white header buttons */
    .brand-actions .navbtn{
      display:inline-block !important;
      background:var(--red) !important;
      color:#fff !important;
      padding:8px 12px !important;
      border-radius:9px !important;
      text-decoration:none !important;
      border:0 !important;
      font-weight:700 !important;
      cursor:pointer;
      margin-left:8px !important;
      line-height:1;
    }
    .brand-actions .navbtn:hover{ filter:brightness(.92) }
    .brand-actions .navbtn.active{
      outline:2px solid #fff;
      outline-offset:2px;
    }
    .brand-actions button.navbtn{ border:0 }

    /* Page spacing */
    .page { max-width: 980px; margin: 0 auto; padding: 18px 16px 48px; }

    /* Tables */
    .table-wrap{ width:100%; overflow:auto; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ padding:8px 10px; border-bottom:1px solid rgba(0,0,0,.08); font-size:14px; }
    th{ background:#111; color:#fff; font-weight:700; text-align:left; position:sticky; top:0; }
    .small{ font-size:12px; padding:6px 10px; border-radius:8px; }
    .danger{ background:var(--red); color:#fff; border:0; cursor:pointer; }
    .primary{ background:#1a1c20; color:#fff; border:0; cursor:pointer; }

    /* Inputs */
    input, select{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.15);
      background:#fff;
      font-size:14px;
      box-sizing:border-box;
    }
    label{ font-size:13px; opacity:.9; }
  </style>
</head>

<body>
  <div class="brand-bar">
    <div class="brand-inner">
      <a class="brand-logo" href="assignments.html" style="display:flex;align-items:center;gap:10px;text-decoration:none;">
        <img src="czm-logo.png" alt="CZM" style="height:26px;width:auto;">
        <div style="color:#fff;font-weight:800;">CZM • Admin</div>
      </a>

      <div class="brand-actions" id="navActions">
        <a href="assignments.html" class="navbtn">Assignments</a>
        <a href="/inventory" class="navbtn">Inventory</a>
        <a href="admin.html" class="navbtn active">Admin</a>
        <button id="logoutBtn" class="navbtn">Logout</button>
      </div>
    </div>
  </div>

  <main class="page">

    <!-- Live Technician Activity -->
    <div class="card">
      <h2 style="margin:0 0 10px 0;">Live Technician Activity</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Technician</th>
              <th>Part Number</th>
              <th>Print Name</th>
              <th>Expected</th>
              <th>Action</th>
              <th>Notes</th>
              <th>Time Active</th>
            </tr>
          </thead>
          <tbody id="liveBody">
            <tr><td colspan="7" style="opacity:.7;">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Completed Jobs (Archive) -->
    <div class="card" style="margin-top:14px;">
      <h2 style="margin:0 0 10px 0;">Completed Jobs (Archive)</h2>

      <div style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:end;margin:.25rem 0 .75rem">
        <label>Technician<br>
          <select id="fTech">
            <option value="All">All</option>
          </select>
        </label>

        <label>Part # contains<br>
          <input id="fPart" type="text" placeholder="e.g. 44602"/>
        </label>

        <label>From date<br>
          <input id="fFrom" type="date"/>
        </label>

        <label>To date<br>
          <input id="fTo" type="date"/>
        </label>

        <button id="btnApply" class="navbtn">Apply</button>
        <button id="btnReset" class="navbtn">Reset</button>
        <button id="btnExport" class="navbtn">Export CSV</button>

        <a href="#" id="archiveBackupLink" style="margin-left:auto;font-size:13px;">Archive Backup</a>
        <div id="archiveCount" style="opacity:.75;font-size:13px;">0 records</div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Finished</th>
              <th>Technician</th>
              <th>Part Number</th>
              <th>Print Name</th>
              <th>Expected (hrs)</th>
              <th>Notes</th>
              <th>Total Active</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="archiveBody">
            <tr><td colspan="8" style="opacity:.7;">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Users -->
    <div class="card" id="usersCard" style="margin-top:14px;">
      <h2 style="margin:0 0 10px 0;">Users</h2>

      <div style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:end;margin:.25rem 0 .75rem">
        <label>Username<br><input id="uName" type="text" placeholder="firstname.lastname"/></label>
        <label>PIN<br><input id="uPin" type="text" inputmode="numeric" placeholder="1234"/></label>
        <label>Role<br>
          <select id="uRole">
            <option value="tech">tech</option>
            <option value="admin">admin</option>
          </select>
        </label>
        <button id="btnAddUser" class="navbtn">Add User</button>
        <div id="uMsg" style="margin-left:auto;opacity:.8"></div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Username</th>
              <th>Role</th>
              <th>Active</th>
              <th>New PIN</th>
              <th>Save</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody id="usersBody">
            <tr><td colspan="6" style="opacity:.7;">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </main>

  <script>
    // ---------- helpers ----------
    const API_BASE = (location.hostname.includes('localhost'))
      ? 'http://localhost:3000'
      : 'https://czm-us-wireshop-backend.onrender.com';

    const user = (() => { try { return JSON.parse(localStorage.getItem('user') || '{}'); } catch { return {}; } })();

    function headers(){
      return { 'Content-Type':'application/json', 'x-user': user.username || '' };
    }

    function fmtDate(ms){
      if (!ms) return '';
      const d = new Date(ms);
      return d.toLocaleString();
    }

    function toHMS(totalSeconds){
      const s = Math.max(0, Math.floor(totalSeconds || 0));
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const r = s % 60;
      return (h>0 ? `${h}h ` : '') + `${m}m ${r}s`;
    }

    // auth gate
    if (!user || !user.username) location.href = '/index.html';

    // logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('user');
      location.href = '/index.html';
    });

    // ---------- LIVE ----------
    async function loadLive(){
      const tbody = document.getElementById('liveBody');
      try{
        const res = await fetch(`${API_BASE}/api/jobs/live`, { headers: headers() });
        if (!res.ok) throw new Error('live fetch failed');
        const rows = await res.json();

        if (!rows.length){
          tbody.innerHTML = `<tr><td colspan="7" style="opacity:.7;">No active jobs</td></tr>`;
          return;
        }

        tbody.innerHTML = '';
        rows.forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.username || ''}</td>
            <td>${r.partNumber || ''}</td>
            <td>${r.printName || ''}</td>
            <td>${(r.expectedHours != null) ? r.expectedHours : ''}</td>
            <td>${r.action || ''}</td>
            <td>${r.note || ''}</td>
            <td>${toHMS((r.totalActive || 0))}</td>
          `;
          tbody.appendChild(tr);
        });
      }catch(e){
        tbody.innerHTML = `<tr><td colspan="7" style="opacity:.7;">Live load failed</td></tr>`;
      }
    }

    // ---------- ARCHIVE ----------
    async function loadTechListInto(selectEl){
      try{
        const res = await fetch(`${API_BASE}/api/users`, { headers: headers() });
        if (!res.ok) return;
        const list = await res.json();
        const techs = list.map(u => u.username).filter(Boolean);
        techs.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t;
          opt.textContent = t;
          selectEl.appendChild(opt);
        });
      }catch{}
    }

    async function loadArchive(){
      const tbody = document.getElementById('archiveBody');
      try{
        const tech = document.getElementById('fTech').value;
        const partContains = document.getElementById('fPart').value.trim();
        const from = document.getElementById('fFrom').value;
        const to = document.getElementById('fTo').value;

        const params = new URLSearchParams();
        if (tech && tech !== 'All') params.set('tech', tech);
        if (partContains) params.set('partContains', partContains);
        if (from) params.set('from', from);
        if (to) params.set('to', to);

        const res = await fetch(`${API_BASE}/api/archive?` + params.toString(), { headers: headers() });
        if (!res.ok) throw new Error('archive fetch failed');
        const rows = await res.json();

        document.getElementById('archiveCount').textContent = `${rows.length} records`;

        if (!rows.length){
          tbody.innerHTML = `<tr><td colspan="8" style="opacity:.7;">0 records</td></tr>`;
          return;
        }

        tbody.innerHTML = '';
        rows.forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${fmtDate(r.finishedAt)}</td>
            <td>${r.username || ''}</td>
            <td>${r.partNumber || ''}</td>
            <td>${r.printName || ''}</td>
            <td>${(r.expectedHours != null) ? r.expectedHours : ''}</td>
            <td>${r.note || ''}</td>
            <td>${toHMS((r.totalActive || 0))}</td>
            <td></td>
          `;
          tbody.appendChild(tr);
        });
      }catch(e){
        tbody.innerHTML = `<tr><td colspan="8" style="opacity:.7;">Archive load failed</td></tr>`;
      }
    }

    document.getElementById('btnApply').addEventListener('click', loadArchive);
    document.getElementById('btnReset').addEventListener('click', () => {
      document.getElementById('fTech').value = 'All';
      document.getElementById('fPart').value = '';
      document.getElementById('fFrom').value = '';
      document.getElementById('fTo').value = '';
      loadArchive();
    });

    document.getElementById('btnExport').addEventListener('click', async () => {
      // Let the backend handle this if you already have it; otherwise this is a noop
      try{
        const res = await fetch(`${API_BASE}/api/archive/export`, { headers: headers() });
        if (!res.ok) return alert('Export endpoint not available');
        const blob = await res.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'archive.csv';
        a.click();
      }catch{
        alert('Export failed');
      }
    });

    document.getElementById('archiveBackupLink').addEventListener('click', (e) => {
      e.preventDefault();
      alert('If you want a real backup button, we’ll wire it to a backend endpoint next.');
    });

    // Clear Live Logs (kept)
    document.getElementById('clearAllLogs').addEventListener('click', async () => {
      if (!confirm('Clear ALL live jobs?')) return;
      try{
        const res = await fetch(`${API_BASE}/api/jobs/clear`, { method:'POST', headers: headers() });
        if (!res.ok) return alert('Clear failed');
        loadLive();
      }catch{
        alert('Clear failed');
      }
    });

    // ---------- USERS ----------
    async function loadUsers(){
      const tbody = document.getElementById('usersBody');
      try{
        const res = await fetch(`${API_BASE}/api/users`, { headers: headers() });
        if (!res.ok) throw new Error('users fetch failed');
        const list = await res.json();

        if (!list.length){
          tbody.innerHTML = `<tr><td colspan="6" style="opacity:.7;">No users</td></tr>`;
          return;
        }

        tbody.innerHTML = '';
        list.forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.username}</td>
            <td>
              <select class="uRole" data-uid="${u.id}">
                <option value="tech" ${String(u.role).toLowerCase()==='tech'?'selected':''}>tech</option>
                <option value="admin" ${String(u.role).toLowerCase()==='admin'?'selected':''}>admin</option>
              </select>
            </td>
            <td style="text-align:center">
              <input type="checkbox" class="uActive" data-uid="${u.id}" ${Number(u.active)===1?'checked':''}/>
            </td>
            <td>
              <input class="uPin" data-uid="${u.id}" inputmode="numeric" placeholder="(leave blank)"/>
            </td>
            <td>
              <button class="small primary uSave" data-uid="${u.id}">Save</button>
            </td>
            <td>
              <button class="small danger uDel" data-uid="${u.id}">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }catch(e){
        tbody.innerHTML = `<tr><td colspan="6" style="opacity:.7;">Users load failed</td></tr>`;
      }
    }

    document.getElementById('btnAddUser').addEventListener('click', async () => {
      const name = document.getElementById('uName').value.trim();
      const pin  = document.getElementById('uPin').value.trim();
      const role = document.getElementById('uRole').value;

      const msg = document.getElementById('uMsg');
      msg.textContent = '';

      if (!name || !pin){
        msg.textContent = 'username & pin required';
        return;
      }

      try{
        const res = await fetch(`${API_BASE}/api/users`, {
          method:'POST',
          headers: headers(),
          body: JSON.stringify({ username: name, pin, role })
        });

        const j = await res.json().catch(()=>({}));
        if (!res.ok){
          msg.textContent = j.error || 'Add failed';
          return;
        }

        msg.textContent = 'User added';
        document.getElementById('uName').value = '';
        document.getElementById('uPin').value = '';
        document.getElementById('uRole').value = 'tech';
        loadUsers();
      }catch{
        msg.textContent = 'Add failed';
      }
    });

    document.getElementById('usersBody').addEventListener('click', async (e) => {
      const id = e.target?.dataset?.uid;
      if (!id) return;

      // delete
      if (e.target.classList.contains('uDel')){
        if (!confirm('Delete this user?')) return;
        const res = await fetch(`${API_BASE}/api/users/${id}`, { method:'DELETE', headers: headers() });
        if (res.ok) loadUsers();
        return;
      }

      // save (role/active/pin)
      if (e.target.classList.contains('uSave')){
        const roleEl = document.querySelector(`.uRole[data-uid="${id}"]`);
        const actEl  = document.querySelector(`.uActive[data-uid="${id}"]`);
        const pinEl  = document.querySelector(`.uPin[data-uid="${id}"]`);

        const payload = {
          role: roleEl?.value,
          active: actEl?.checked ? 1 : 0
        };
        if (pinEl && pinEl.value.trim()) payload.pin = pinEl.value.trim();

        const res = await fetch(`${API_BASE}/api/users/${id}`, {
          method:'PATCH',
          headers: headers(),
          body: JSON.stringify(payload)
        });

        const j = await res.json().catch(()=>({}));
        if (!res.ok){
          alert(j.error || 'Save failed');
          return;
        }

        if (pinEl) pinEl.value = '';
        loadUsers();
      }
    });

    // boot
    (async function init(){
      await loadLive();
      await loadUsers();
      await loadTechListInto(document.getElementById('fTech'));
      await loadArchive();
      setInterval(loadLive, 5000);
    })();
  </script>
</body>
</html>
