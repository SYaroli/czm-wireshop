<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CZM • Admin</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { margin:0; font-family:system-ui,sans-serif; background:#f5f5f5; }
    .brand-bar { padding:8px 12px; background:#0f1114; border-bottom:3px solid #c30000; }
    .brand-inner { max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; }
    .brand-actions .navbtn { padding:6px 12px; background:#1a1c20; color:#bbb; border-radius:10px; border:1px solid #3a3f44; font-weight:600; font-size:.9rem; text-decoration:none; }
    .brand-actions .navbtn.active { background:#b30000; color:#fff; border-color:#ff4d4d; }
    .brand-actions .navbtn:hover { background:#24272b; color:#fff; }
    main { max-width:1100px; margin:0 auto; padding:8px; }
    .card { background:#fff; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.08); padding:10px; margin:10px 0; }

    #lowStockCard { max-width:75%; margin:10px auto; }
    .alert-item { font-size:12px; padding:5px 0; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
    .alert-item:last-child { border-bottom:none; }
    .add-queue-btn { padding:4px 8px; font-size:10px; background:#b30000; color:#fff; border:none; border-radius:4px; cursor:pointer; }

    #usersCard { max-width:75%; margin:10px auto; }
    .table-wrap { overflow:auto; }
    table { width:100%; border-collapse:collapse; font-size:12px; }
    th, td { padding:5px 6px; text-align:left; vertical-align:middle; white-space:nowrap; border-right:1px solid #eee; }
    th:last-child, td:last-child { border-right:none; }
    th { background:#111; color:#fff; font-weight:600; }
    tr:nth-child(even) { background:#fafafa; }

    th.username-col, td.username-col { width:110px; padding-left:5px; }
    th.role-col, td.role-col { width:80px; padding:5px 4px; }
    th.active-col, td.active-col { width:60px; text-align:center; padding:5px 3px; }
    th.newpin-col, td.newpin-col { width:50px; text-align:center; padding:5px 3px; }
    th.action-col, td.action-col { width:50px; text-align:center; padding:5px 3px; }

    .btn-mini { margin:0; padding:4px 8px; font-size:10px; border-radius:4px; }
    input, select { height:26px; font-size:12px; padding:0 6px; border-radius:4px; }
    .muted { font-size:10px; color:#666; }
    .msg { margin-top:4px; font-size:11px; }
    .add-row { gap:6px; margin-bottom:6px; flex-wrap:wrap; }
    .add-row label { flex:1 1 130px; min-width:130px; }

    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal { background:#122032; color:#fff; padding:16px; width:420px; border-radius:8px; box-shadow:0 8px 20px rgba(0,0,0,.4); }
    .modal h3 { margin:0 0 10px; font-size:18px; }
    .modal label { display:block; font-size:12px; margin-top:8px; margin-bottom:4px; }
    .modal input, .modal textarea { width:100%; border:none; border-radius:6px; height:34px; padding:6px 8px; outline:none; font-size:14px; color:#000; }
    .modal textarea { height:90px; resize:vertical; }
    .modal-actions { margin-top:14px; display:flex; gap:10px; justify-content:flex-end; }
    .btn-small { border:none; border-radius:6px; padding:6px 14px; cursor:pointer; }
    .btn-red { background:#c30000; color:#fff; }
    .btn-gray { background:#c5c5c5; color:#000; }
  </style>
</head>
<body>

  <div class="brand-bar">
    <div class="brand-inner">
      <a class="brand-logo" href="/dashboard.html">
        <img src="/czm-logo.png" alt="CZM">
        <h1 class="brand-title">CZM • Admin</h1>
      </a>

      <div class="brand-actions">
        <a class="navbtn" href="dashboard.html">Dashboard</a>
        <a class="navbtn active" href="admin.html">Admin</a>
        <a class="navbtn" href="index.html">Logout</a>
      </div>
    </div>
  </div>

  <main>
    <div class="card" id="lowStockCard" style="display:none;">
      <h2>Low Stock Alerts</h2>
      <div id="lowStockList"></div>
    </div>

    <div class="card" id="usersCard">
      <h2>Users</h2>
      <div class="add-row" style="display:flex; margin-bottom:12px;">
        <label>
          Username
          <input id="uName" type="text" placeholder="firstname.lastname" />
        </label>
        <label>
          PIN
          <input id="uPin" type="text" inputmode="numeric" maxlength="10" placeholder="1234" />
        </label>
        <label>
          Role
          <select id="uRole">
            <option value="tech">tech</option>
            <option value="admin">admin</option>
          </select>
        </label>
        <button id="btnAddUser" class="btn-red">Add User</button>
      </div>
      <div id="uMsg" class="msg"></div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="username-col">Username</th>
              <th class="role-col">Role</th>
              <th class="active-col">Active</th>
              <th class="newpin-col">New PIN</th>
              <th class="action-col">Save</th>
              <th class="action-col">Delete</th>
            </tr>
          </thead>
          <tbody id="usersTableBody"></tbody>
        </table>
      </div>
    </div>
  </main>

  <div class="modal-backdrop" id="addModalBackdrop">
    <div class="modal">
      <h3>Add Assignment to Queue</h3>
      <label>Part Number</label>
      <input id="mPartNumber" type="text" readonly />
      <label>Description</label>
      <input id="mDescription" type="text" readonly />
      <label>Expected Minutes</label>
      <input id="mMinutes" type="number" min="1" placeholder="e.g. 30" />
      <label>Notes</label>
      <textarea id="mNotes" placeholder="Optional notes..."></textarea>
      <div class="modal-actions">
        <button class="btn-gray" onclick="document.getElementById('addModalBackdrop').style.display='none'">Cancel</button>
        <button class="btn-red" id="submitAssignment">Add to Queue</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://wireshop-backend.onrender.com/api';

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]);
    }

    function getSession() {
      try {
        return JSON.parse(localStorage.getItem('user') || '{}');
      } catch {
        return {};
      }
    }

    function authHeaders() {
      const user = getSession();
      return {
        'x-user': user.username || ''
      };
    }

    function setMsg(id, text, cls = '') {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = text;
        el.className = 'msg ' + cls;
      }
    }

    function requireAdmin() {
      const user = getSession();
      return String(user.role || '').toLowerCase() === 'admin';
    }

    async function apiGetUsers() {
      const res = await fetch(API_BASE + '/users', { headers: authHeaders() });
      if (!res.ok) throw new Error('Failed to fetch users');
      return await res.json();
    }

    async function apiAddUser(payload) {
      const res = await fetch(API_BASE + '/users', {
        method: 'POST',
        headers: { ...authHeaders(), 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('Failed to add user');
    }

    async function apiUpdateUserById(id, payload) {
      const res = await fetch(API_BASE + '/users/' + id, {
        method: 'PATCH',
        headers: { ...authHeaders(), 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('Failed to update user');
    }

    async function apiDeleteUser(username) {
      const res = await fetch(API_BASE + '/users/' + encodeURIComponent(username), {
        method: 'DELETE',
        headers: authHeaders()
      });
      if (!res.ok) throw new Error('Failed to delete user');
    }

    function normalizeRole(role) {
      return String(role).toLowerCase() === 'admin' ? 'admin' : 'tech';
    }

    function renderUsers(users) {
      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = users.map(u => `
        <tr data-id="${escapeHtml(u.id || '')}" data-username="${escapeHtml(u.username)}">
          <td class="username-col">${escapeHtml(u.username)}</td>
          <td class="role-col">
            <select class="roleSel">
              <option value="tech" ${normalizeRole(u.role) === 'tech' ? 'selected' : ''}>tech</option>
              <option value="admin" ${normalizeRole(u.role) === 'admin' ? 'selected' : ''}>admin</option>
            </select>
          </td>
          <td class="active-col">
            <input type="checkbox" class="activeChk" ${u.active ? 'checked' : ''} />
          </td>
          <td class="newpin-col">
            <input type="text" class="pinInp" placeholder="--" />
          </td>
          <td class="action-col"><button class="save btn-mini" style="background:#b30000; color:#fff;">Save</button></td>
          <td class="action-col"><button class="del btn-mini" style="background:#b30000; color:#fff;">Delete</button></td>
        </tr>
      `).join('');
    }

    async function loadLowStock(){
      const card = document.getElementById('lowStockCard');
      const list = document.getElementById('lowStockList');
      if (!card || !list) return;

      list.innerHTML = 'Loading...';
      card.style.display = 'block';

      try {
        const res = await fetch(API_BASE + '/inventory-all', { headers: authHeaders() });
        if (!res.ok) throw new Error(`Inventory fetch failed: ${res.status}`);
        const items = await res.json();

        const low = items.filter(i => 
          typeof i.qty === 'number' && 
          typeof i.minQty === 'number' && 
          i.minQty > 0 && 
          i.qty <= i.minQty
        );

        if (low.length === 0) {
          list.innerHTML = '<div class="muted">No low stock items.</div>';
          return;
        }

        const isAdmin = requireAdmin();

        list.innerHTML = low.map(i => {
          const part = JSON.stringify(i.partNumber || '');
          const desc = JSON.stringify(i.description || '');
          const onclickAttr = `openAddModal(${part}, ${desc})`.replace(/"/g, '&quot;');

          return `
            <div class="alert-item">
              <div>
                <strong>${escapeHtml(i.partNumber)}</strong> — 
                ${escapeHtml(i.description || 'No desc')} (${escapeHtml(i.location || '—')})<br>
                Current: <span class="low-qty">${i.qty}</span> (min: ${i.minQty})
              </div>
              ${isAdmin ? `<button class="add-queue-btn" onclick="${onclickAttr}">Add to Queue</button>` : ''}
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error('Low stock error:', err);
        list.innerHTML = `<div class="msg err">Failed: ${err.message}</div>`;
      }
    }

    function openAddModal(partNumber, description) {
      document.getElementById('mPartNumber').value = partNumber;
      document.getElementById('mDescription').value = description;
      document.getElementById('mMinutes').value = '';
      document.getElementById('mNotes').value = '';
      document.getElementById('addModalBackdrop').style.display = 'flex';
    }

    document.getElementById('submitAssignment').addEventListener('click', async () => {
      const minutes = Number(document.getElementById('mMinutes').value) || 0;
      const notes = document.getElementById('mNotes').value.trim();
      const partNumber = document.getElementById('mPartNumber').value;
      const description = document.getElementById('mDescription').value;

      if (minutes < 1) return setMsg('uMsg', 'Expected minutes required', 'err');

      try {
        const payload = { partNumber, printName: description, expectedMinutes: minutes, notes };
        const res = await fetch(API_BASE + '/assignments', {
          method: 'POST',
          headers: { ...authHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('Failed to add to queue');
        document.getElementById('addModalBackdrop').style.display = 'none';
        loadLowStock(); // Refresh low stock
      } catch (err) {
        console.error(err);
        setMsg('uMsg', err.message, 'err');
      }
    });

    async function loadUsers(){
      const tbody = document.getElementById('usersTableBody');
      if (!tbody) return;

      try{
        setMsg('uMsg', 'Loading users...', 'muted');
        const users = await apiGetUsers();
        renderUsers(users);
        setMsg('uMsg', '', '');
      }catch(err){
        console.error('Load users error:', err);
        tbody.innerHTML = '<tr><td colspan="6" style="opacity:.7; text-align:center; color:red;">Failed to load users: ' + err.message + '</td></tr>';
        setMsg('uMsg', 'Error: ' + err.message, 'err');
      }
    }

    async function addUser(){
      const name = (document.getElementById('uName').value || '').trim();
      const pin = (document.getElementById('uPin').value || '').trim();
      const role = normalizeRole(document.getElementById('uRole').value);

      if(!name){
        setMsg('uMsg', 'Username required', 'err');
        return;
      }
      if(!pin){
        setMsg('uMsg', 'PIN required', 'err');
        return;
      }

      try{
        setMsg('uMsg', 'Adding user…', 'muted');
        await apiAddUser({ username: name, pin, role });
        document.getElementById('uName').value = '';
        document.getElementById('uPin').value = '';
        document.getElementById('uRole').value = 'tech';
        setMsg('uMsg', 'User added.', 'ok');
        await loadUsers();
      }catch(err){
        console.error(err);
        setMsg('uMsg', String(err.message || err), 'err');
      }
    }

    function wireTableClicks(){
      const tbody = document.getElementById('usersTableBody');

      tbody.addEventListener('click', async (e) => {
        const tr = e.target.closest('tr[data-id]');
        if(!tr) return;

        const id = tr.getAttribute('data-id');
        const username = tr.getAttribute('data-username');

        if(e.target.classList.contains('save')){
          const roleSel = tr.querySelector('.roleSel');
          const activeChk = tr.querySelector('.activeChk');
          const pinInp = tr.querySelector('.pinInp');

          const payload = {
            role: normalizeRole(roleSel && roleSel.value),
            active: !!(activeChk && activeChk.checked)
          };

          const newPin = (pinInp && pinInp.value || '').trim();
          if(newPin) payload.pin = newPin;

          try{
            setMsg('uMsg', 'Saving…', 'muted');
            await apiUpdateUserById(id, payload);
            if(pinInp) pinInp.value = '';
            setMsg('uMsg', 'Saved.', 'ok');
            await loadUsers();
          }catch(err){
            console.error(err);
            setMsg('uMsg', String(err.message || err), 'err');
          }
          return;
        }

        if(e.target.classList.contains('del')){
          const ok = window.confirm('Delete user "' + username + '"?');
          if(!ok) return;
          try{
            setMsg('uMsg', 'Deleting…', 'muted');
            await apiDeleteUser(username);
            setMsg('uMsg', 'Deleted.', 'ok');
            await loadUsers();
          }catch(err){
            console.error(err);
            setMsg('uMsg', String(err.message || err), 'err');
          }
        }
      });
    }

    if (requireAdmin()) {
      document.getElementById('btnAddUser')?.addEventListener('click', addUser);
      wireTableClicks();
      loadUsers();
      loadLowStock();
    } else {
      location.href = 'dashboard.html'; // Redirect non-admins
    }
  </script>
</body>
</html>
