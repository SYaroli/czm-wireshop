<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CZM • Admin</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { margin:0; font-family:system-ui,sans-serif; background:#f5f5f5; }
    .brand-bar { padding:8px 12px; background:#0f1114; border-bottom:3px solid #c30000; }
    .brand-inner { max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; }
    .brand-actions .navbtn { padding:6px 10px; font-size:11px; border-radius:6px; }
    main { max-width:1100px; margin:0 auto; padding:8px; }
    .card { background:#fff; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.08); padding:10px; margin:10px 0; }

    #lowStockCard { max-width:75%; margin:10px auto; }
    .alert-item { font-size:12px; padding:5px 0; border-bottom:1px solid #eee; }
    .alert-item:last-child { border-bottom:none; }

    /* === NEW: Queue button & reminder === */
    .alert-item .queue-btn {
      background:#b30000; color:#fff; border:none; border-radius:4px; padding:3px 7px;
      font-size:10px; font-weight:600; cursor:pointer; margin-left:4px;
    }
    .alert-item .queue-btn:hover { background:#d20000; }
    .alert-item .queue-btn:disabled { background:#666; cursor:not-allowed; }
    .alert-item .queue-reminder {
      font-size:10px; color:#666; font-weight:600; margin-left:4px;
    }

    #usersCard { max-width:75%; margin:10px auto; }
    .table-wrap { overflow:auto; }
    table { width:100%; border-collapse:collapse; font-size:12px; }
    th, td { padding:5px 6px; text-align:left; vertical-align:middle; white-space:nowrap; border-right:1px solid #eee; }
    th:last-child, td:last-child { border-right:none; }
    th { background:#111; color:#fff; font-weight:600; }
    tr:nth-child(even) { background:#fafafa; }

    th.username-col, td.username-col { width:110px; padding-left:5px; }
    th.role-col,   td.role-col   { width:80px;  padding:5px 4px; }
    th.active-col, td.active-col { width:60px;  text-align:center; padding:5px 3px; }
    th.newpin-col, td.newpin-col { width:50px;  text-align:center; padding:5px 3px; }
    th.action-col, td.action-col { width:50px;  text-align:center; padding:5px 3px; }

    .btn-mini { margin:0; padding:4px 8px; font-size:10px; border-radius:4px; }
    input, select { height:26px; font-size:12px; padding:0 6px; border-radius:4px; }
    .muted { font-size:10px; color:#666; }
    .msg { margin-top:4px; font-size:11px; }
    .add-row { gap:6px; margin-bottom:6px; flex-wrap:wrap; }
    .add-row label { flex:1 1 130px; min-width:130px; }

    /* navbtn style */
    .brand-bar{background:#0f1114;border-bottom:4px solid #c30000}
    .brand-actions .navbtn{display:inline-block;background:#1a1c20;color:#bbb;padding:6px 12px;border-radius:10px;text-decoration:none;border:1px solid #3a3f44;font-weight:600;font-size:.9rem;margin-left:8px}
    .brand-actions .navbtn.active{background:#b30000;color:#fff;border-color:#ff4d4d}
    .brand-actions .navbtn:hover{background:#24272b;color:#fff}
  </style>
</head>
<body>
  <!-- (HTML unchanged) -->
  <div class="brand-bar">
    <div class="brand-inner">
      <a class="brand-logo" href="/dashboard.html">
        <img src="/czm-logo.png" alt="CZM">
        <h1 class="brand-title">CZM • Admin</h1>
      </a>

      <div class="brand-actions">
        <a class="navbtn" href="/assignments.html">Build Next</a>
        <a class="navbtn" href="/inventory">Inventory</a>
        <a class="navbtn active" href="/admin.html">Admin</a>
        <button id="logoutBtn" class="navbtn">Logout</button>
      </div>
    </div>
  </div>

  <main>
    <div class="card" id="lowStockCard" style="display:none;">
      <h2>Low Stock Alerts</h2>
      <div id="lowStockList"></div>
      <div id="lowMsg" class="msg muted"></div>
    </div>

    <div class="card" id="usersCard">
      <!-- users card unchanged -->
      <h2>Users</h2>
      <!-- ... rest of users card ... -->
    </div>
  </main>

  <script>
    const API_BASE = (localStorage.getItem("API_BASE") || "https://wireshop-backend.onrender.com").replace(/\/+$/, "");
    const API_USERS = API_BASE + '/api/users';
    const API_INVENTORY = API_BASE + '/api/inventory-all';

    // ... (all your existing functions unchanged: getSession, requireAdmin, setMsg, authHeaders, normalizeRole, logout, api*User functions, escapeHtml, escapeAttr, renderUsers, loadUsers, addUser, wireTableClicks) ...

    async function loadLowStock(){
      const card = document.getElementById('lowStockCard');
      const list = document.getElementById('lowStockList');
      if (!card || !list) return;

      list.innerHTML = 'Loading...';
      card.style.display = 'block';

      try {
        const [invRes, queueRes] = await Promise.all([
          fetch(API_INVENTORY, { headers: authHeaders() }),
          fetch(API_BASE + '/api/build-tasks?status=queued', { headers: authHeaders() })
        ]);

        if (!invRes.ok) throw new Error(`Inventory failed: ${invRes.status}`);
        const items = await invRes.json();

        let queued = [];
        if (queueRes.ok) queued = await queueRes.json();

        const low = items.filter(i => 
          typeof i.qty === 'number' && 
          typeof i.minQty === 'number' && 
          i.minQty > 0 && 
          i.qty <= i.minQty
        );

        if (low.length === 0) {
          list.innerHTML = '<div class="muted">No low stock items.</div>';
          return;
        }

        list.innerHTML = low.map(i => {
          // Sum qty if multiple queue entries exist for this part
          const queuedQty = queued
            .filter(q => q.partNumber === i.partNumber)
            .reduce((sum, q) => sum + Number(q.qty || 0), 0);

          let queueHtml = '';
          if (queuedQty > 0) {
            queueHtml = `<span class="queue-reminder">In Queue (${queuedQty})</span>`;
          } else {
            queueHtml = `<button class="queue-btn" data-pn="${escapeAttr(i.partNumber)}">Add to Queue</button>`;
          }

          return `
            <div class="alert-item">
              <a class="part-link" href="/inv/${encodeURIComponent(i.partNumber)}" target="_blank">
                <strong>${escapeHtml(i.partNumber)}</strong>
              </a> — 
              ${escapeHtml(i.description || 'No desc')} (${escapeHtml(i.location || '—')})<br>
              Current: <span class="low-qty">${i.qty}</span> (min: ${i.minQty})<br>
              ${queueHtml}
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error('Low stock error:', err);
        list.innerHTML = `<div class="msg err">Failed: ${err.message}</div>`;
      }
    }

    // === NEW: Queue button handler ===
    const lowStockList = document.getElementById('lowStockList');
    lowStockList.addEventListener('click', async (e) => {
      if (e.target.classList.contains('queue-btn')) {
        const pn = e.target.dataset.pn;
        const qtyStr = prompt(`Qty to add to build queue for ${pn}?`, '1');
        if (qtyStr === null) return;

        const qty = Number(qtyStr);
        if (!Number.isInteger(qty) || qty <= 0) {
          alert('Please enter a positive integer');
          return;
        }

        try {
          await fetch(API_BASE + '/api/build-tasks', {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({
              partNumber: pn,
              qty: qty,
              priority: 0
            })
          });
          loadLowStock(); // refresh alerts
        } catch (err) {
          alert('Failed to queue: ' + err.message);
        }
      }
    });

    // ... rest of your script unchanged ...

    if (requireAdmin()) {
      document.getElementById('btnAddUser')?.addEventListener('click', addUser);
      wireTableClicks();
      loadUsers();
      loadLowStock();
    }
  </script>
</body>
</html>
