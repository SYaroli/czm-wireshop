<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CZM • Admin</title>
  <link rel="stylesheet" href="style.css"/>

  <style>
    /* Red/white header buttons */
    .brand-actions .navbtn{
      display:inline-block !important;
      background:var(--red) !important;
      color:#fff !important;
      padding:8px 12px !important;
      border-radius:9px !important;
      text-decoration:none !important;
      border:0 !important;
      font-weight:700 !important;
      cursor:pointer;
      margin-left:8px !important;
      line-height:1;
    }
    .brand-actions .navbtn:hover{ filter:brightness(.92) }
    .brand-actions .navbtn.active{
      outline:2px solid #fff;
      outline-offset:2px;
    }
    .brand-actions button.navbtn{ border:0 }

    /* Page spacing */
    .page { max-width: 980px; margin: 0 auto; padding: 18px 16px 48px; }

    /* Tables */
    .table-wrap{ width:100%; overflow:auto; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ padding:8px 10px; border-bottom:1px solid rgba(0,0,0,.08); font-size:14px; }
    th{ background:#111; color:#fff; font-weight:700; text-align:left; position:sticky; top:0; }
    .small{ font-size:12px; padding:6px 10px; border-radius:8px; }
    .danger{ background:var(--red); color:#fff; border:0; cursor:pointer; }
    .primary{ background:#1a1c20; color:#fff; border:0; cursor:pointer; }

    /* Inputs */
    input, select{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.15);
      background:#fff;
      font-size:14px;
      box-sizing:border-box;
    }
    label{ font-size:13px; opacity:.9; }
  </style>
</head>

<body>
  <div class="brand-bar">
    <div class="brand-inner">
      <a class="brand-logo" href="assignments.html" style="display:flex;align-items:center;gap:10px;text-decoration:none;">
        <img src="czm-logo.png" alt="CZM" style="height:26px;width:auto;">
        <div style="color:#fff;font-weight:800;">CZM • Admin</div>
      </a>

      <div class="brand-actions" id="navActions">
        <a href="assignments.html" class="navbtn">Assignments</a>
        <a href="/inventory" class="navbtn">Inventory</a>
        <a href="admin.html" class="navbtn active">Admin</a>
        <button id="logoutBtn" class="navbtn">Logout</button>
      </div>
    </div>
  </div>

  <main class="page">

    <!-- Users -->
    <div class="card" id="usersCard">
      <h2 style="margin:0 0 10px 0;">Users</h2>

      <div style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:end;margin:.25rem 0 .75rem">
        <label>Username<br><input id="uName" type="text" placeholder="firstname.lastname"/></label>
        <label>PIN<br><input id="uPin" type="text" inputmode="numeric" placeholder="1234"/></label>
        <label>Role<br>
          <select id="uRole">
            <option value="tech">tech</option>
            <option value="admin">admin</option>
          </select>
        </label>
        <button id="btnAddUser" class="navbtn">Add User</button>
        <div id="uMsg" style="margin-left:auto;opacity:.8"></div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Username</th>
              <th>Role</th>
              <th>Active</th>
              <th>New PIN</th>
              <th>Save</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody id="usersBody">
            <tr><td colspan="6" style="opacity:.7;">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </main>

  <script>
    // ---------- helpers ----------
    const API_BASE = (location.hostname.includes('localhost'))
      ? 'http://localhost:3000'
      : 'https://czm-us-wireshop-backend.onrender.com';

    const user = (() => {
      try { return JSON.parse(localStorage.getItem('user') || '{}'); }
      catch { return {}; }
    })();

    function headers(){
      return { 'Content-Type':'application/json', 'x-user': user.username || '' };
    }

    // auth gate
    if (!user || !user.username) location.href = '/index.html';

    // logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('user');
      location.href = '/index.html';
    });

    // ---------- USERS ----------
    async function loadUsers(){
      const tbody = document.getElementById('usersBody');
      try{
        const res = await fetch(`${API_BASE}/api/users`, { headers: headers() });
        if (!res.ok) throw new Error('users fetch failed');
        const list = await res.json();

        if (!list.length){
          tbody.innerHTML = `<tr><td colspan="6" style="opacity:.7;">No users</td></tr>`;
          return;
        }

        tbody.innerHTML = '';
        list.forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.username}</td>
            <td>
              <select class="uRole" data-uid="${u.id}">
                <option value="tech" ${String(u.role).toLowerCase()==='tech'?'selected':''}>tech</option>
                <option value="admin" ${String(u.role).toLowerCase()==='admin'?'selected':''}>admin</option>
              </select>
            </td>
            <td style="text-align:center">
              <input type="checkbox" class="uActive" data-uid="${u.id}" ${Number(u.active)===1?'checked':''}/>
            </td>
            <td>
              <input class="uPin" data-uid="${u.id}" inputmode="numeric" placeholder="(leave blank)"/>
            </td>
            <td>
              <button class="small primary uSave" data-uid="${u.id}">Save</button>
            </td>
            <td>
              <button class="small danger uDel" data-uid="${u.id}">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }catch(e){
        tbody.innerHTML = `<tr><td colspan="6" style="opacity:.7;">Users load failed</td></tr>`;
      }
    }

    document.getElementById('btnAddUser').addEventListener('click', async () => {
      const name = document.getElementById('uName').value.trim();
      const pin  = document.getElementById('uPin').value.trim();
      const role = document.getElementById('uRole').value;

      const msg = document.getElementById('uMsg');
      msg.textContent = '';

      if (!name || !pin){
        msg.textContent = 'username & pin required';
        return;
      }

      try{
        const res = await fetch(`${API_BASE}/api/users`, {
          method:'POST',
          headers: headers(),
          body: JSON.stringify({ username: name, pin, role })
        });

        const j = await res.json().catch(()=>({}));
        if (!res.ok){
          msg.textContent = j.error || 'Add failed';
          return;
        }

        msg.textContent = 'User added';
        document.getElementById('uName').value = '';
        document.getElementById('uPin').value = '';
        document.getElementById('uRole').value = 'tech';
        loadUsers();
      }catch{
        msg.textContent = 'Add failed';
      }
    });

    document.getElementById('usersBody').addEventListener('click', async (e) => {
      const id = e.target?.dataset?.uid;
      if (!id) return;

      // delete
      if (e.target.classList.contains('uDel')){
        if (!confirm('Delete this user?')) return;
        const res = await fetch(`${API_BASE}/api/users/${id}`, { method:'DELETE', headers: headers() });
        if (res.ok) loadUsers();
        return;
      }

      // save (role/active/pin)
      if (e.target.classList.contains('uSave')){
        const roleEl = document.querySelector(`.uRole[data-uid="${id}"]`);
        const actEl  = document.querySelector(`.uActive[data-uid="${id}"]`);
        const pinEl  = document.querySelector(`.uPin[data-uid="${id}"]`);

        const payload = {
          role: roleEl?.value,
          active: actEl?.checked ? 1 : 0
        };
        if (pinEl && pinEl.value.trim()) payload.pin = pinEl.value.trim();

        const res = await fetch(`${API_BASE}/api/users/${id}`, {
          method:'PATCH',
          headers: headers(),
          body: JSON.stringify(payload)
        });

        const j = await res.json().catch(()=>({}));
        if (!res.ok){
          alert(j.error || 'Save failed');
          return;
        }

        if (pinEl) pinEl.value = '';
        loadUsers();
      }
    });

    // boot
    (async function init(){
      await loadUsers();
    })();
  </script>
</body>
</html>
