<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CZM • Admin Live + Archive</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    /* Top brand/nav keeps your existing look */
    .brand-actions .navbtn{
      display:inline-block !important;
      background:var(--red) !important;
      color:#fff !important;
      padding:8px 12px !important;
      border-radius:9px !important;
      text-decoration:none !important;
      border:1px solid #7f0b0b !important;
      font-weight:700 !important;
      margin-left:8px !important;
    }
    .brand-actions .navbtn:hover{ filter:brightness(.92) }
    .navbtn.active{ filter:brightness(.85) }

    .toolbar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:end;margin:.25rem 0 .75rem}
    .muted{opacity:.8}
    .muted-sm{opacity:.85;font-size:.9rem}
    .table-wrap{overflow:auto}
    .inline-input{width:100%;box-sizing:border-box}
    .small{font-size:.85rem;padding:6px 10px}
    .danger{background:#b30000;color:#fff;border:1px solid #8a0000;border-radius:9px;padding:8px 12px;cursor:pointer}
    .danger-outline{background:#fff;color:#b30000;border:1px solid #b30000;border-radius:9px;padding:8px 12px;cursor:pointer}
    .primary{background:#0b5cff;color:#fff;border:1px solid #0846c4;border-radius:9px;padding:8px 12px;cursor:pointer}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal{
      background:#fff;border-radius:12px;width:min(900px,94vw);
      box-shadow:0 10px 30px rgba(0,0,0,.25);padding:16px 16px 12px
    }
    .modal header{display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem}
    .modal header h3{margin:0}
    .modal .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .modal footer{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:#eee;border:1px solid #ddd;font-weight:700}

    /* Tables */
    table.table{width:100%;border-collapse:separate;border-spacing:0 8px}
    table.table thead th{background:#0f1115;color:#fff;padding:10px;border-top-left-radius:8px;border-top-right-radius:8px}
    table.table tbody td{background:#fff;padding:10px;border:1px solid #e3e7ef;border-left-width:1px}
    table.table tbody tr td:first-child{border-top-left-radius:8px;border-bottom-left-radius:8px}
    table.table tbody tr td:last-child{border-top-right-radius:8px;border-bottom-right-radius:8px}

    /* Status dots */
    .dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px}
    .dot.green{background:#22c55e}.dot.gray{background:#94a3b8}
  </style>
</head>
<body>
  <div class="brand-bar">
    <div class="brand-inner">
      <a class="brand-logo" href="dashboard.html">
        <img src="czm-logo.png" alt="CZM">
        <h1 class="brand-title">CZM • Admin</h1>
      </a>
      <div class="brand-actions">
        <a class="navbtn" href="dashboard.html">Dashboard</a>
        <a class="navbtn" href="assignments.html">Assignments</a>
        <a class="navbtn" href="/inventory">Inventory</a>
        <a class="navbtn" href="archive.html">Archive</a>
        <a class="navbtn active" href="admin.html">Admin</a>
        <button id="logoutBtn" class="navbtn">Logout</button>
      </div>
    </div>
  </div>

  <main class="page">
    <!-- LIVE -->
    <div class="card">
      <h2>Live — Now</h2>
      <div class="toolbar">
        <span class="muted-sm"><span class="dot green"></span>auto refresh</span>
        <button id="btnForceRefresh" class="small">Refresh</button>
        <button id="btnClearLive" class="danger-outline small">Force finish selected</button>
        <span id="liveStatus" class="muted-sm"></span>
      </div>
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Tech</th>
              <th>Part</th>
              <th>Action</th>
              <th>Start</th>
              <th>Note</th>
              <th>Total Active</th>
              <th>Controls</th>
            </tr>
          </thead>
          <tbody id="liveTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- ARCHIVE -->
    <div class="card" style="margin-top:16px">
      <h2>Archive — Completed Jobs</h2>
      <div class="toolbar">
        <label>Tech<br><input id="fltTech" class="inline-input" placeholder="username"></label>
        <label>Part #<br><input id="fltPart" class="inline-input" placeholder="40602.2083.000"></label>
        <label>From<br><input id="fltFrom" type="date" class="inline-input"></label>
        <label>To<br><input id="fltTo" type="date" class="inline-input"></label>
        <div style="display:flex;gap:8px;align-items:end">
          <button id="btnApply" class="small">Apply</button>
          <button id="btnReset" class="small">Reset</button>
          <button id="btnExport" class="small">Export CSV</button>
        </div>
      </div>

      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Finished</th>
              <th>Technician</th>
              <th>Part Number</th>
              <th>Print Name</th>
              <th>Expected (hrs)</th>
              <th>Notes</th>
              <th>Total Active</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="archiveTableBody"></tbody>
        </table>
      </div>
      <div class="muted-sm" id="archStatus" style="margin-top:.5rem"></div>
    </div>

    <!-- Users -->
    <div class="card" id="usersCard" style="margin-top:16px">
      <h2>Users</h2>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:end;margin:.25rem 0 .75rem">
        <label>Username<br><input id="uName" type="text" placeholder="firstname.lastname"/></label>
        <label>PIN<br><input id="uPin" type="text" inputmode="numeric" placeholder="1234"/></label>
        <label>Role<br>
          <select id="uRole">
            <option value="assembler">assembler</option>
            <option value="tech">tech</option>
            <option value="lead">lead</option>
            <option value="admin">admin</option>
          </select>
        </label>
        <button id="btnAddUser" class="primary small">Add</button>
      </div>
      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>Username</th><th>Role</th><th>Actions</th></tr></thead>
          <tbody id="usersBody"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Edit modal -->
  <div class="modal-backdrop" id="editBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
      <header>
        <h3 id="editTitle">Edit Completed Job <span class="muted tag" id="editId"></span></h3>
        <button id="closeEdit" class="danger-outline small">Close</button>
      </header>

      <div class="grid" style="margin-bottom:10px">
        <label>Technician
          <input id="e_user" type="text" class="inline-input"/>
        </label>
        <label>Part Number
          <input id="e_part" type="text" class="inline-input"/>
        </label>
        <label>Print Name
          <input id="e_print" type="text" class="inline-input"/>
        </label>

        <label>Expected Hours
          <input id="e_exp" type="number" step="0.01" class="inline-input"/>
        </label>
        <label>Total Active (hh:mm)
          <input id="e_total_hhmm" type="text" placeholder="e.g. 1:30" class="inline-input"/>
        </label>
        <label>Notes
          <input id="e_note" type="text" class="inline-input"/>
        </label>

        <label>Started (local)
          <input id="e_start" type="datetime-local" class="inline-input"/>
        </label>
        <label>Finished (local)
          <input id="e_end" type="datetime-local" class="inline-input"/>
        </label>
        <div></div>
      </div>

      <footer>
        <button id="deleteRow" class="danger-outline">Delete</button>
        <button id="saveEdit" class="primary">Save Changes</button>
      </footer>
    </div>
  </div>

  <!-- Admin gate -->
  <script>
  (function(){
    function getRole(){
      try {
        var u = JSON.parse(localStorage.getItem('user')||'{}');
        return (u.role||'').toLowerCase();
      } catch(e){ return ''; }
    }
    function enforce(){
      var r = getRole();
      if (!r) { setTimeout(enforce, 150); return; }
      if (r !== 'admin') location.replace('dashboard.html');
    }
    enforce();
  })();
  </script>

  <!-- App logic -->
  <script>
  (function(){
    const API_ROOT = 'https://wireshop-backend.onrender.com';
    const API = {
      live:    `${API_ROOT}/api/jobs/live`,
      force:   `${API_ROOT}/api/jobs/log`,
      users:   `${API_ROOT}/api/users`,
      archive: `${API_ROOT}/api/jobs/archive`
    };

    const getUser = () => { try { return JSON.parse(localStorage.getItem('user')) || null; } catch { return null; } };
    const username = () => (getUser()?.username || '');
    const isAdmin = () => String(getUser()?.role||'').toLowerCase() === 'admin';
    const headers = () => ({ 'Content-Type': 'application/json', 'x-user': username() });

    document.getElementById('logoutBtn')?.addEventListener('click', ()=>{ localStorage.removeItem('user'); location.href='index.html'; });

    // ---------- utils ----------
    function fmtMS(ms){
      if (!Number.isFinite(ms) || ms < 0) ms = 0;
      const s = Math.floor(ms/1000);
      const h = Math.floor(s/3600);
      const m = Math.floor((s%3600)/60);
      const sec = s%60;
      return `${h}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    }
    function fmtHMM(mins){
      if (mins==null || isNaN(mins)) return '';
      const h = Math.floor(mins/60), m = Math.abs(mins%60);
      return `${h}:${String(m).padStart(2,'0')}`;
    }
    const toLocalInput = (ts)=>{
      if (!ts) return '';
      const d = new Date(ts);
      const off = d.getTimezoneOffset();
      return new Date(d.getTime() - off*60000).toISOString().slice(0,16); // yyyy-MM-ddTHH:mm
    };
    const fromLocalInput = (val)=>{
      if (!val) return null;
      const t = new Date(val);
      if (Number.isNaN(t.getTime())) return null;
      return t.getTime();
    };
    function hhmmToMinutes(hhmm){
      if (!hhmm) return null;
      const m = String(hhmm).trim().match(/^(\d+)(?::(\d{1,2}))?$/);
      if (!m) return null;
      const h = parseInt(m[1],10);
      const mm = parseInt(m[2] ?? '0', 10);
      if (!Number.isFinite(h) || !Number.isFinite(mm)) return null;
      return h*60 + Math.max(0, Math.min(59, mm));
    }

    // ---------- LIVE ----------
    async function fetchLive(){
      try{
        const r = await fetch(API.live, { headers: headers() });
        if (!r.ok) throw new Error();
        return await r.json();
      }catch{ return []; }
    }
    function renderLive(list){
      const tb = document.getElementById('liveTbody');
      tb.innerHTML = '';
      list.forEach(r=>{
        const tr = document.createElement('tr');
        const totalActive = Math.max(0, (Date.now() - (r.startTime||Date.now())) - (r.pauseTotal||0));
        tr.innerHTML = `
          <td>${r.username||''}</td>
          <td>${r.partNumber||''}</td>
          <td>${r.action||''}</td>
          <td>${r.startTime ? new Date(r.startTime).toLocaleString() : ''}</td>
          <td>${(r.note||'').replace(/\n/g,' ')}</td>
          <td>${fmtMS(totalActive)}</td>
          <td><button class="small danger-outline" data-finish="${r.id}">Force finish</button></td>`;
        tb.appendChild(tr);
      });
      document.getElementById('liveStatus').textContent = `${list.length} active`;
    }
    async function loadLive(){ renderLive(await fetchLive()); }
    let liveTimer = setInterval(()=>{ if(!document.hidden) loadLive(); }, 10000);
    document.getElementById('btnForceRefresh').addEventListener('click', loadLive);
    document.getElementById('liveTbody').addEventListener('click', async (e)=>{
      const id = e.target?.dataset?.finish;
      if (!id) return;
      if (!confirm('Force finish this log now?')) return;
      try{
        const r = await fetch(`${API_ROOT}/api/jobs/log/${id}/force-finish`, { method:'POST', headers: headers(), body: JSON.stringify({ note:'admin force finish' }) });
        if (r.ok) loadLive();
      }catch{}
    });

    // ---------- ARCHIVE ----------
    let archiveCache = [];
    function normalizeRow(r){
      return {
        id: r.id ?? r.i ?? r._id ?? r.rowid,
        username: r.username || r.technician || '',
        partNumber: r.partNumber || r.part_number || '',
        printName: r.printName || r.print_name || '',
        expectedMinutes: r.expectedMinutes ?? r.expected_minutes ?? (Number.isFinite(r.expectedHours) ? Math.round(r.expectedHours*60) : null),
        note: r.note ?? r.notes ?? '',
        startTime: r.startTime ?? r.startedAt ?? r.started_at ?? null,
        endTime: r.endTime ?? r.finishedAt ?? r.finished_at ?? null,
        pauseTotal: r.pauseTotal ?? r.pause_total ?? 0,
        totalActiveMs: (r.totalActive ?? r.total_active_ms ?? (Number.isFinite(r.total_active_sec) ? r.total_active_sec*1000 : null)) ?? null,
        finishedAt: r.finishedAt ?? r.finished_at ?? r.endTime ?? null
      };
    }
    async function fetchArchive(){
      try{
        const res = await fetch(API.archive, { headers: headers() });
        if (!res.ok) return [];
        const list = await res.json();
        archiveCache = Array.isArray(list) ? list.map(normalizeRow) : [];
        return archiveCache;
      }catch{ return []; }
    }
    function applyArchiveFilters(){
      const tech = document.getElementById('fltTech').value.trim().toLowerCase();
      const part = document.getElementById('fltPart').value.trim().toLowerCase();
      const from = document.getElementById('fltFrom').value;
      const to   = document.getElementById('fltTo').value;
      const fromMs = from ? new Date(from+'T00:00').getTime() : null;
      const toMs   = to   ? new Date(to+'T23:59').getTime()   : null;

      return archiveCache.filter(r=>{
        if (tech && !String(r.username||'').toLowerCase().includes(tech)) return false;
        if (part && !String(r.partNumber||'').toLowerCase().includes(part)) return false;
        const finished = r.finishedAt ?? r.endTime ?? r.startTime ?? 0;
        if (fromMs && finished < fromMs) return false;
        if (toMs && finished > toMs) return false;
        return true;
      });
    }
    function renderArchive(){
      const list = applyArchiveFilters();
      const tb = document.getElementById('archiveTableBody');
      tb.innerHTML = '';
      list.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.finishedAt ? new Date(r.finishedAt).toLocaleString() : ''}</td>
          <td>${r.username||''}</td>
          <td>${r.partNumber||''}</td>
          <td>${r.printName||''}</td>
          <td>${r.expectedMinutes!=null ? (r.expectedMinutes/60).toFixed(2) : ''}</td>
          <td>${(r.note||'').replace(/\n/g,' ')}</td>
          <td>${r.totalActiveMs!=null ? fmtMS(r.totalActiveMs) : ''}</td>
          <td>
            <button class="small" data-edit="${r.id}">Edit</button>
            <button class="danger-outline small" data-del="${r.id}">Delete</button>
          </td>`;
        tb.appendChild(tr);
      });
      document.getElementById('archStatus').textContent = `${list.length} rows`;
    }
    async function loadArchive(){ await fetchArchive(); renderArchive(); }
    document.getElementById('btnApply').addEventListener('click', renderArchive);
    document.getElementById('btnReset').addEventListener('click', ()=>{
      document.getElementById('fltTech').value='';
      document.getElementById('fltPart').value='';
      document.getElementById('fltFrom').value='';
      document.getElementById('fltTo').value='';
      renderArchive();
    });
    document.getElementById('btnExport').addEventListener('click', ()=>{
      const list = applyArchiveFilters();
      const header = ['Finished','Technician','Part Number','Print Name','Expected (hrs)','Notes','Total Active'];
      const body = list.map(r=>{
        const h = r.expectedMinutes!=null ? (r.expectedMinutes/60).toFixed(2) : '';
        const total = r.totalActiveMs!=null ? fmtMS(r.totalActiveMs) : '';
        return [
          r.finishedAt ? new Date(r.finishedAt).toLocaleString() : '',
          r.username||'',
          r.partNumber||'',
          r.printName||'',
          h,
          (r.note||'').replace(/\n/g,' '),
          total
        ].map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',');
      });
      const csv = [header.join(','), ...body].join('\n');
      const blob = new Blob([csv], { type:'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `archive_export_${Date.now()}.csv`;
      a.click();
    });

    // ---------- Modal wiring ----------
    const $back  = document.getElementById('editBackdrop');
    const $id    = document.getElementById('editId');
    const $user  = document.getElementById('e_user');
    const $part  = document.getElementById('e_part');
    const $print = document.getElementById('e_print');
    const $expH  = document.getElementById('e_exp');
    const $note  = document.getElementById('e_note');
    const $hhmm  = document.getElementById('e_total_hhmm');
    const $start = document.getElementById('e_start');
    const $end   = document.getElementById('e_end');

    let EDIT = null;
    function openEditById(id){
      const row = archiveCache.find(r=>String(r.id)===String(id));
      if (!row) return;
      EDIT = row;
      $id.textContent = `ID: ${row.id}`;
      $user.value  = row.username || '';
      $part.value  = row.partNumber || '';
      $print.value = row.printName || '';
      $expH.value  = Number.isFinite(row.expectedMinutes) ? (row.expectedMinutes/60) : '';
      $note.value  = row.note || '';
      $hhmm.value  = row.totalActiveMs!=null ? fmtHMM(Math.round(row.totalActiveMs/60000)) : '';
      $start.value = toLocalInput(row.startTime);
      $end.value   = toLocalInput(row.endTime || row.finishedAt);
      $back.style.display = 'flex';
    }
    function closeEdit(){ $back.style.display='none'; EDIT=null; }

    async function saveEdit(){
      if (!EDIT) return;
      const id = EDIT.id;

      const body = {
        username: ($user.value.trim() || null),
        partNumber: ($part.value.trim() || null),
        printName: ($print.value.trim() || null),
        note: ($note.value.trim() || null)
      };

      const hours = $expH.value ? Number($expH.value) : null;
      if (hours!=null && !Number.isNaN(hours)) body.expectedMinutes = Math.round(hours*60);

      const startInput = fromLocalInput($start.value);
      const endInput   = fromLocalInput($end.value);
      const baseStart  = Number.isFinite(startInput) ? startInput : (EDIT.startTime || null);
      const baseEnd    = Number.isFinite(endInput)   ? endInput   : (EDIT.endTime   || EDIT.finishedAt || null);
      const basePause  = Number.isFinite(EDIT.pauseTotal) ? EDIT.pauseTotal : 0;

      const mins = hhmmToMinutes($hhmm.value.trim());
      if (mins != null) {
        if (!Number.isFinite(baseStart)) { alert('Need a valid start time to set Total Active.'); return; }
        const targetMs = Math.max(0, mins * 60 * 1000);
        body.startTime = baseStart;
        body.endTime   = baseStart + basePause + targetMs;
      } else {
        if (Number.isFinite(startInput)) body.startTime = startInput;
        if (Number.isFinite(endInput))   body.endTime   = endInput;
      }

      body.reason = 'admin edit (set total active)';

      let ok = false;
      try{
        const r2 = await fetch(`${API.archive}/${id}/adjust`, {
          method:'POST',
          headers: headers(),
          body: JSON.stringify(body)
        });
        ok = r2.ok;
      }catch{}

      if (ok){
        closeEdit();
        await loadArchive();
      }else{
        alert('Update failed.');
      }
    }

    async function deleteEdit(){
      if (!EDIT) return;
      if (!confirm('Delete this archive record?')) return;
      let ok = false;
      try{
        const r = await fetch(`${API.archive}/${EDIT.id}`, { method:'DELETE', headers: headers() });
        ok = r.ok;
      }catch{}
      if (ok){
        closeEdit();
        await loadArchive();
      }else{
        alert('Delete failed.');
      }
    }

    document.getElementById('archiveTableBody').addEventListener('click', (e)=>{
      const idEdit = e.target?.dataset?.edit;
      const idDel  = e.target?.dataset?.del;
      if (idEdit) openEditById(idEdit);
      if (idDel){ EDIT = { id: idDel }; deleteEdit(); }
    });
    document.getElementById('closeEdit').addEventListener('click', closeEdit);
    document.getElementById('saveEdit').addEventListener('click', saveEdit);
    document.getElementById('deleteRow').addEventListener('click', deleteEdit);

    // ---------- USERS ----------
    async function loadUsers(){
      try{
        const res = await fetch(`${API.users}`, { headers: headers() });
        if (!res.ok) return;
        const list = await res.json();
        const tbody = document.getElementById('usersBody');
        tbody.innerHTML = '';
        list.forEach(u=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.username}</td>
            <td>${u.role}</td>
            <td><button class="danger small" data-uid="${u.id}">Delete</button></td>`;
          tbody.appendChild(tr);
        });
      }catch{}
    }
    document.getElementById('btnAddUser').addEventListener('click', async ()=>{
      const name = document.getElementById('uName').value.trim();
      const pin  = document.getElementById('uPin').value.trim();
      const role = document.getElementById('uRole').value;
      if (!name || !pin) return alert('username + pin required');
      try{
        const res = await fetch(`${API.users}`, { method:'POST', headers: headers(), body: JSON.stringify({ username:name, pin, role }) });
        if (res.ok){ document.getElementById('uName').value=''; document.getElementById('uPin').value=''; await loadUsers(); }
      }catch{}
    });
    document.getElementById('usersBody').addEventListener('click', async (e)=>{
      const id = e.target?.dataset?.uid;
      if (!id) return;
      if (!confirm('Delete this user?')) return;
      try{
        const res = await fetch(`${API.users}/${id}`, { method:'DELETE', headers: headers() });
        if (res.ok) loadUsers();
      }catch{}
    });

    // ---------- boot ----------
    async function boot(){
      if (!isAdmin()) return;
      await Promise.all([loadUsers(), loadArchive(), loadLive()]);
    }
    boot();
  })();
  </script>

  <script src="catalog.js"></script>
</body>
</html>
